@page "/companies"
@using Roovia.Interfaces
@using Roovia.Models.Users
@using Roovia.Models.Helper
@using Roovia.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "AdminAccess")]
@rendermode InteractiveServer
@inject IUser UserService
@inject NavigationManager NavigationManager
@inject ToastService ToastService

<div class="companies-page">
    <div class="admin-header-section">
        <div class="admin-header-content">
            <div class="header-text-content">
                <div class="header-icon">
                    <i class="fa-light fa-buildings"></i>
                </div>
                <div class="header-title-group">
                    <h1 class="header-title">Company Management</h1>
                    <p class="header-subtitle">Manage companies and their branches</p>
                </div>
            </div>

            <div class="header-action-panel">
                <RVButton Type="button" ButtonType="primary" IconLeft="fa-light fa-plus" Text="Create Company"
                          OnClick="CreateCompany" CssClass="create-company-btn" />
            </div>
        </div>
    </div>

    <div class="admin-main-container">
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <h3 class="loading-text">Loading companies...</h3>
            </div>
        }
        else
        {
            <CardView CssClass="management-card">
                <HeaderActions>
                    <div class="company-filters">
                        <div class="search-input-wrapper">
                            <i class="fa-light fa-search search-icon"></i>
                            <input type="text" class="custom-search-input" placeholder="Search companies..."
                                   @bind="searchValue" @bind:event="oninput" @onkeyup="HandleKeyPress" />
                            @if (!string.IsNullOrEmpty(searchValue))
                            {
                                <button class="clear-search-btn" @onclick="ClearSearch">
                                    <i class="fa-light fa-times"></i>
                                </button>
                            }
                        </div>

                        <div class="filter-selectors">
                            <RVDropdown TriggerText="@($"Status: {(statusFilter == "all" ? "All" : statusFilter == "active" ? "Active" : "Inactive")}")"
                                        ButtonType="outline" Position="bottom-start" CssClass="filter-dropdown">
                                <button type="button" class="roovia-dropdown-item @(statusFilter == "all" ? "active" : "")"
                                        @onclick='() => FilterByStatus("all")'>
                                    <i class="fa-light fa-filter"></i>
                                    <span>All Statuses</span>
                                    @if (statusFilter == "all")
                                    {
                                        <i class="fa-light fa-check"></i>
                                    }
                                </button>
                                <button type="button" class="roovia-dropdown-item @(statusFilter == "active" ? "active" : "")"
                                        @onclick='() => FilterByStatus("active")'>
                                    <i class="fa-light fa-check-circle"></i>
                                    <span>Active</span>
                                    @if (statusFilter == "active")
                                    {
                                        <i class="fa-light fa-check"></i>
                                    }
                                </button>
                                <button type="button" class="roovia-dropdown-item @(statusFilter == "inactive" ? "active" : "")"
                                        @onclick='() => FilterByStatus("inactive")'>
                                    <i class="fa-light fa-times-circle"></i>
                                    <span>Inactive</span>
                                    @if (statusFilter == "inactive")
                                    {
                                        <i class="fa-light fa-check"></i>
                                    }
                                </button>
                            </RVDropdown>

                            <RVButton Type="button" ButtonType="secondary" IconLeft="fa-light fa-filter-slash" Text="Clear Filters"
                                      OnClick="ClearFilters" Disabled="@(!HasActiveFilters)" CssClass="clear-filters-btn" />

                            <RVButton Type="button" ButtonType="outline" IconLeft="fa-light fa-sync" Text="Refresh"
                                      OnClick="LoadCompanies" />
                        </div>
                    </div>
                </HeaderActions>
                <ChildContent>
                    <div class="companies-grid">
                        @if (filteredCompanies.Any())
                        {
                            @foreach (var company in filteredCompanies)
                            {
                                <div class="company-card" @onclick="() => ViewCompany(company.Id)">
                                    <div class="company-card-header">
                                        <div class="company-icon">
                                            <i class="fa-light fa-building"></i>
                                        </div>
                                        <div class="company-info">
                                            <h3 class="company-name">@company.Name</h3>
                                            <div class="company-meta">
                                                <span class="reg-number">@company.RegistrationNumber</span>
                                                <span class="status-badge @(company.IsActive ? "status-online" : "status-offline")">
                                                    @(company.IsActive ? "Active" : "Inactive")
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="company-card-content">
                                        <div class="company-details">
                                            @if (!string.IsNullOrEmpty(company.Website))
                                            {
                                                <div class="detail-item">
                                                    <i class="fa-light fa-globe"></i>
                                                    <a href="@company.Website" target="_blank" @onclick:stopPropagation="true">@company.Website</a>
                                                </div>
                                            }

                                            @{
                                                var primaryEmail = company.EmailAddresses?.FirstOrDefault(e => e.IsPrimary);
                                                var primaryPhone = company.ContactNumbers?.FirstOrDefault(c => c.IsPrimary);
                                            }

                                            @if (primaryEmail != null)
                                            {
                                                <div class="detail-item">
                                                    <i class="fa-light fa-envelope"></i>
                                                    <a href="mailto:@primaryEmail.EmailAddress" @onclick:stopPropagation="true">@primaryEmail.EmailAddress</a>
                                                </div>
                                            }

                                            @if (primaryPhone != null)
                                            {
                                                <div class="detail-item">
                                                    <i class="fa-light fa-phone"></i>
                                                    <a href="tel:@primaryPhone.Number" @onclick:stopPropagation="true">@primaryPhone.Number</a>
                                                </div>
                                            }
                                        </div>

                                        <div class="company-stats">
                                            <div class="stat-item">
                                                <span class="stat-value">@(company.Branches?.Count ?? 0)</span>
                                                <span class="stat-label">Branches</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-value">@(company.Users?.Count ?? 0)</span>
                                                <span class="stat-label">Users</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="company-card-actions">
                                        <RVButton Type="button" ButtonType="outline" Size="sm" IconLeft="fa-light fa-eye" Text="View"
                                                  OnClick="(e) => { ViewCompany(company.Id); }" />
                                        <RVButton Type="button" ButtonType="outline" Size="sm" IconLeft="fa-light fa-edit" Text="Edit"
                                                  OnClick="(e) => { EditCompany(company.Id); }" />
                                        <RVButton Type="button" ButtonType="outline" Size="sm" IconLeft="fa-light fa-code-branch" Text="Branches"
                                                  OnClick="(e) => { NavigateToBranches(company.Id); }" />
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <EmptyState Title="No companies found"
                                        Description="No companies match your current filters or no companies have been created yet."
                                        Icon="fa-light fa-building-magnifying-glass"
                                        ActionText="Create Company"
                                        OnAction="CreateCompany" />
                        }
                    </div>
                </ChildContent>
            </CardView>
        }
    </div>
</div>

@if (showCompanyDialog)
{
    <CompanyDialog CompanyModel="selectedCompany"
                   IsEdit="!isNewCompany"
                   CanEdit="true"
                   OnSave="SaveCompany"
                   OnCancel="CloseCompanyDialog" />
}

<style>
    .companies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .company-card {
        background-color: var(--content-bg);
        border-radius: var(--border-radius-lg);
        border: 1px solid var(--border-divider);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
        transition: var(--card-transition);
        cursor: pointer;
    }

        .company-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-3px);
        }

    .company-card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.25rem;
        border-bottom: 1px solid var(--border-divider);
    }

    .company-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background-color: var(--primary-light);
        color: var(--primary);
        font-size: 1.5rem;
    }

    .company-info {
        flex: 1;
    }

    .company-name {
        margin: 0 0 0.25rem 0;
        font-size: 1.125rem;
        font-weight: 600;
    }

    .company-meta {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .company-card-content {
        padding: 1.25rem;
    }

    .company-details {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

        .detail-item i {
            color: var(--text-muted);
            width: 16px;
            text-align: center;
        }

        .detail-item a {
            color: var(--primary);
            text-decoration: none;
        }

            .detail-item a:hover {
                text-decoration: underline;
            }

    .company-stats {
        display: flex;
        gap: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-divider);
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary);
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .company-card-actions {
        display: flex;
        gap: 0.5rem;
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--border-divider);
        background-color: var(--subtle-bg);
    }

    .company-filters {
        display: flex;
        align-items: center;
        gap: 1rem;
        width: 100%;
    }

    .search-input-wrapper {
        position: relative;
        flex: 1;
    }

    .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
    }

    .custom-search-input {
        width: 100%;
        padding: 0.625rem 2.5rem 0.625rem 2.25rem;
        border: 1px solid var(--border-divider);
        border-radius: var(--border-radius-md);
        font-size: 0.875rem;
        background-color: var(--input-bg);
        color: var(--text-primary);
    }

        .custom-search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2);
        }

    .clear-search-btn {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .clear-search-btn:hover {
            color: var(--text-primary);
        }

    .filter-selectors {
        display: flex;
        gap: 0.75rem;
    }

    .filter-dropdown {
        min-width: 150px;
    }
</style>

@code {
    private List<Company> companies = new List<Company>();
    private bool isLoading = true;
    private string searchValue = string.Empty;
    private string statusFilter = "all";

    // Company dialog
    private bool showCompanyDialog = false;
    private Company selectedCompany = new Company();
    private bool isNewCompany = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCompanies();
    }

    private async Task LoadCompanies()
    {
        isLoading = true;

        try
        {
            var response = await UserService.GetAllCompanies();
            if (response.ResponseInfo.Success)
            {
                companies = (List<Company>)response.Response;
            }
            else
            {
                ToastService.ShowError(response.ResponseInfo.Message, "Error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading companies: {ex.Message}", "Error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private IEnumerable<Company> filteredCompanies => companies
        .Where(c => string.IsNullOrEmpty(searchValue) ||
                    c.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) == true ||
                    c.RegistrationNumber?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) == true)
        .Where(c => statusFilter == "all" ||
                    (statusFilter == "active" && c.IsActive) ||
                    (statusFilter == "inactive" && !c.IsActive))
        .OrderBy(c => c.Name);

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Task.CompletedTask; // Just to make the method async as required
        }
    }

    private void ClearSearch()
    {
        searchValue = string.Empty;
    }

    private void FilterByStatus(string status)
    {
        statusFilter = status;
    }

    private void ClearFilters()
    {
        searchValue = string.Empty;
        statusFilter = "all";
    }

    private bool HasActiveFilters => !string.IsNullOrEmpty(searchValue) || statusFilter != "all";

    private void CreateCompany()
    {
        selectedCompany = new Company
            {
                IsActive = true,
                Address = new Address { Country = "South Africa" },
                EmailAddresses = new List<Email>(),
                ContactNumbers = new List<ContactNumber>(),
                CreatedOn = DateTime.Now
            };
        isNewCompany = true;
        showCompanyDialog = true;
    }

    private async Task ViewCompany(int companyId)
    {
        try
        {
            var response = await UserService.GetCompanyById(companyId);
            if (response.ResponseInfo.Success)
            {
                selectedCompany = (Company)response.Response;
                isNewCompany = false;
                showCompanyDialog = true;
            }
            else
            {
                ToastService.ShowError(response.ResponseInfo.Message, "Error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading company: {ex.Message}", "Error");
        }
    }

    private async Task EditCompany(int companyId)
    {
        await ViewCompany(companyId);
    }

    private void NavigateToBranches(int companyId)
    {
        NavigationManager.NavigateTo($"/branches/{companyId}");
    }

    private async Task<bool> SaveCompany(Company company)
    {
        try
        {
            ResponseModel response;

            if (company.Id == 0)
            {
                // Create new company
                response = await UserService.CreateCompany(company);
            }
            else
            {
                // Update existing company
                response = await UserService.UpdateCompany(company.Id, company);
            }

            if (response.ResponseInfo.Success)
            {
                ToastService.ShowSuccess(
                    company.Id == 0 ?
                        $"Company '{company.Name}' created successfully" :
                        $"Company '{company.Name}' updated successfully",
                    "Success");

                // Reload companies
                await LoadCompanies();
                showCompanyDialog = false;
            }
            else
            {
                ToastService.ShowError(response.ResponseInfo.Message, "Error");
            }

            return true;
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving company: {ex.Message}", "Error");
            return false;
        }
    }

    private void CloseCompanyDialog()
    {
        showCompanyDialog = false;
    }
}