@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using Roovia.Data
@using Roovia.Interfaces
@using Roovia.Models.BusinessHelperModels
@using Roovia.Models.UserCompanyMappingModels
@using Roovia.Models.UserCompanyModels
@using Roovia.Services
@using Roovia.Services.General
@using Syncfusion.Blazor.Inputs
@inject IUser UserService
@inject ICdnService CdnService
@inject ToastService ToastService
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory

<link rel="stylesheet" href="@Assets["css/CompanyDialog.css"]" />
<div class="cd-modal-backdrop" @onclick="OnCancel"></div>

<div class="cd-modal-wrapper">
    <div class="cd-modal-header">
        <div class="cd-modal-title">
            <i class="@GetDialogIcon()"></i>
            <span>@GetDialogTitle()</span>
        </div>
        <button class="cd-close-button" @onclick="OnCancel">
            <i class="fa-light fa-times"></i>
        </button>
    </div>

    <div class="cd-modal-body">
        @if (isLoading)
        {
            <div class="cd-loading">
                <div class="cd-spinner"></div>
                <span class="cd-loading-text">Loading company details...</span>
            </div>
        }
        else
        {
            <div class="cd-company-dialog">
                @if (IsViewMode)
                {
                    <div class="cd-view-container">
                        <div class="cd-company-header">
                            <div class="cd-avatar-container">
                                @if (CompanyModel.MainLogoId.HasValue && CompanyModel.MainLogo != null)
                                {
                                    <div class="cd-avatar cd-has-image">
                                        <img src="@CompanyModel.MainLogo.Url" alt="@CompanyModel.Name" />
                                    </div>
                                }
                                else
                                {
                                    <div class="cd-avatar">
                                        <i class="fa-light fa-building"></i>
                                    </div>
                                }
                                <div class="cd-status-indicator @(CompanyModel.IsActive ? "cd-active" : "cd-inactive")"></div>
                            </div>

                            <div class="cd-company-info">
                                <h2 class="cd-company-name">@CompanyModel.Name</h2>

                                <div class="cd-badges-container">
                                    <span class="cd-status-badge @(CompanyModel.IsActive ? "cd-active" : "cd-inactive")">
                                        <i class="fa-light fa-@(CompanyModel.IsActive ? "check-circle" : "times-circle")"></i>
                                        @(CompanyModel.IsActive ? "Active" : "Inactive")
                                    </span>
                                    @if (CompanyModel.Status != null)
                                    {
                                        <span class="cd-status-badge">@CompanyModel.Status.Name</span>
                                    }
                                    @if (CompanyModel.SubscriptionPlan != null)
                                    {
                                        <span class="cd-badge cd-subscription">
                                            <i class="fa-light fa-gem"></i>
                                            @CompanyModel.SubscriptionPlan.Name
                                        </span>
                                    }
                                </div>

                                <div class="cd-meta-list">
                                    @if (!string.IsNullOrEmpty(CompanyModel.RegistrationNumber))
                                    {
                                        <span class="cd-meta-item"><i class="fa-light fa-id-card"></i>Reg: @CompanyModel.RegistrationNumber</span>
                                    }
                                    @if (!string.IsNullOrEmpty(CompanyModel.VatNumber))
                                    {
                                        <span class="cd-meta-item"><i class="fa-light fa-receipt"></i>VAT: @CompanyModel.VatNumber</span>
                                    }
                                </div>
                            </div>

                            <div class="cd-company-actions">
                                @if (CanEdit)
                                {
                                    <button type="button" class="cd-button cd-button-primary" @onclick="SwitchToEditMode">
                                        <i class="fa-light fa-edit"></i>
                                        <span>Edit</span>
                                    </button>
                                }
                            </div>
                        </div>

                        <div class="cd-tabs-container">
                            <div class="cd-tabs-header">
                                <button type="button" class="cd-tab-button @(activeViewTab == "basic" ? "cd-active" : "")" @onclick='() => SetActiveViewTab("basic")'>
                                    <i class="fa-light fa-info-circle"></i>
                                    <span>Basic Info</span>
                                </button>
                                <button type="button" class="cd-tab-button @(activeViewTab == "contact" ? "cd-active" : "")" @onclick='() => SetActiveViewTab("contact")'>
                                    <i class="fa-light fa-address-card"></i>
                                    <span>Contact</span>
                                </button>
                                <button type="button" class="cd-tab-button @(activeViewTab == "address" ? "cd-active" : "")" @onclick='() => SetActiveViewTab("address")'>
                                    <i class="fa-light fa-map-marker-alt"></i>
                                    <span>Address</span>
                                </button>
                                <button type="button" class="cd-tab-button @(activeViewTab == "banking" ? "cd-active" : "")" @onclick='() => SetActiveViewTab("banking")'>
                                    <i class="fa-light fa-university"></i>
                                    <span>Banking</span>
                                </button>
                                <button type="button" class="cd-tab-button @(activeViewTab == "branding" ? "cd-active" : "")" @onclick='() => SetActiveViewTab("branding")'>
                                    <i class="fa-light fa-image"></i>
                                    <span>Branding</span>
                                </button>
                                <button type="button" class="cd-tab-button @(activeViewTab == "branches" ? "cd-active" : "")" @onclick='() => SetActiveViewTab("branches")'>
                                    <i class="fa-light fa-network-wired"></i>
                                    <span>Branches</span>
                                    @if (CompanyModel.Branches?.Any() == true)
                                    {
                                        <span class="cd-badge cd-badge-count">@CompanyModel.Branches.Count</span>
                                    }
                                </button>
                            </div>

                            <div class="cd-tab-content">
                                <div class="cd-tab-pane @(activeViewTab == "basic" ? "cd-active" : "")">
                                    <div class="cd-card-grid">
                                        <div class="cd-info-card">
                                            <div class="cd-card-header">
                                                <i class="fa-light fa-info-circle cd-card-header-icon"></i>
                                                <h3 class="cd-card-title">Basic Information</h3>
                                            </div>
                                            <div class="cd-card-body">
                                                <div class="cd-info-group">
                                                    <span class="cd-info-label">Company Name</span>
                                                    <span class="cd-info-value">@CompanyModel.Name</span>
                                                </div>
                                                <div class="cd-info-group">
                                                    <span class="cd-info-label">Registration Number</span>
                                                    <span class="cd-info-value">@CompanyModel.RegistrationNumber</span>
                                                </div>
                                                <div class="cd-info-group">
                                                    <span class="cd-info-label">VAT Number</span>
                                                    <span class="cd-info-value">@(string.IsNullOrEmpty(CompanyModel.VatNumber) ? "Not provided" : CompanyModel.VatNumber)</span>
                                                </div>
                                                <div class="cd-info-group">
                                                    <span class="cd-info-label">Website</span>
                                                    <span class="cd-info-value">
                                                        @if (!string.IsNullOrEmpty(CompanyModel.Website))
                                                        {
                                                            <a href="@CompanyModel.Website" target="_blank" class="cd-link">@CompanyModel.Website</a>
                                                        }
                                                        else
                                                        {
                                                            <span>Not provided</span>
                                                        }
                                                    </span>
                                                </div>
                                                <div class="cd-info-group">
                                                    <span class="cd-info-label">Status</span>
                                                    <span class="cd-info-value">
                                                        <span class="cd-status-badge @(CompanyModel.IsActive ? "cd-active" : "cd-inactive")">
                                                            <i class="fa-light fa-@(CompanyModel.IsActive ? "check-circle" : "times-circle")"></i>
                                                            @(CompanyModel.IsActive ? "Active" : "Inactive")
                                                        </span>
                                                        @if (CompanyModel.Status != null)
                                                        {
                                                            <span class="cd-status-badge">@CompanyModel.Status.Name</span>
                                                        }
                                                    </span>
                                                </div>
                                                <div class="cd-info-group">
                                                    <span class="cd-info-label">Subscription Plan</span>
                                                    <span class="cd-info-value">
                                                        @if (CompanyModel.SubscriptionPlan != null)
                                                        {
                                                            <span>@CompanyModel.SubscriptionPlan.Name - $@CompanyModel.SubscriptionPlan.Price/@CompanyModel.SubscriptionPlan.BillingCycleDays days</span>
                                                        }
                                                        else
                                                        {
                                                            <span>No subscription plan selected</span>
                                                        }
                                                    </span>
                                                </div>
                                                @if (CompanyModel.MaxUsers.HasValue)
                                                {
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Max Users</span>
                                                        <span class="cd-info-value">@CompanyModel.MaxUsers</span>
                                                    </div>
                                                }
                                                @if (CompanyModel.MaxProperties.HasValue)
                                                {
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Max Properties</span>
                                                        <span class="cd-info-value">@CompanyModel.MaxProperties</span>
                                                    </div>
                                                }
                                                @if (CompanyModel.MaxBranches.HasValue)
                                                {
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Max Branches</span>
                                                        <span class="cd-info-value">@CompanyModel.MaxBranches</span>
                                                    </div>
                                                }
                                                @if (CompanyModel.SubscriptionStartDate.HasValue)
                                                {
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Subscription Start</span>
                                                        <span class="cd-info-value">@CompanyModel.SubscriptionStartDate?.ToString("dd MMM yyyy")</span>
                                                    </div>
                                                }
                                                @if (CompanyModel.SubscriptionEndDate.HasValue)
                                                {
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Subscription End</span>
                                                        <span class="cd-info-value">@CompanyModel.SubscriptionEndDate?.ToString("dd MMM yyyy")</span>
                                                    </div>
                                                }
                                                @if (CompanyModel.IsTrialPeriod)
                                                {
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Trial Period</span>
                                                        <span class="cd-info-value">Yes</span>
                                                    </div>
                                                }
                                                @if (CompanyModel.CreatedOn != default)
                                                {
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Created On</span>
                                                        <span class="cd-info-value">@CompanyModel.CreatedOn.ToString("dd MMM yyyy, HH:mm")</span>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(CompanyModel.CreatedBy))
                                                {
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Created By</span>
                                                        <span class="cd-info-value">@CompanyModel.CreatedBy</span>
                                                    </div>
                                                }
                                                @if (CompanyModel.UpdatedDate.HasValue)
                                                {
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Last Updated</span>
                                                        <span class="cd-info-value">@CompanyModel.UpdatedDate?.ToString("dd MMM yyyy, HH:mm")</span>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(CompanyModel.UpdatedBy))
                                                {
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Updated By</span>
                                                        <span class="cd-info-value">@CompanyModel.UpdatedBy</span>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="cd-tab-pane @(activeViewTab == "contact" ? "cd-active" : "")">
                                    <div class="cd-card-grid">
                                        <div class="cd-info-card">
                                            <div class="cd-card-header">
                                                <i class="fa-light fa-envelope cd-card-header-icon"></i>
                                                <h3 class="cd-card-title">Email Addresses</h3>
                                            </div>
                                            <div class="cd-card-body">
                                                @if (CompanyModel.EmailAddresses?.Any() == true)
                                                {
                                                    var primaryEmail = CompanyModel.EmailAddresses.FirstOrDefault(e => e.IsPrimary);
                                                    @if (primaryEmail != null)
                                                    {
                                                        <div class="cd-info-group">
                                                            <span class="cd-info-label">Primary Email</span>
                                                            <a href="mailto:@primaryEmail.EmailAddress" class="cd-info-value cd-email">
                                                                <i class="fa-light fa-envelope"></i> @primaryEmail.EmailAddress
                                                            </a>
                                                        </div>
                                                    }

                                                    @foreach (var email in CompanyModel.EmailAddresses.Where(e => !e.IsPrimary))
                                                    {
                                                        <div class="cd-info-group">
                                                            <span class="cd-info-label">
                                                                @(!string.IsNullOrEmpty(email.Description) ? email.Description : "Email")
                                                            </span>
                                                            <a href="mailto:@email.EmailAddress" class="cd-info-value cd-email">
                                                                <i class="fa-light fa-envelope"></i> @email.EmailAddress
                                                            </a>
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="cd-empty-state">
                                                        <i class="fa-light fa-envelope-open cd-empty-icon"></i>
                                                        <p class="cd-empty-text">No email addresses provided</p>
                                                    </div>
                                                }
                                            </div>
                                        </div>

                                        <div class="cd-info-card">
                                            <div class="cd-card-header">
                                                <i class="fa-light fa-phone cd-card-header-icon"></i>
                                                <h3 class="cd-card-title">Contact Numbers</h3>
                                            </div>
                                            <div class="cd-card-body">
                                                @if (CompanyModel.ContactNumbers?.Any() == true)
                                                {
                                                    var primaryContact = CompanyModel.ContactNumbers.FirstOrDefault(c => c.IsPrimary);
                                                    @if (primaryContact != null)
                                                    {
                                                        <div class="cd-info-group">
                                                            <span class="cd-info-label">Primary Phone</span>
                                                            <a href="tel:@primaryContact.Number" class="cd-info-value cd-phone">
                                                                <i class="fa-light fa-phone"></i> @primaryContact.Number
                                                            </a>
                                                        </div>
                                                    }

                                                    @foreach (var phone in CompanyModel.ContactNumbers.Where(c => !c.IsPrimary))
                                                    {
                                                        <div class="cd-info-group">
                                                            <span class="cd-info-label">
                                                                @if (!string.IsNullOrEmpty(phone.Description))
                                                                {
                                                                    @phone.Description
                                                                }
                                                                else if (phone.ContactNumberType != null)
                                                                {
                                                                    @phone.ContactNumberType.Name
                                                                }
                                                                else
                                                                {
                                                                    @("Phone")
                                                                }
                                                            </span>
                                                            <a href="tel:@phone.Number" class="cd-info-value cd-phone">
                                                                <i class="fa-light fa-phone"></i> @phone.Number
                                                            </a>
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="cd-empty-state">
                                                        <i class="fa-light fa-phone-slash cd-empty-icon"></i>
                                                        <p class="cd-empty-text">No contact numbers provided</p>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="cd-tab-pane @(activeViewTab == "address" ? "cd-active" : "")">
                                    <div class="cd-card-grid">
                                        <div class="cd-info-card">
                                            <div class="cd-card-header">
                                                <i class="fa-light fa-map-marker-alt cd-card-header-icon"></i>
                                                <h3 class="cd-card-title">Company Address</h3>
                                            </div>
                                            <div class="cd-card-body">
                                                @if (CompanyModel.Address != null)
                                                {
                                                    <div class="cd-address-container">
                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.ComplexName))
                                                        {
                                                            <div class="cd-address-line"><i class="fa-light fa-building"></i> @CompanyModel.Address.ComplexName</div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.BuildingName))
                                                        {
                                                            <div class="cd-address-line"><i class="fa-light fa-building"></i> @CompanyModel.Address.BuildingName</div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.UnitNumber))
                                                        {
                                                            <div class="cd-address-line"><i class="fa-light fa-door-closed"></i> Unit @CompanyModel.Address.UnitNumber</div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.Street))
                                                        {
                                                            <div class="cd-address-line"><i class="fa-light fa-road"></i> @CompanyModel.Address.Street</div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.Suburb))
                                                        {
                                                            <div class="cd-address-line"><i class="fa-light fa-map"></i> @CompanyModel.Address.Suburb</div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.City))
                                                        {
                                                            <div class="cd-address-line">
                                                                <i class="fa-light fa-city"></i>
                                                                @CompanyModel.Address.City@(!string.IsNullOrEmpty(CompanyModel.Address.Province) ? $", {CompanyModel.Address.Province}" : "")
                                                            </div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.PostalCode))
                                                        {
                                                            <div class="cd-address-line"><i class="fa-light fa-mailbox"></i> @CompanyModel.Address.PostalCode</div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.Country))
                                                        {
                                                            <div class="cd-address-line"><i class="fa-light fa-globe"></i> @CompanyModel.Address.Country</div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="cd-empty-state">
                                                        <i class="fa-light fa-map-marker-slash cd-empty-icon"></i>
                                                        <p class="cd-empty-text">No address information provided</p>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="cd-tab-pane @(activeViewTab == "banking" ? "cd-active" : "")">
                                    <div class="cd-card-grid">
                                        <div class="cd-info-card">
                                            <div class="cd-card-header">
                                                <i class="fa-light fa-university cd-card-header-icon"></i>
                                                <h3 class="cd-card-title">Banking Details</h3>
                                            </div>
                                            <div class="cd-card-body">
                                                @if (CompanyModel.BankAccount != null && !string.IsNullOrEmpty(CompanyModel.BankAccount.AccountNumber))
                                                {
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Bank Name</span>
                                                        <span class="cd-info-value">@(CompanyModel.BankAccount.BankName?.Name ?? "Not set")</span>
                                                    </div>
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Account Type</span>
                                                        <span class="cd-info-value">@(CompanyModel.BankAccount.AccountType ?? "Not set")</span>
                                                    </div>
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Account Number</span>
                                                        <span class="cd-info-value">@CompanyModel.BankAccount.AccountNumber</span>
                                                    </div>
                                                    <div class="cd-info-group">
                                                        <span class="cd-info-label">Branch Code</span>
                                                        <span class="cd-info-value">@CompanyModel.BankAccount.BranchCode</span>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="cd-empty-state">
                                                        <i class="fa-light fa-credit-card-blank cd-empty-icon"></i>
                                                        <p class="cd-empty-text">No banking details provided</p>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="cd-tab-pane @(activeViewTab == "branding" ? "cd-active" : "")">
                                    <div class="cd-card-grid">
                                        <div class="cd-info-card">
                                            <div class="cd-card-header">
                                                <i class="fa-light fa-image cd-card-header-icon"></i>
                                                <h3 class="cd-card-title">Company Logo</h3>
                                            </div>
                                            <div class="cd-card-body">
                                                @if (CompanyModel.MainLogoId.HasValue && CompanyModel.MainLogo != null)
                                                {
                                                    <div class="cd-logo-display">
                                                        <div class="cd-logo-container">
                                                            <img src="@CompanyModel.MainLogo.Url" alt="@CompanyModel.Name Logo" class="cd-logo-image" />
                                                        </div>
                                                        <div class="cd-logo-info">
                                                            <div class="cd-logo-title">@CompanyModel.MainLogo.FileName</div>
                                                            <div class="cd-logo-meta">
                                                                <span><i class="fa-light fa-file-image"></i> @CompanyModel.MainLogo.ContentType</span>
                                                                <span><i class="fa-light fa-weight"></i> @((CompanyModel.MainLogo.FileSize / 1024).ToString("N0")) KB</span>
                                                                <span><i class="fa-light fa-calendar"></i> @CompanyModel.MainLogo.UploadDate.ToString("dd MMM yyyy")</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="cd-empty-state">
                                                        <i class="fa-light fa-file-image cd-empty-icon"></i>
                                                        <p class="cd-empty-text">No logo uploaded</p>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="cd-tab-pane @(activeViewTab == "branches" ? "cd-active" : "")">
                                    <div class="cd-card-grid">
                                        <div class="cd-info-card">
                                            <div class="cd-card-header">
                                                <div class="cd-header-with-actions">
                                                    <h3 class="cd-card-title"><i class="fa-light fa-network-wired"></i> Company Branches</h3>
                                                    @if (CanEdit)
                                                    {
                                                        <button type="button" class="cd-button cd-button-outline cd-button-sm" @onclick="() => OnAddBranch.InvokeAsync(CompanyModel)">
                                                            <i class="fa-light fa-plus"></i>
                                                            <span>Add Branch</span>
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                            <div class="cd-card-body">
                                                @if (CompanyModel.Branches?.Any() == true)
                                                {
                                                    <div class="cd-branches-list">
                                                        @foreach (var branch in CompanyModel.Branches.OrderBy(b => b.Name))
                                                        {
                                                            <div class="cd-branch-item @(branch.IsActive ? "" : "cd-inactive")">
                                                                <div class="cd-branch-icon">
                                                                    @if (branch.MainLogoId.HasValue && branch.MainLogo != null)
                                                                    {
                                                                        <img src="@branch.MainLogo.Url" alt="@branch.Name" class="cd-branch-logo" />
                                                                    }
                                                                    else
                                                                    {
                                                                        <i class="fa-light fa-code-branch"></i>
                                                                    }
                                                                </div>
                                                                <div class="cd-branch-details">
                                                                    <div class="cd-branch-name">
                                                                        @branch.Name
                                                                        @if (branch.IsHeadOffice)
                                                                        {
                                                                            <span class="cd-badge cd-head-office"><i class="fa-light fa-star"></i> Head Office</span>
                                                                        }
                                                                    </div>
                                                                    <div class="cd-branch-contact">
                                                                        @if (!string.IsNullOrEmpty(branch.PrimaryEmail))
                                                                        {
                                                                            <a href="mailto:@branch.PrimaryEmail" class="cd-branch-email"><i class="fa-light fa-envelope"></i> @branch.PrimaryEmail</a>
                                                                        }
                                                                        @if (!string.IsNullOrEmpty(branch.PrimaryContactNumber))
                                                                        {
                                                                            <a href="tel:@branch.PrimaryContactNumber" class="cd-branch-phone"><i class="fa-light fa-phone"></i> @branch.PrimaryContactNumber</a>
                                                                        }
                                                                    </div>
                                                                </div>
                                                                <div class="cd-branch-status">
                                                                    <span class="cd-status-indicator @(branch.IsActive ? "cd-active" : "cd-inactive")"></span>
                                                                </div>
                                                                <div class="cd-branch-actions">
                                                                    <button type="button" class="cd-button cd-button-icon cd-button-sm" @onclick="() => OnViewBranch.InvokeAsync(branch)">
                                                                        <i class="fa-light fa-eye"></i>
                                                                    </button>
                                                                    @if (CanEdit)
                                                                    {
                                                                        <button type="button" class="cd-button cd-button-icon cd-button-sm" @onclick="() => OnEditBranch.InvokeAsync(branch)">
                                                                            <i class="fa-light fa-edit"></i>
                                                                        </button>
                                                                    }
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="cd-empty-state">
                                                        <i class="fa-light fa-network-wired cd-empty-icon"></i>
                                                        <p class="cd-empty-text">No branches added to this company</p>
                                                        @if (CanEdit)
                                                        {
                                                            <button type="button" class="cd-button cd-button-primary cd-button-sm" @onclick="() => OnAddBranch.InvokeAsync(CompanyModel)">
                                                                <i class="fa-light fa-plus"></i>
                                                                <span>Add Branch</span>
                                                            </button>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else if (IsEditMode)
                {
                    <EditForm Model="CompanyModel" OnValidSubmit="Save" FormName="editCompany" class="cd-edit-form">
                        <DataAnnotationsValidator />
                        <Roovia.Components.Elements.Forms.FluentValidationValidator />

                        <div class="cd-tabs-container">
                            <div class="cd-tabs-header">
                                <button type="button" class="cd-tab-button @(activeTab == "basic" ? "cd-active" : "")" @onclick='() => HandleTabChange("basic")'>
                                    <i class="fa-light fa-info-circle"></i>
                                    <span>Basic</span>
                                </button>
                                <button type="button" class="cd-tab-button @(activeTab == "contact" ? "cd-active" : "")" @onclick='() => HandleTabChange("contact")'>
                                    <i class="fa-light fa-address-card"></i>
                                    <span>Contact</span>
                                </button>
                                <button type="button" class="cd-tab-button @(activeTab == "address" ? "cd-active" : "")" @onclick='() => HandleTabChange("address")'>
                                    <i class="fa-light fa-map-marker-alt"></i>
                                    <span>Address</span>
                                </button>
                                <button type="button" class="cd-tab-button @(activeTab == "banking" ? "cd-active" : "")" @onclick='() => HandleTabChange("banking")'>
                                    <i class="fa-light fa-university"></i>
                                    <span>Banking</span>
                                </button>
                                <button type="button" class="cd-tab-button @(activeTab == "logo" ? "cd-active" : "")" @onclick='() => HandleTabChange("logo")'>
                                    <i class="fa-light fa-image"></i>
                                    <span>Logo</span>
                                </button>
                            </div>

                            <div class="cd-tab-content">
                                <div class="cd-tab-pane @(activeTab == "basic" ? "cd-active" : "")">
                                    <div class="cd-form-section">
                                        <div class="cd-form-group">
                                            <label for="name">Company Name <span class="cd-required">*</span></label>
                                            <div class="cd-input-wrapper">
                                                <i class="fa-light fa-building cd-input-icon"></i>
                                                <InputText @bind-Value="CompanyModel.Name" id="name" class="cd-input" placeholder="Enter company name" />
                                            </div>
                                            <ValidationMessage For="@(() => CompanyModel.Name)" class="cd-validation-message" />
                                        </div>

                                        <div class="cd-form-row">
                                            <div class="cd-form-group cd-col-6">
                                                <label for="registrationNumber">Registration Number <span class="cd-required">*</span></label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-id-card cd-input-icon"></i>
                                                    <InputText @bind-Value="CompanyModel.RegistrationNumber" id="registrationNumber" class="cd-input" placeholder="Enter registration number" />
                                                </div>
                                                <ValidationMessage For="@(() => CompanyModel.RegistrationNumber)" class="cd-validation-message" />
                                            </div>

                                            <div class="cd-form-group cd-col-6">
                                                <label for="vatNumber">VAT Number</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-receipt cd-input-icon"></i>
                                                    <InputText @bind-Value="CompanyModel.VatNumber" id="vatNumber" class="cd-input" placeholder="Enter VAT number (optional)" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cd-form-group">
                                            <label for="website">Website</label>
                                            <div class="cd-input-wrapper">
                                                <i class="fa-light fa-globe cd-input-icon"></i>
                                                <InputText @bind-Value="CompanyModel.Website" id="website" class="cd-input" placeholder="Enter website URL (optional)" />
                                            </div>
                                        </div>

                                        <div class="cd-form-row">
                                            <div class="cd-form-group cd-col-6">
                                                <label for="status">Status</label>
                                                <div class="cd-select-wrapper">
                                                    <i class="fa-light fa-toggle-on cd-input-icon"></i>
                                                    <InputSelect @bind-Value="statusValue" id="status" class="cd-select">
                                                        <option value="">-- Select Status --</option>
                                                        @if (CompanyStatusTypes != null)
                                                        {
                                                            @foreach (var status in CompanyStatusTypes.OrderBy(s => s.DisplayOrder))
                                                            {
                                                                <option value="@status.Id">@status.Name</option>
                                                            }
                                                        }
                                                    </InputSelect>
                                                    <i class="fa-light fa-chevron-down cd-select-arrow"></i>
                                                </div>
                                            </div>

                                            <div class="cd-form-group cd-col-6">
                                                <label for="subscription">Subscription Plan</label>
                                                <div class="cd-select-wrapper">
                                                    <i class="fa-light fa-gem cd-input-icon"></i>
                                                    <InputSelect @bind-Value="subscriptionValue" id="subscription" class="cd-select">
                                                        <option value="">-- Select Plan --</option>
                                                        @if (SubscriptionPlans != null)
                                                        {
                                                            @foreach (var plan in SubscriptionPlans.OrderBy(p => p.Price))
                                                            {
                                                                <option value="@plan.Id">@plan.Name - $@plan.Price/@plan.BillingCycleDays days</option>
                                                            }
                                                        }
                                                    </InputSelect>
                                                    <i class="fa-light fa-chevron-down cd-select-arrow"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cd-form-row">
                                            <div class="cd-form-group cd-col-4">
                                                <label for="maxUsers">Max Users</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-users cd-input-icon"></i>
                                                    <InputNumber @bind-Value="CompanyModel.MaxUsers" id="maxUsers" class="cd-input" placeholder="Maximum users allowed" />
                                                </div>
                                            </div>

                                            <div class="cd-form-group cd-col-4">
                                                <label for="maxProperties">Max Properties</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-home cd-input-icon"></i>
                                                    <InputNumber @bind-Value="CompanyModel.MaxProperties" id="maxProperties" class="cd-input" placeholder="Maximum properties allowed" />
                                                </div>
                                            </div>

                                            <div class="cd-form-group cd-col-4">
                                                <label for="maxBranches">Max Branches</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-network-wired cd-input-icon"></i>
                                                    <InputNumber @bind-Value="CompanyModel.MaxBranches" id="maxBranches" class="cd-input" placeholder="Maximum branches allowed" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cd-form-row">
                                            <div class="cd-form-group cd-col-6">
                                                <label for="subscriptionStartDate">Subscription Start Date</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-calendar-day cd-input-icon"></i>
                                                    <InputDate @bind-Value="CompanyModel.SubscriptionStartDate" id="subscriptionStartDate" class="cd-input" />
                                                </div>
                                            </div>

                                            <div class="cd-form-group cd-col-6">
                                                <label for="subscriptionEndDate">Subscription End Date</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-calendar-times cd-input-icon"></i>
                                                    <InputDate @bind-Value="CompanyModel.SubscriptionEndDate" id="subscriptionEndDate" class="cd-input" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cd-form-group">
                                            <div class="cd-switch-wrapper">
                                                <label class="cd-switch">
                                                    <InputCheckbox @bind-Value="CompanyModel.IsActive" class="cd-switch-input" />
                                                    <span class="cd-switch-slider"></span>
                                                </label>
                                                <div class="cd-switch-label">
                                                    <span>Active</span>
                                                    <small>Inactive companies will not be accessible to users</small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cd-form-group">
                                            <div class="cd-switch-wrapper">
                                                <label class="cd-switch">
                                                    <InputCheckbox @bind-Value="CompanyModel.IsTrialPeriod" class="cd-switch-input" />
                                                    <span class="cd-switch-slider"></span>
                                                </label>
                                                <div class="cd-switch-label">
                                                    <span>Trial Period</span>
                                                    <small>Mark this company as being in a trial period</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="cd-tab-pane @(activeTab == "contact" ? "cd-active" : "")">
                                    <div class="cd-form-section">
                                        <div class="cd-form-group">
                                            <label for="primaryEmail">Primary Email Address</label>
                                            <div class="cd-input-wrapper">
                                                <i class="fa-light fa-envelope cd-input-icon"></i>
                                                <input type="email" id="primaryEmail" class="cd-input"
                                                       value="@GetPrimaryEmail()" @onchange="(e) => UpdatePrimaryEmail(e.Value?.ToString())"
                                                       placeholder="Enter primary email address" />
                                            </div>
                                        </div>

                                        <div class="cd-form-group">
                                            <label for="primaryPhone">Primary Phone Number</label>
                                            <div class="cd-input-wrapper">
                                                <i class="fa-light fa-phone cd-input-icon"></i>
                                                <input type="tel" id="primaryPhone" class="cd-input"
                                                       value="@GetPrimaryPhone()" @onchange="(e) => UpdatePrimaryPhone(e.Value?.ToString())"
                                                       placeholder="Enter primary phone number" />
                                            </div>
                                        </div>

                                        <div class="cd-section-divider">
                                            <div class="cd-section-label">
                                                <i class="fa-light fa-envelope"></i>
                                                <span>Additional Email Addresses</span>
                                            </div>
                                            <button type="button" class="cd-button-small cd-button-outline" @onclick="AddEmail">
                                                <i class="fa-light fa-plus"></i> Add Email
                                            </button>
                                        </div>

                                        @if (CompanyModel.EmailAddresses?.Where(e => !e.IsPrimary).Any() == true)
                                        {
                                            <div class="cd-contact-list">
                                                @foreach (var email in CompanyModel.EmailAddresses.Where(e => !e.IsPrimary))
                                                {
                                                    <div class="cd-contact-item">
                                                        <div class="cd-contact-content">
                                                            <div class="cd-input-wrapper cd-flex-grow">
                                                                <i class="fa-light fa-envelope cd-input-icon"></i>
                                                                <input type="email" class="cd-input"
                                                                       value="@email.EmailAddress" @onchange="(e) => UpdateEmailAddress(email, e.Value?.ToString())"
                                                                       placeholder="Enter email address" />
                                                            </div>
                                                            <div class="cd-input-wrapper">
                                                                <i class="fa-light fa-tag cd-input-icon"></i>
                                                                <input type="text" class="cd-input"
                                                                       value="@email.Description" @onchange="(e) => UpdateEmailDescription(email, e.Value?.ToString())"
                                                                       placeholder="Description" />
                                                            </div>
                                                        </div>
                                                        <button type="button" class="cd-button-icon cd-button-danger" @onclick="() => RemoveEmail(email)">
                                                            <i class="fa-light fa-trash"></i>
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="cd-empty-list">
                                                <i class="fa-light fa-envelope-open"></i>
                                                <p>No additional email addresses</p>
                                            </div>
                                        }

                                        <div class="cd-section-divider">
                                            <div class="cd-section-label">
                                                <i class="fa-light fa-phone"></i>
                                                <span>Additional Phone Numbers</span>
                                            </div>
                                            <button type="button" class="cd-button-small cd-button-outline" @onclick="AddPhone">
                                                <i class="fa-light fa-plus"></i> Add Phone
                                            </button>
                                        </div>

                                        @if (CompanyModel.ContactNumbers?.Where(c => !c.IsPrimary).Any() == true)
                                        {
                                            <div class="cd-contact-list">
                                                @foreach (var phone in CompanyModel.ContactNumbers.Where(c => !c.IsPrimary))
                                                {
                                                    <div class="cd-contact-item">
                                                        <div class="cd-contact-content">
                                                            <div class="cd-input-wrapper cd-flex-grow">
                                                                <i class="fa-light fa-phone cd-input-icon"></i>
                                                                <input type="tel" class="cd-input"
                                                                       value="@phone.Number" @onchange="(e) => UpdatePhoneNumber(phone, e.Value?.ToString())"
                                                                       placeholder="Enter phone number" />
                                                            </div>
                                                            <div class="cd-select-wrapper">
                                                                <i class="fa-light fa-phone-office cd-input-icon"></i>
                                                                <select class="cd-select"
                                                                        value="@phone.ContactNumberTypeId" @onchange="(e) => UpdatePhoneTypeId(phone, e.Value?.ToString())">
                                                                    @if (contactNumberTypes != null)
                                                                    {
                                                                        @foreach (var type in contactNumberTypes)
                                                                        {
                                                                            <option value="@type.Id">@type.Name</option>
                                                                        }
                                                                    }
                                                                </select>
                                                                <i class="fa-light fa-chevron-down cd-select-arrow"></i>
                                                            </div>
                                                        </div>
                                                        <button type="button" class="cd-button-icon cd-button-danger" @onclick="() => RemovePhone(phone)">
                                                            <i class="fa-light fa-trash"></i>
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="cd-empty-list">
                                                <i class="fa-light fa-phone-slash"></i>
                                                <p>No additional phone numbers</p>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <div class="cd-tab-pane @(activeTab == "address" ? "cd-active" : "")">
                                    <div class="cd-form-section">
                                        <div class="cd-form-group">
                                            <label for="street">Street</label>
                                            <div class="cd-input-wrapper">
                                                <i class="fa-light fa-road cd-input-icon"></i>
                                                <InputText @bind-Value="CompanyModel.Address.Street" id="street" class="cd-input" placeholder="Enter street address" />
                                            </div>
                                        </div>

                                        <div class="cd-form-row">
                                            <div class="cd-form-group cd-col-4">
                                                <label for="unitNumber">Unit Number</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-door-closed cd-input-icon"></i>
                                                    <InputText @bind-Value="CompanyModel.Address.UnitNumber" id="unitNumber" class="cd-input" placeholder="Unit number" />
                                                </div>
                                            </div>

                                            <div class="cd-form-group cd-col-8">
                                                <label for="complexName">Complex Name</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-building cd-input-icon"></i>
                                                    <InputText @bind-Value="CompanyModel.Address.ComplexName" id="complexName" class="cd-input" placeholder="Complex name" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cd-form-group">
                                            <label for="buildingName">Building Name</label>
                                            <div class="cd-input-wrapper">
                                                <i class="fa-light fa-building cd-input-icon"></i>
                                                <InputText @bind-Value="CompanyModel.Address.BuildingName" id="buildingName" class="cd-input" placeholder="Building name" />
                                            </div>
                                        </div>

                                        <div class="cd-form-row">
                                            <div class="cd-form-group cd-col-6">
                                                <label for="suburb">Suburb</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-map cd-input-icon"></i>
                                                    <InputText @bind-Value="CompanyModel.Address.Suburb" id="suburb" class="cd-input" placeholder="Enter suburb" />
                                                </div>
                                            </div>

                                            <div class="cd-form-group cd-col-6">
                                                <label for="city">City</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-city cd-input-icon"></i>
                                                    <InputText @bind-Value="CompanyModel.Address.City" id="city" class="cd-input" placeholder="Enter city" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cd-form-row">
                                            <div class="cd-form-group cd-col-6">
                                                <label for="province">Province</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-map-marked cd-input-icon"></i>
                                                    <InputText @bind-Value="CompanyModel.Address.Province" id="province" class="cd-input" placeholder="Enter province" />
                                                </div>
                                            </div>

                                            <div class="cd-form-group cd-col-6">
                                                <label for="postalCode">Postal Code</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-mailbox cd-input-icon"></i>
                                                    <InputText @bind-Value="CompanyModel.Address.PostalCode" id="postalCode" class="cd-input" placeholder="Enter postal code" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cd-form-group">
                                            <label for="country">Country</label>
                                            <div class="cd-input-wrapper">
                                                <i class="fa-light fa-globe cd-input-icon"></i>
                                                <InputText @bind-Value="CompanyModel.Address.Country" id="country" class="cd-input" placeholder="Enter country" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="cd-tab-pane @(activeTab == "banking" ? "cd-active" : "")">
                                    <div class="cd-form-section">
                                        <div class="cd-form-row">
                                            <div class="cd-form-group cd-col-6">
                                                <label for="bankNameId">Bank Name</label>
                                                <div class="cd-select-wrapper">
                                                    <i class="fa-light fa-university cd-input-icon"></i>
                                                    <select id="bankNameId" class="cd-select"
                                                            value="@(CompanyModel.BankAccount.BankNameId?.ToString() ?? "")"
                                                            @onchange="(e) => UpdateBankNameId(e.Value?.ToString())">
                                                        <option value="">-- Select Bank --</option>
                                                        @if (bankNameTypes != null)
                                                        {
                                                            @foreach (var bank in bankNameTypes.OrderBy(b => b.Name))
                                                            {
                                                                <option value="@bank.Id">@bank.Name</option>
                                                            }
                                                        }
                                                    </select>
                                                    <i class="fa-light fa-chevron-down cd-select-arrow"></i>
                                                </div>
                                            </div>

                                            <div class="cd-form-group cd-col-6">
                                                <label for="accountType">Account Type</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-credit-card cd-input-icon"></i>
                                                    <InputText @bind-Value="CompanyModel.BankAccount.AccountType" id="accountType" class="cd-input" placeholder="E.g. Current, Savings, Business" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cd-form-row">
                                            <div class="cd-form-group cd-col-6">
                                                <label for="accountNumber">Account Number</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-hashtag cd-input-icon"></i>
                                                    <InputText @bind-Value="CompanyModel.BankAccount.AccountNumber" id="accountNumber" class="cd-input" placeholder="Enter account number" />
                                                </div>
                                            </div>

                                            <div class="cd-form-group cd-col-6">
                                                <label for="branchCode">Branch Code</label>
                                                <div class="cd-input-wrapper">
                                                    <i class="fa-light fa-code cd-input-icon"></i>
                                                    <InputText @bind-Value="CompanyModel.BankAccount.BranchCode" id="branchCode" class="cd-input" placeholder="Enter branch code" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="cd-tab-pane @(activeTab == "logo" ? "cd-active" : "")">
                                    <div class="cd-form-section">
                                        <div class="cd-logo-upload-container">
                                            @if (CompanyModel.MainLogoId.HasValue && CompanyModel.MainLogo != null)
                                            {
                                                <div class="cd-current-logo">
                                                    <h5>Current Logo</h5>
                                                    <div class="cd-logo-preview">
                                                        <img src="@CompanyModel.MainLogo.Url" alt="Company Logo" class="cd-logo-image" />
                                                    </div>
                                                    <div class="cd-logo-actions">
                                                        <button type="button" class="cd-button cd-button-danger" @onclick="RemoveLogo">
                                                            <i class="fa-light fa-trash"></i>
                                                            <span>Remove</span>
                                                        </button>
                                                        <button type="button" class="cd-button cd-button-outline" @onclick="ShowUploadDialog">
                                                            <i class="fa-light fa-exchange"></i>
                                                            <span>Replace</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="cd-empty-logo-upload">
                                                    <i class="fa-light fa-image"></i>
                                                    <p>No logo uploaded</p>
                                                    <button type="button" class="cd-button cd-button-primary" @onclick="ShowUploadDialog">
                                                        <i class="fa-light fa-cloud-upload"></i>
                                                        <span>Upload Logo</span>
                                                    </button>
                                                </div>
                                            }

                                            @if (isUploading)
                                            {
                                                <div class="cd-upload-progress">
                                                    <div class="cd-progress-bar">
                                                        <div class="cd-progress-fill" style="width: @uploadProgress%"></div>
                                                    </div>
                                                    <span class="cd-progress-text">Uploading... @uploadProgress%</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </EditForm>
                }
            </div>
        }
    </div>

    <div class="cd-modal-footer">
        <button type="button" class="cd-button cd-button-outline" @onclick="OnCancel">
            <i class="fa-light fa-times"></i>
            <span>Cancel</span>
        </button>
        @if (IsViewMode && CanEdit)
        {
            <button type="button" class="cd-button cd-button-primary" @onclick="SwitchToEditMode">
                <i class="fa-light fa-edit"></i>
                <span>Edit</span>
            </button>
        }
        else if (IsEditMode)
        {
            <button class="cd-button cd-button-primary" @onclick="Save">
                <i class="fa-light fa-save"></i>
                <span>Save Changes</span>
            </button>
        }
    </div>
</div>

@if (showLogoUploadDialog)
{
    <div class="cd-modal-backdrop"></div>
    <div class="cd-upload-modal-wrapper">
        <div class="cd-modal-header">
            <div class="cd-modal-title">
                <i class="fa-light fa-cloud-upload"></i>
                <span>Upload Logo</span>
            </div>
            <button type="button" class="cd-close-button" @onclick="CloseUploadDialog">
                <i class="fa-light fa-times"></i>
            </button>
        </div>
        <div class="cd-modal-body">
            <div class="cd-upload-instructions">
                <h4>Upload Company Logo</h4>
                <p>Please select an image file to upload as the company logo.</p>
                <div class="cd-upload-specs">
                    <div class="cd-spec-item">
                        <i class="fa-light fa-image"></i>
                        <span>Recommended size: 512x512 pixels</span>
                    </div>
                    <div class="cd-spec-item">
                        <i class="fa-light fa-weight"></i>
                        <span>Maximum file size: 5MB</span>
                    </div>
                    <div class="cd-spec-item">
                        <i class="fa-light fa-file-image"></i>
                        <span>Supported formats: JPG, PNG, GIF</span>
                    </div>
                </div>
            </div>

            <div class="cd-upload-area @(logoFile != null ? "cd-has-file" : "")">
                <SfUploader ID="LogoUploader"
                            AllowedExtensions=".jpg, .jpeg, .png, .gif"
                            MaxFileSize="5242880"
                            AllowMultiple="false"
                            ShowFileList="true"
                            AutoUpload="false">
                    <UploaderEvents ValueChange="OnLogoFileSelected"></UploaderEvents>
                </SfUploader>

                @if (previewImageData != null)
                {
                    <div class="cd-image-preview">
                        <h5>Preview</h5>
                        <div class="cd-preview-container">
                            <img src="@previewImageData" alt="Logo Preview" class="cd-logo-preview-image" />
                        </div>
                    </div>
                }
            </div>

            @if (!string.IsNullOrEmpty(uploadError))
            {
                <div class="cd-upload-error">
                    <i class="fa-light fa-exclamation-triangle"></i>
                    <p>@uploadError</p>
                </div>
            }
        </div>
        <div class="cd-modal-footer">
            <button type="button" class="cd-button cd-button-outline" @onclick="CloseUploadDialog">
                <i class="fa-light fa-times"></i>
                <span>Cancel</span>
            </button>
            <button type="button" class="cd-button cd-button-primary" @onclick="UploadLogo" disabled="@(logoFile == null)">
                <i class="fa-light fa-cloud-upload"></i>
                <span>Upload</span>
            </button>
        </div>
    </div>
}

@code {
    [Parameter] public Company CompanyModel { get; set; } = new Company();
    [Parameter] public IEnumerable<CompanyStatusType>? CompanyStatusTypes { get; set; }
    [Parameter] public IEnumerable<SubscriptionPlan>? SubscriptionPlans { get; set; }
    [Parameter] public List<BankNameType>? bankNameTypes { get; set; }
    [Parameter] public List<ContactNumberType>? contactNumberTypes { get; set; }
    [Parameter] public bool IsEdit { get; set; } = false;
    [Parameter] public bool IsView { get; set; } = false;
    [Parameter] public bool CanEdit { get; set; } = true;
    [Parameter] public EventCallback<Company> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<Company> OnAddBranch { get; set; }
    [Parameter] public EventCallback<Branch> OnViewBranch { get; set; }
    [Parameter] public EventCallback<Branch> OnEditBranch { get; set; }

    private bool isLoading = false;
    private string activeTab = "basic";
    private string activeViewTab = "basic";
    private bool IsEditMode => (IsEdit || isInEditMode) && !IsView;
    private bool isInEditMode = false;
    private bool IsViewMode => IsView || !IsEditMode;

    // Add these properties to handle binding with InputSelect
    private string statusValue
    {
        get => CompanyModel.StatusId?.ToString() ?? "";
        set
        {
            CompanyModel.StatusId = string.IsNullOrEmpty(value) ? null : int.Parse(value);
        }
    }

    private string subscriptionValue
    {
        get => CompanyModel.SubscriptionPlanId?.ToString() ?? "";
        set
        {
            if (string.IsNullOrEmpty(value))
            {
                CompanyModel.SubscriptionPlanId = null;
                CompanyModel.SubscriptionPlan = null;
                return;
            }

            if (int.TryParse(value, out var planId))
            {
                CompanyModel.SubscriptionPlanId = planId;
                // Update the subscription plan object
                if (SubscriptionPlans != null)
                {
                    var plan = SubscriptionPlans.FirstOrDefault(p => p.Id == planId);
                    CompanyModel.SubscriptionPlan = plan;

                    // Auto-populate limits from the plan if available
                    if (plan != null)
                    {
                        if (plan.MaxUsers.HasValue && (!CompanyModel.MaxUsers.HasValue || CompanyModel.MaxUsers.Value == 0))
                        {
                            CompanyModel.MaxUsers = plan.MaxUsers;
                        }

                        if (plan.MaxProperties.HasValue && (!CompanyModel.MaxProperties.HasValue || CompanyModel.MaxProperties.Value == 0))
                        {
                            CompanyModel.MaxProperties = plan.MaxProperties;
                        }

                        if (plan.MaxBranches.HasValue && (!CompanyModel.MaxBranches.HasValue || CompanyModel.MaxBranches.Value == 0))
                        {
                            CompanyModel.MaxBranches = plan.MaxBranches;
                        }

                        // Set subscription dates if not already set
                        if (!CompanyModel.SubscriptionStartDate.HasValue)
                        {
                            CompanyModel.SubscriptionStartDate = DateTime.Today;
                        }

                        if (!CompanyModel.SubscriptionEndDate.HasValue && plan.BillingCycleDays > 0)
                        {
                            CompanyModel.SubscriptionEndDate = CompanyModel.SubscriptionStartDate.Value.AddDays(plan.BillingCycleDays);
                        }

                        // Set trial period based on plan
                        CompanyModel.IsTrialPeriod = plan.HasTrialPeriod;
                    }
                }
            }
        }
    }

    // Logo upload related fields
    private bool showLogoUploadDialog = false;
    private IBrowserFile? logoFile;
    private bool isUploading = false;
    private int uploadProgress = 0;
    private string uploadError = string.Empty;
    private long maxFileSize = 1024 * 1024 * 5; // 5MB

    // New fields for SfUploader and image processing
    private string? previewImageData;
    private byte[]? resizedImageData;
    private string logoContentType = string.Empty;
    private int logoTargetWidth = 512;
    private int logoTargetHeight = 512;

    protected override async Task OnInitializedAsync()
    {
        // Load reference data if not provided
        if (contactNumberTypes == null || bankNameTypes == null)
        {
            await LoadReferenceData();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (CompanyModel.Id != 0)
            {
                await LoadCompanyData();
            }
            else
            {
                InitializeNewCompany();
            }

            // For new companies, start in edit mode
            if (CompanyModel.Id == 0)
            {
                isInEditMode = true;
            }
            else if (IsView)
            {
                isInEditMode = false;
            }

            await InvokeAsync(() => this.StateHasChanged());
        }
    }

    private async Task LoadReferenceData()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            if (contactNumberTypes == null)
            {
                contactNumberTypes = await context.ContactNumberTypes
                    .Where(t => t.IsActive)
                    .OrderBy(t => t.DisplayOrder)
                    .ToListAsync();
            }

            if (bankNameTypes == null)
            {
                bankNameTypes = await context.BankNameTypes
                    .Where(b => b.IsActive)
                    .OrderBy(b => b.DisplayOrder)
                    .ToListAsync();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading reference data: {ex.Message}", "Error");
        }
    }

    private void InitializeNewCompany()
    {
        CompanyModel = new Company
            {
                IsActive = true,
                Address = new Address { Country = "South Africa" },
                BankAccount = new BankAccount(),
                EmailAddresses = new List<Email>(),
                ContactNumbers = new List<ContactNumber>(),
                Branches = new List<Branch>(),
                CreatedOn = DateTime.Now
            };
    }

    private async Task LoadCompanyData()
    {
        isLoading = true;

        try
        {
            var response = await UserService.GetCompanyWithDetails(CompanyModel.Id);
            if (response.ResponseInfo.Success)
            {
                CompanyModel = (Company)response.Response;

                // Initialize collections if null
                if (CompanyModel.EmailAddresses == null)
                    CompanyModel.EmailAddresses = new List<Email>();
                if (CompanyModel.ContactNumbers == null)
                    CompanyModel.ContactNumbers = new List<ContactNumber>();
                if (CompanyModel.Branches == null)
                    CompanyModel.Branches = new List<Branch>();

                // Initialize bank account if null
                if (CompanyModel.BankAccount == null)
                {
                    CompanyModel.BankAccount = new BankAccount();
                }

                // Load the logo if there's one
                if (CompanyModel.MainLogoId.HasValue)
                {
                    using var context = await DbContextFactory.CreateDbContextAsync();
                    CompanyModel.MainLogo = await context.CdnFileMetadata
                        .FirstOrDefaultAsync(f => f.Id == CompanyModel.MainLogoId.Value);
                }

                // Load subscription plan if there's one
                if (CompanyModel.SubscriptionPlanId.HasValue && SubscriptionPlans != null)
                {
                    CompanyModel.SubscriptionPlan = SubscriptionPlans.FirstOrDefault(p => p.Id == CompanyModel.SubscriptionPlanId.Value);
                }

                // Load status if there's one
                if (CompanyModel.StatusId.HasValue)
                {
                    using var context = await DbContextFactory.CreateDbContextAsync();
                    CompanyModel.Status = await context.CompanyStatusTypes
                        .FirstOrDefaultAsync(s => s.Id == CompanyModel.StatusId.Value);
                }
            }
            else
            {
                ToastService.ShowError(response.ResponseInfo.Message, "Error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading company: {ex.Message}", "Error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetDialogTitle()
    {
        if (IsViewMode)
        {
            return "Company Details";
        }
        else if (CompanyModel.Id == 0)
        {
            return "Create Company";
        }
        else
        {
            return "Edit Company";
        }
    }

    private string GetDialogIcon()
    {
        if (IsViewMode)
        {
            return "fa-light fa-building";
        }
        else if (CompanyModel.Id == 0)
        {
            return "fa-light fa-building-plus";
        }
        else
        {
            return "fa-light fa-building-pen";
        }
    }

    private void SwitchToEditMode()
    {
        isInEditMode = true;
        IsView = false;
        StateHasChanged();
    }

    private void HandleTabChange(string tabId)
    {
        activeTab = tabId;
    }

    private void SetActiveViewTab(string tabId)
    {
        activeViewTab = tabId;
    }

    private async Task HandleConfirmAction()
    {
        if (IsView)
        {
            await OnCancel.InvokeAsync();
        }
        else if (IsEditMode)
        {
            await Save();
        }
        else
        {
            SwitchToEditMode();
        }
    }

    private async Task Save()
    {
        try
        {
            isLoading = true;

            if (CompanyModel.Id == 0)
            {
                // Create new company
                CompanyModel.CreatedBy = "CurrentUser"; // Will be replaced with actual current user ID by the service
                CompanyModel.CreatedOn = DateTime.Now;
            }
            else
            {
                // Update existing company
                CompanyModel.UpdatedBy = "CurrentUser"; // Will be replaced with actual current user ID by the service
                CompanyModel.UpdatedDate = DateTime.Now;
            }

            // Ensure all emails & phone numbers have RelatedEntityType and CompanyId set
            if (CompanyModel.EmailAddresses != null)
            {
                foreach (var email in CompanyModel.EmailAddresses)
                {
                    email.RelatedEntityType = "Company";
                    if (CompanyModel.Id > 0)
                    {
                        email.SetRelatedEntity("Company", CompanyModel.Id);
                    }
                }
            }

            if (CompanyModel.ContactNumbers != null)
            {
                foreach (var phone in CompanyModel.ContactNumbers)
                {
                    phone.RelatedEntityType = "Company";
                    if (CompanyModel.Id > 0)
                    {
                        phone.SetRelatedEntity("Company", CompanyModel.Id);
                    }
                }
            }

            await OnSave.InvokeAsync(CompanyModel);

            if (isInEditMode)
            {
                // If we're in "switch to edit mode" state, go back to view mode after save
                isInEditMode = false;
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving company: {ex.Message}", "Error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void UpdateBankNameId(string value)
    {
        if (string.IsNullOrEmpty(value))
        {
            CompanyModel.BankAccount.BankNameId = null;
            return;
        }

        if (int.TryParse(value, out var bankNameId))
        {
            CompanyModel.BankAccount.BankNameId = bankNameId;

            // Set default branch code if available
            if (bankNameTypes != null)
            {
                var bankName = bankNameTypes.FirstOrDefault(b => b.Id == bankNameId);
                if (bankName != null && !string.IsNullOrEmpty(bankName.DefaultBranchCode))
                {
                    CompanyModel.BankAccount.BranchCode = bankName.DefaultBranchCode;
                }
            }
        }
    }

    // Helper methods for email and phone management
    private string GetPrimaryEmail()
    {
        var primaryEmail = CompanyModel.EmailAddresses?.FirstOrDefault(e => e.IsPrimary);
        return primaryEmail?.EmailAddress ?? string.Empty;
    }

    private string GetPrimaryPhone()
    {
        var primaryPhone = CompanyModel.ContactNumbers?.FirstOrDefault(c => c.IsPrimary);
        return primaryPhone?.Number ?? string.Empty;
    }

    private void UpdatePrimaryEmail(string value)
    {
        if (CompanyModel.EmailAddresses == null)
        {
            CompanyModel.EmailAddresses = new List<Email>();
        }

        var primaryEmail = CompanyModel.EmailAddresses.FirstOrDefault(e => e.IsPrimary);

        if (primaryEmail != null)
        {
            primaryEmail.EmailAddress = value;
            primaryEmail.UpdatedDate = DateTime.Now;
        }
        else if (!string.IsNullOrEmpty(value))
        {
            var newEmail = new Email
                {
                    EmailAddress = value,
                    IsPrimary = true,
                    IsActive = true,
                    RelatedEntityType = "Company",
                    CreatedOn = DateTime.Now
                };

            if (CompanyModel.Id > 0)
            {
                newEmail.SetRelatedEntity("Company", CompanyModel.Id);
            }

            CompanyModel.EmailAddresses.Add(newEmail);
        }
    }

    private void UpdatePrimaryPhone(string value)
    {
        if (CompanyModel.ContactNumbers == null)
        {
            CompanyModel.ContactNumbers = new List<ContactNumber>();
        }

        var primaryPhone = CompanyModel.ContactNumbers.FirstOrDefault(c => c.IsPrimary);

        if (primaryPhone != null)
        {
            primaryPhone.Number = value;
            primaryPhone.UpdatedDate = DateTime.Now;
        }
        else if (!string.IsNullOrEmpty(value))
        {
            var newPhone = new ContactNumber
                {
                    Number = value,
                    ContactNumberTypeId = contactNumberTypes?.FirstOrDefault()?.Id ?? 1,
                    IsPrimary = true,
                    IsActive = true,
                    RelatedEntityType = "Company",
                    CreatedOn = DateTime.Now
                };

            if (CompanyModel.Id > 0)
            {
                newPhone.SetRelatedEntity("Company", CompanyModel.Id);
            }

            CompanyModel.ContactNumbers.Add(newPhone);
        }
    }

    private void AddEmail()
    {
        if (CompanyModel.EmailAddresses == null)
        {
            CompanyModel.EmailAddresses = new List<Email>();
        }

        CompanyModel.EmailAddresses.Add(new Email
            {
                IsPrimary = false,
                IsActive = true,
                RelatedEntityType = "Company",
                CreatedOn = DateTime.Now
            });
    }

    private void RemoveEmail(Email email)
    {
        if (CompanyModel.EmailAddresses != null)
        {
            CompanyModel.EmailAddresses.Remove(email);
        }
    }

    private void UpdateEmailAddress(Email email, string value)
    {
        email.EmailAddress = value;
    }

    private void UpdateEmailDescription(Email email, string value)
    {
        email.Description = value;
    }

    private void AddPhone()
    {
        if (CompanyModel.ContactNumbers == null)
        {
            CompanyModel.ContactNumbers = new List<ContactNumber>();
        }

        CompanyModel.ContactNumbers.Add(new ContactNumber
            {
                ContactNumberTypeId = contactNumberTypes?.FirstOrDefault()?.Id ?? 1,
                IsPrimary = false,
                IsActive = true,
                RelatedEntityType = "Company",
                CreatedOn = DateTime.Now
            });
    }

    private void RemovePhone(ContactNumber phone)
    {
        if (CompanyModel.ContactNumbers != null)
        {
            CompanyModel.ContactNumbers.Remove(phone);
        }
    }

    private void UpdatePhoneNumber(ContactNumber phone, string value)
    {
        phone.Number = value;
    }

    private void UpdatePhoneTypeId(ContactNumber phone, string value)
    {
        if (int.TryParse(value, out var typeId))
        {
            phone.ContactNumberTypeId = typeId;
        }
    }

    private void UpdatePhoneDescription(ContactNumber phone, string value)
    {
        phone.Description = value;
    }

    // Logo upload methods
    private void ShowUploadDialog()
    {
        uploadError = string.Empty;
        logoFile = null;
        previewImageData = null;
        resizedImageData = null;
        showLogoUploadDialog = true;
    }

    private void CloseUploadDialog()
    {
        showLogoUploadDialog = false;
        logoFile = null;
        previewImageData = null;
        resizedImageData = null;
        uploadError = string.Empty;
    }

    // SfUploader logo file selection handler
    private async Task OnLogoFileSelected(UploadChangeEventArgs args)
    {
        uploadError = string.Empty;

        if (args.Files == null || args.Files.Count == 0)
        {
            logoFile = null;
            previewImageData = null;
            resizedImageData = null;
            return;
        }

        var file = args.Files[0];
        logoFile = file.File;
        logoContentType = file.FileInfo.MimeContentType;

        if (logoFile.Size > maxFileSize)
        {
            uploadError = "File size exceeds 5MB limit";
            logoFile = null;
            previewImageData = null;
            resizedImageData = null;
            return;
        }

        // Validate file type
        if (!logoContentType.StartsWith("image/"))
        {
            uploadError = "Please select an image file";
            logoFile = null;
            previewImageData = null;
            resizedImageData = null;
            return;
        }

        try
        {
            // Resize the image before upload
            var resizedFile = await logoFile.RequestImageFileAsync(logoContentType, logoTargetWidth, logoTargetHeight);

            // Create a buffer for the resized image
            resizedImageData = new byte[resizedFile.Size];
            using (var stream = resizedFile.OpenReadStream())
            {
                await stream.ReadAsync(resizedImageData);
            }

            // Generate a preview image as base64
            previewImageData = $"data:{logoContentType};base64,{Convert.ToBase64String(resizedImageData)}";

            StateHasChanged();
        }
        catch (Exception ex)
        {
            uploadError = $"Error processing image: {ex.Message}";
            logoFile = null;
            previewImageData = null;
            resizedImageData = null;
        }
    }

    private async Task UploadLogo()
    {
        if (logoFile == null || resizedImageData == null)
        {
            uploadError = "Please select a logo file to upload";
            return;
        }

        try
        {
            isUploading = true;
            uploadProgress = 0;
            StateHasChanged();

            // Create a unique filename
            var fileName = $"company-logo-{CompanyModel.Id}-{DateTime.Now:yyyyMMddHHmmss}{Path.GetExtension(logoFile.Name)}";

            // Update progress as we prepare the upload
            uploadProgress = 30;
            StateHasChanged();

            // Use the CDN service to upload the resized file
            using var stream = new MemoryStream(resizedImageData);
            var url = await CdnService.UploadFileAsync(
                stream,
                fileName,
                logoContentType,
                "logos",
                CompanyModel.Id > 0 ? CompanyModel.Id.ToString() : ""
            );

            uploadProgress = 80;
            StateHasChanged();

            if (!string.IsNullOrEmpty(url))
            {
                // Get the file metadata
                var metadata = await CdnService.GetFileMetadataAsync(url);

                if (metadata != null)
                {
                    // Update the company model with the new logo
                    CompanyModel.MainLogoId = metadata.Id;
                    CompanyModel.MainLogo = metadata;

                    uploadProgress = 100;
                    ToastService.ShowSuccess("Logo uploaded successfully", "Success");
                    showLogoUploadDialog = false;
                }
                else
                {
                    uploadError = "Failed to retrieve uploaded file metadata";
                }
            }
            else
            {
                uploadError = "Failed to upload logo";
            }
        }
        catch (Exception ex)
        {
            uploadError = $"Error uploading logo: {ex.Message}";
            ToastService.ShowError(uploadError, "Error");
        }
        finally
        {
            isUploading = false;
            uploadProgress = 0;
            StateHasChanged();
        }
    }

    private async Task RemoveLogo()
    {
        try
        {
            if (CompanyModel.MainLogoId.HasValue && CompanyModel.MainLogo != null)
            {
                // Remove from CDN using the URL
                await CdnService.DeleteFileAsync(CompanyModel.MainLogo.Url);

                // Update the model
                CompanyModel.MainLogoId = null;
                CompanyModel.MainLogo = null;

                ToastService.ShowSuccess("Logo removed successfully", "Success");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error removing logo: {ex.Message}", "Error");
        }
    }
}