@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using Roovia.Components
@using Roovia.Components.Elements.Forms
@using Roovia.Data
@using Roovia.Interfaces
@using Roovia.Models.BusinessHelperModels
@using Roovia.Models.UserCompanyMappingModels
@using Roovia.Models.UserCompanyModels
@using Roovia.Services
@using Roovia.Services.General
@inject IUser UserService
@inject ICdnService CdnService
@inject ToastService ToastService
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory

<RVModal IsVisible="true"
Title="@GetDialogTitle()"
Icon="@GetDialogIcon()"
OnClose="OnCancel"
OnCancel="OnCancel"
OnConfirm="HandleConfirmAction"
ConfirmText="@(IsView ? "Close" : (IsEditMode ? "Save" : "Edit"))"
CancelText="@(IsView ? "Close" : "Cancel")"
DefaultFooter="false"
Size="lg">
    <ChildContent>
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <h3 class="loading-text">Loading company details...</h3>
            </div>
        }
        else
        {
            <div class="company-dialog">
                @if (IsViewMode)
                {
                    <div class="company-view-container">
                        <div class="company-header">
                            <div class="company-header-flex">
                                <div class="company-icon-wrapper">
                                    @if (CompanyModel.MainLogoId.HasValue && CompanyModel.MainLogo != null)
                                    {
                                        <img src="@CompanyModel.MainLogo.Url" alt="@CompanyModel.Name" class="company-logo-large" />
                                    }
                                    else
                                    {
                                        <div class="company-icon-large">
                                            <i class="fa-light fa-building"></i>
                                        </div>
                                    }
                                    <div class="status-indicator @(CompanyModel.IsActive ? "active" : "inactive")"></div>
                                </div>

                                <div class="company-header-info">
                                    <h2>@CompanyModel.Name</h2>

                                    <div class="company-meta">
                                        @if (!string.IsNullOrEmpty(CompanyModel.RegistrationNumber))
                                        {
                                            <span class="company-meta-item"><i class="fa-light fa-id-card"></i>Reg: @CompanyModel.RegistrationNumber</span>
                                        }
                                        @if (!string.IsNullOrEmpty(CompanyModel.VatNumber))
                                        {
                                            <span class="company-meta-item"><i class="fa-light fa-receipt"></i>VAT: @CompanyModel.VatNumber</span>
                                        }
                                    </div>

                                    <div class="company-badges">
                                        <span class="status-badge @(CompanyModel.IsActive ? "status-active" : "status-inactive")">
                                            <i class="fa-light fa-@(CompanyModel.IsActive ? "check-circle" : "times-circle")"></i>
                                            @(CompanyModel.IsActive ? "Active" : "Inactive")
                                        </span>
                                        @if (CompanyModel.Status != null)
                                        {
                                            <span class="status-badge">@CompanyModel.Status.Name</span>
                                        }
                                        @if (CompanyModel.SubscriptionPlan != null)
                                        {
                                            <span class="subscription-badge">
                                                <i class="fa-light fa-gem"></i> @CompanyModel.SubscriptionPlan.Name
                                            </span>
                                        }
                                    </div>
                                </div>

                                @if (CanEdit)
                                {
                                    <div class="company-actions">
                                        <RVButton ButtonType="primary" IconLeft="fa-light fa-edit" Text="Edit"
                                        OnClick="SwitchToEditMode" CssClass="edit-btn" />
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="company-details-tabs">
                            @{
                                var companyTabs = new List<RVTab.RVTabItem>
                    {
                    new RVTab.RVTabItem
                    {
                    Id = "basic",
                    Title = "Basic Info",
                    Icon = "fa-light fa-info-circle",
                    IsActive = activeViewTab == "basic"
                    },
                    new RVTab.RVTabItem
                    {
                    Id = "contact",
                    Title = "Contact",
                    Icon = "fa-light fa-address-card",
                    IsActive = activeViewTab == "contact"
                    },
                    new RVTab.RVTabItem
                    {
                    Id = "address",
                    Title = "Address",
                    Icon = "fa-light fa-map-marker-alt",
                    IsActive = activeViewTab == "address"
                    },
                    new RVTab.RVTabItem
                    {
                    Id = "banking",
                    Title = "Banking",
                    Icon = "fa-light fa-university",
                    IsActive = activeViewTab == "banking"
                    },
                    new RVTab.RVTabItem
                    {
                    Id = "branding",
                    Title = "Branding",
                    Icon = "fa-light fa-image",
                    IsActive = activeViewTab == "branding"
                    },
                    new RVTab.RVTabItem
                    {
                    Id = "branches",
                    Title = "Branches",
                    Icon = "fa-light fa-network-wired",
                    IsActive = activeViewTab == "branches",
                    BadgeCount = CompanyModel.Branches?.Count ?? 0
                    }
                    };
                            }

                            <RVTab Tabs="companyTabs" Size="sm" OnTabChange="SetActiveViewTab">
                                <RVTabPanel TabId="basic" IsActive='activeViewTab == "basic"'>
                                    <div class="detail-section">
                                        <div class="detail-card">
                                            <div class="card-header">
                                                <h4><i class="fa-light fa-info-circle"></i> Basic Information</h4>
                                            </div>
                                            <div class="card-body">
                                                <div class="detail-row">
                                                    <div class="detail-label"><i class="fa-light fa-building"></i> Company Name</div>
                                                    <div class="detail-value">@CompanyModel.Name</div>
                                                </div>
                                                <div class="detail-row">
                                                    <div class="detail-label"><i class="fa-light fa-id-card"></i> Registration Number</div>
                                                    <div class="detail-value">@CompanyModel.RegistrationNumber</div>
                                                </div>
                                                <div class="detail-row">
                                                    <div class="detail-label"><i class="fa-light fa-receipt"></i> VAT Number</div>
                                                    <div class="detail-value">@(string.IsNullOrEmpty(CompanyModel.VatNumber) ? "Not provided" : CompanyModel.VatNumber)</div>
                                                </div>
                                                <div class="detail-row">
                                                    <div class="detail-label"><i class="fa-light fa-globe"></i> Website</div>
                                                    <div class="detail-value">
                                                        @if (!string.IsNullOrEmpty(CompanyModel.Website))
                                                        {
                                                            <a href="@CompanyModel.Website" target="_blank">@CompanyModel.Website</a>
                                                        }
                                                        else
                                                        {
                                                            <span>Not provided</span>
                                                        }
                                                    </div>
                                                </div>
                                                <div class="detail-row">
                                                    <div class="detail-label"><i class="fa-light fa-toggle-on"></i> Status</div>
                                                    <div class="detail-value">
                                                        <span class="status-badge @(CompanyModel.IsActive ? "status-active" : "status-inactive")">
                                                            <i class="fa-light fa-@(CompanyModel.IsActive ? "check-circle" : "times-circle")"></i>
                                                            @(CompanyModel.IsActive ? "Active" : "Inactive")
                                                        </span>
                                                        @if (CompanyModel.Status != null)
                                                        {
                                                            <span class="status-badge">@CompanyModel.Status.Name</span>
                                                        }
                                                    </div>
                                                </div>
                                                <div class="detail-row">
                                                    <div class="detail-label"><i class="fa-light fa-gem"></i> Subscription Plan</div>
                                                    <div class="detail-value">
                                                        @if (CompanyModel.SubscriptionPlan != null)
                                                        {
                                                            <span>@CompanyModel.SubscriptionPlan.Name - $@CompanyModel.SubscriptionPlan.Price/@CompanyModel.SubscriptionPlan.BillingCycleDays days</span>
                                                        }
                                                        else
                                                        {
                                                            <span>No subscription plan selected</span>
                                                        }
                                                    </div>
                                                </div>
                                                @if (CompanyModel.MaxUsers.HasValue)
                                                {
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-users"></i> Max Users</div>
                                                        <div class="detail-value">@CompanyModel.MaxUsers</div>
                                                    </div>
                                                }
                                                @if (CompanyModel.MaxProperties.HasValue)
                                                {
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-home"></i> Max Properties</div>
                                                        <div class="detail-value">@CompanyModel.MaxProperties</div>
                                                    </div>
                                                }
                                                @if (CompanyModel.MaxBranches.HasValue)
                                                {
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-network-wired"></i> Max Branches</div>
                                                        <div class="detail-value">@CompanyModel.MaxBranches</div>
                                                    </div>
                                                }
                                                @if (CompanyModel.SubscriptionStartDate.HasValue)
                                                {
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-calendar-day"></i> Subscription Start</div>
                                                        <div class="detail-value">@CompanyModel.SubscriptionStartDate?.ToString("dd MMM yyyy")</div>
                                                    </div>
                                                }
                                                @if (CompanyModel.SubscriptionEndDate.HasValue)
                                                {
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-calendar-times"></i> Subscription End</div>
                                                        <div class="detail-value">@CompanyModel.SubscriptionEndDate?.ToString("dd MMM yyyy")</div>
                                                    </div>
                                                }
                                                @if (CompanyModel.IsTrialPeriod)
                                                {
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-hourglass-half"></i> Trial Period</div>
                                                        <div class="detail-value">Yes</div>
                                                    </div>
                                                }
                                                @if (CompanyModel.CreatedOn != default)
                                                {
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-calendar-plus"></i> Created On</div>
                                                        <div class="detail-value">@CompanyModel.CreatedOn.ToString("dd MMM yyyy, HH:mm")</div>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(CompanyModel.CreatedBy))
                                                {
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-user"></i> Created By</div>
                                                        <div class="detail-value">@CompanyModel.CreatedBy</div>
                                                    </div>
                                                }
                                                @if (CompanyModel.UpdatedDate.HasValue)
                                                {
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-calendar-edit"></i> Last Updated</div>
                                                        <div class="detail-value">@CompanyModel.UpdatedDate?.ToString("dd MMM yyyy, HH:mm")</div>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(CompanyModel.UpdatedBy))
                                                {
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-user-edit"></i> Updated By</div>
                                                        <div class="detail-value">@CompanyModel.UpdatedBy</div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </RVTabPanel>

                                <RVTabPanel TabId="contact" IsActive='activeViewTab == "contact"'>
                                    <div class="detail-section">
                                        <div class="detail-card">
                                            <div class="card-header">
                                                <h4><i class="fa-light fa-envelope"></i> Email Addresses</h4>
                                            </div>
                                            <div class="card-body">
                                                @if (CompanyModel.EmailAddresses?.Any() == true)
                                                {
                                                    <div class="contact-info">
                                                        @{
                                                            var primaryEmail = CompanyModel.EmailAddresses.FirstOrDefault(e => e.IsPrimary);
                                                        }
                                                        @if (primaryEmail != null)
                                                        {
                                                            <div class="detail-row">
                                                                <div class="detail-label"><i class="fa-light fa-envelope"></i> Primary Email</div>
                                                                <div class="detail-value email-value">
                                                                    <a href="mailto:@primaryEmail.EmailAddress"><i class="fa-light fa-envelope"></i> @primaryEmail.EmailAddress</a>
                                                                </div>
                                                            </div>
                                                        }

                                                        @foreach (var email in CompanyModel.EmailAddresses.Where(e => !e.IsPrimary).OrderBy(e => e.Description))
                                                        {
                                                            <div class="detail-row">
                                                                <div class="detail-label">
                                                                    <i class="fa-light fa-tag"></i>
                                                                    @(!string.IsNullOrEmpty(email.Description) ? email.Description : "Email")
                                                                </div>
                                                                <div class="detail-value email-value">
                                                                    <a href="mailto:@email.EmailAddress"><i class="fa-light fa-envelope"></i> @email.EmailAddress</a>
                                                                    @if (!email.IsActive)
                                                                    {
                                                                        <span class="status-badge status-inactive">
                                                                            <i class="fa-light fa-times-circle"></i> Inactive
                                                                        </span>
                                                                    }
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-message">
                                                        <i class="fa-light fa-envelope-open"></i>
                                                        <p>No email addresses provided</p>
                                                    </div>
                                                }
                                            </div>
                                        </div>

                                        <div class="detail-card">
                                            <div class="card-header">
                                                <h4><i class="fa-light fa-phone"></i> Contact Numbers</h4>
                                            </div>
                                            <div class="card-body">
                                                @if (CompanyModel.ContactNumbers?.Any() == true)
                                                {
                                                    <div class="contact-info">
                                                        @{
                                                            var primaryContact = CompanyModel.ContactNumbers.FirstOrDefault(c => c.IsPrimary);
                                                        }
                                                        @if (primaryContact != null)
                                                        {
                                                            <div class="detail-row">
                                                                <div class="detail-label"><i class="fa-light fa-phone"></i> Primary Contact</div>
                                                                <div class="detail-value phone-value">
                                                                    <a href="tel:@primaryContact.Number"><i class="fa-light fa-phone"></i> @primaryContact.Number</a>
                                                                </div>
                                                            </div>
                                                        }

                                                        @foreach (var phone in CompanyModel.ContactNumbers.Where(c => !c.IsPrimary).OrderBy(c => c.Description))
                                                        {
                                                            <div class="detail-row">
                                                                <div class="detail-label">
                                                                    <i class="fa-light fa-tag"></i>
                                                                    @if (!string.IsNullOrEmpty(phone.Description))
                                                                    {
                                                                        @phone.Description
                                                                    }
                                                                    else if (phone.ContactNumberType != null)
                                                                    {
                                                                        @phone.ContactNumberType.Name
                                                                    }
                                                                    else
                                                                    {
                                                                        @("Phone")
                                                                    }
                                                                </div>
                                                                <div class="detail-value phone-value">
                                                                    <a href="tel:@phone.Number"><i class="fa-light fa-phone"></i> @phone.Number</a>
                                                                    @if (!phone.IsActive)
                                                                    {
                                                                        <span class="status-badge status-inactive">
                                                                            <i class="fa-light fa-times-circle"></i> Inactive
                                                                        </span>
                                                                    }
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-message">
                                                        <i class="fa-light fa-phone-slash"></i>
                                                        <p>No contact numbers provided</p>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </RVTabPanel>

                                <RVTabPanel TabId="address" IsActive='activeViewTab == "address"'>
                                    <div class="detail-section">
                                        <div class="detail-card">
                                            <div class="card-header">
                                                <h4><i class="fa-light fa-map-marker-alt"></i> Company Address</h4>
                                            </div>
                                            <div class="card-body">
                                                @if (CompanyModel.Address != null)
                                                {
                                                    <div class="address-display">
                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.ComplexName))
                                                        {
                                                            <div class="address-line"><i class="fa-light fa-building"></i> @CompanyModel.Address.ComplexName</div>
                                                        }

                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.BuildingName))
                                                        {
                                                            <div class="address-line"><i class="fa-light fa-building"></i> @CompanyModel.Address.BuildingName</div>
                                                        }

                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.UnitNumber))
                                                        {
                                                            <div class="address-line"><i class="fa-light fa-door-closed"></i> Unit @CompanyModel.Address.UnitNumber</div>
                                                        }

                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.Street))
                                                        {
                                                            <div class="address-line"><i class="fa-light fa-road"></i> @CompanyModel.Address.Street</div>
                                                        }

                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.Suburb))
                                                        {
                                                            <div class="address-line"><i class="fa-light fa-map"></i> @CompanyModel.Address.Suburb</div>
                                                        }

                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.City))
                                                        {
                                                            <div class="address-line">
                                                                <i class="fa-light fa-city"></i>
                                                                @CompanyModel.Address.City@(!string.IsNullOrEmpty(CompanyModel.Address.Province) ? $", {CompanyModel.Address.Province}" : "")
                                                            </div>
                                                        }

                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.PostalCode))
                                                        {
                                                            <div class="address-line"><i class="fa-light fa-mailbox"></i> @CompanyModel.Address.PostalCode</div>
                                                        }

                                                        @if (!string.IsNullOrEmpty(CompanyModel.Address.Country))
                                                        {
                                                            <div class="address-line"><i class="fa-light fa-globe"></i> @CompanyModel.Address.Country</div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-message">
                                                        <i class="fa-light fa-map-marker-slash"></i>
                                                        <p>No address information provided</p>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </RVTabPanel>

                                <RVTabPanel TabId="banking" IsActive='activeViewTab == "banking"'>
                                    <div class="detail-section">
                                        <div class="detail-card">
                                            <div class="card-header">
                                                <h4><i class="fa-light fa-university"></i> Banking Details</h4>
                                            </div>
                                            <div class="card-body">
                                                @if (CompanyModel.BankAccount != null && !string.IsNullOrEmpty(CompanyModel.BankAccount.AccountNumber))
                                                {
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-university"></i> Bank Name</div>
                                                        <div class="detail-value">@(CompanyModel.BankAccount.BankName?.Name ?? "Not set")</div>
                                                    </div>
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-credit-card"></i> Account Type</div>
                                                        <div class="detail-value">@(CompanyModel.BankAccount.AccountType ?? "Not set")</div>
                                                    </div>
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-hashtag"></i> Account Number</div>
                                                        <div class="detail-value">@CompanyModel.BankAccount.AccountNumber</div>
                                                    </div>
                                                    <div class="detail-row">
                                                        <div class="detail-label"><i class="fa-light fa-code"></i> Branch Code</div>
                                                        <div class="detail-value">@CompanyModel.BankAccount.BranchCode</div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-message">
                                                        <i class="fa-light fa-credit-card-blank"></i>
                                                        <p>No banking details provided</p>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </RVTabPanel>

                                <RVTabPanel TabId="branding" IsActive='activeViewTab == "branding"'>
                                    <div class="detail-section">
                                        <div class="detail-card">
                                            <div class="card-header">
                                                <h4><i class="fa-light fa-image"></i> Company Logo</h4>
                                            </div>
                                            <div class="card-body">
                                                @if (CompanyModel.MainLogoId.HasValue && CompanyModel.MainLogo != null)
                                                {
                                                    <div class="logo-display">
                                                        <div class="logo-container">
                                                            <img src="@CompanyModel.MainLogo.Url" alt="@CompanyModel.Name Logo" class="logo-image" />
                                                        </div>
                                                        <div class="logo-info">
                                                            <div class="logo-title">@CompanyModel.MainLogo.FileName</div>
                                                            <div class="logo-meta">
                                                                <span><i class="fa-light fa-file-image"></i> @CompanyModel.MainLogo.ContentType</span>
                                                                <span><i class="fa-light fa-weight"></i> @((CompanyModel.MainLogo.FileSize / 1024).ToString("N0")) KB</span>
                                                                <span><i class="fa-light fa-calendar"></i> @CompanyModel.MainLogo.UploadDate.ToString("dd MMM yyyy")</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-message">
                                                        <i class="fa-light fa-file-image"></i>
                                                        <p>No logo uploaded</p>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </RVTabPanel>

                                <RVTabPanel TabId="branches" IsActive='activeViewTab == "branches"'>
                                    <div class="detail-section">
                                        <div class="detail-card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h4><i class="fa-light fa-network-wired"></i> Company Branches</h4>
                                                @if (CanEdit)
                                                {
                                                    <RVButton ButtonType="outline-primary" Size="sm" IconLeft="fa-light fa-plus"
                                                    Text="Add Branch" OnClick="() => OnAddBranch.InvokeAsync(CompanyModel)" />
                                                }
                                            </div>
                                            <div class="card-body">
                                                @if (CompanyModel.Branches?.Any() == true)
                                                {
                                                    <div class="branches-list">
                                                        @foreach (var branch in CompanyModel.Branches.OrderBy(b => b.Name))
                                                        {
                                                            <div class="branch-item @(branch.IsActive ? "" : "inactive")">
                                                                <div class="branch-icon">
                                                                    @if (branch.MainLogoId.HasValue && branch.MainLogo != null)
                                                                    {
                                                                        <img src="@branch.MainLogo.Url" alt="@branch.Name" class="branch-logo-sm" />
                                                                    }
                                                                    else
                                                                    {
                                                                        <i class="fa-light fa-code-branch"></i>
                                                                    }
                                                                </div>
                                                                <div class="branch-details">
                                                                    <div class="branch-name">
                                                                        @branch.Name
                                                                        @if (branch.IsHeadOffice)
                                                                        {
                                                                            <span class="badge-pill bg-primary"><i class="fa-light fa-star"></i> Head Office</span>
                                                                        }
                                                                    </div>
                                                                    <div class="branch-contact">
                                                                        @if (!string.IsNullOrEmpty(branch.PrimaryEmail))
                                                                        {
                                                                            <a href="mailto:@branch.PrimaryEmail" class="branch-email"><i class="fa-light fa-envelope"></i> @branch.PrimaryEmail</a>
                                                                        }
                                                                        @if (!string.IsNullOrEmpty(branch.PrimaryContactNumber))
                                                                        {
                                                                            <a href="tel:@branch.PrimaryContactNumber" class="branch-phone"><i class="fa-light fa-phone"></i> @branch.PrimaryContactNumber</a>
                                                                        }
                                                                    </div>
                                                                </div>
                                                                <div class="branch-status">
                                                                    <span class="status-indicator @(branch.IsActive ? "active" : "inactive")"></span>
                                                                </div>
                                                                <div class="branch-actions">
                                                                    <RVButton ButtonType="outline" Size="xs" IconLeft="fa-light fa-eye"
                                                                    OnClick="() => OnViewBranch.InvokeAsync(branch)" CssClass="view-branch-btn" />
                                                                    @if (CanEdit)
                                                                    {
                                                                        <RVButton ButtonType="outline" Size="xs" IconLeft="fa-light fa-edit"
                                                                        OnClick="() => OnEditBranch.InvokeAsync(branch)" CssClass="edit-branch-btn" />
                                                                    }
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-message">
                                                        <i class="fa-light fa-network-wired"></i>
                                                        <p>No branches added to this company</p>
                                                        @if (CanEdit)
                                                        {
                                                            <RVButton ButtonType="primary" Size="sm" IconLeft="fa-light fa-plus"
                                                            Text="Add Branch" OnClick="() => OnAddBranch.InvokeAsync(CompanyModel)" />
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </RVTabPanel>
                            </RVTab>
                        </div>

                        <div class="company-details-footer">
                            <RVButton ButtonType="outline" IconLeft="fa-light fa-times" Text="Close" OnClick="OnCancel" />
                            @if (CanEdit)
                            {
                                <RVButton ButtonType="primary" IconLeft="fa-light fa-edit" Text="Edit Company" OnClick="SwitchToEditMode" />
                            }
                        </div>
                    </div>
                }
                else if (IsEditMode)
                {
                    <EditForm Model="CompanyModel" OnValidSubmit="Save" FormName="editCompany" class="company-edit-form">
                        <DataAnnotationsValidator />
                        <Roovia.Components.Elements.Forms.FluentValidationValidator />

                        <RVTab Tabs="formTabs" Size="sm" OnTabChange="HandleTabChange">
                            <RVTabPanel TabId="basic" IsActive='activeTab == "basic"'>
                                <div class="form-section">
                                    <div class="section-title">
                                        <h4><i class="fa-light fa-building"></i> Basic Information</h4>
                                        <p>Enter the basic details for this company</p>
                                    </div>

                                    <div class="form-group">
                                        <label for="name">Company Name *</label>
                                        <RVTextbox Id="name"
                                        Value="@CompanyModel.Name"
                                        ValueChanged="value => CompanyModel.Name = value"
                                        Placeholder="Enter company name"
                                        IconLeft="fa-light fa-building" />
                                        <ValidationMessage For="@(() => CompanyModel.Name)" />
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="registrationNumber">Registration Number *</label>
                                            <RVTextbox Id="registrationNumber"
                                            Value="@CompanyModel.RegistrationNumber"
                                            ValueChanged="value => CompanyModel.RegistrationNumber = value"
                                            Placeholder="Enter registration number"
                                            IconLeft="fa-light fa-id-card" />
                                            <ValidationMessage For="@(() => CompanyModel.RegistrationNumber)" />
                                        </div>

                                        <div class="form-group">
                                            <label for="vatNumber">VAT Number</label>
                                            <RVTextbox Id="vatNumber"
                                            Value="@CompanyModel.VatNumber"
                                            ValueChanged="value => CompanyModel.VatNumber = value"
                                            Placeholder="Enter VAT number (optional)"
                                            IconLeft="fa-light fa-receipt" />
                                            <ValidationMessage For="@(() => CompanyModel.VatNumber)" />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="website">Website</label>
                                        <RVTextbox Id="website"
                                        Value="@CompanyModel.Website"
                                        ValueChanged="value => CompanyModel.Website = value"
                                        Placeholder="Enter website URL (optional)"
                                        IconLeft="fa-light fa-globe" />
                                        <ValidationMessage For="@(() => CompanyModel.Website)" />
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="status">Status</label>
                                            <RVSelect Id="status"
                                            Value="@(CompanyModel.StatusId?.ToString() ?? "")"
                                            ValueChanged="value => UpdateStatus(value)"
                                            Placeholder="Select status"
                                            IconLeft="fa-light fa-toggle-on">
                                                <option value="">-- Select Status --</option>
                                                @if (CompanyStatusTypes != null)
                                                {
                                                    @foreach (var status in CompanyStatusTypes.OrderBy(s => s.DisplayOrder))
                                                    {
                                                        <option value="@status.Id">@status.Name</option>
                                                    }
                                                }
                                            </RVSelect>
                                        </div>

                                        <div class="form-group">
                                            <label for="subscription">Subscription Plan</label>
                                            <RVSelect Id="subscription"
                                            Value="@(CompanyModel.SubscriptionPlanId?.ToString() ?? "")"
                                            ValueChanged="value => UpdateSubscriptionPlan(value)"
                                            Placeholder="Select subscription plan"
                                            IconLeft="fa-light fa-gem">
                                                <option value="">-- Select Plan --</option>
                                                @if (SubscriptionPlans != null)
                                                {
                                                    @foreach (var plan in SubscriptionPlans.OrderBy(p => p.Price))
                                                    {
                                                        <option value="@plan.Id">@plan.Name - $@plan.Price/@plan.BillingCycleDays days</option>
                                                    }
                                                }
                                            </RVSelect>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="maxUsers">Max Users</label>
                                            <RVTextbox Id="maxUsers"
                                            Type="number"
                                            Value="@(CompanyModel.MaxUsers?.ToString() ?? "")"
                                            ValueChanged="value => CompanyModel.MaxUsers = string.IsNullOrEmpty(value) ? null : int.Parse(value)"
                                            Placeholder="Maximum users allowed"
                                            IconLeft="fa-light fa-users" />
                                        </div>

                                        <div class="form-group">
                                            <label for="maxProperties">Max Properties</label>
                                            <RVTextbox Id="maxProperties"
                                            Type="number"
                                            Value="@(CompanyModel.MaxProperties?.ToString() ?? "")"
                                            ValueChanged="value => CompanyModel.MaxProperties = string.IsNullOrEmpty(value) ? null : int.Parse(value)"
                                            Placeholder="Maximum properties allowed"
                                            IconLeft="fa-light fa-home" />
                                        </div>

                                        <div class="form-group">
                                            <label for="maxBranches">Max Branches</label>
                                            <RVTextbox Id="maxBranches"
                                            Type="number"
                                            Value="@(CompanyModel.MaxBranches?.ToString() ?? "")"
                                            ValueChanged="value => CompanyModel.MaxBranches = string.IsNullOrEmpty(value) ? null : int.Parse(value)"
                                            Placeholder="Maximum branches allowed"
                                            IconLeft="fa-light fa-network-wired" />
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="subscriptionStartDate">Subscription Start Date</label>
                                            <RVDatetime Id="subscriptionStartDate"
                                            Value="@CompanyModel.SubscriptionStartDate"
                                            ValueChanged="value => CompanyModel.SubscriptionStartDate = value"
                                            Placeholder="Select start date"
                                            IconLeft="fa-light fa-calendar-day" />
                                        </div>

                                        <div class="form-group">
                                            <label for="subscriptionEndDate">Subscription End Date</label>
                                            <RVDatetime Id="subscriptionEndDate"
                                            Value="@CompanyModel.SubscriptionEndDate"
                                            ValueChanged="value => CompanyModel.SubscriptionEndDate = value"
                                            Placeholder="Select end date"
                                            IconLeft="fa-light fa-calendar-times"
                                            MinDate="@(CompanyModel.SubscriptionStartDate ?? DateTime.Now)" />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <RVSwitch Label="Active"
                                        Value="CompanyModel.IsActive"
                                        ValueChanged="value => CompanyModel.IsActive = value"
                                        HelperText="Inactive companies will not be accessible to users" />
                                    </div>

                                    <div class="form-group">
                                        <RVSwitch Label="Trial Period"
                                        Value="CompanyModel.IsTrialPeriod"
                                        ValueChanged="value => CompanyModel.IsTrialPeriod = value"
                                        HelperText="Mark this company as being in a trial period" />
                                    </div>
                                </div>
                            </RVTabPanel>

                            <RVTabPanel TabId="contact" IsActive='activeTab == "contact"'>
                                <div class="form-section">
                                    <div class="section-title">
                                        <h4><i class="fa-light fa-address-book"></i> Contact Information</h4>
                                        <p>Manage the company's contact details</p>
                                    </div>

                                    <!-- Primary Email -->
                                    <div class="form-group">
                                        <label for="primaryEmail">Primary Email Address</label>
                                        <RVTextbox Id="primaryEmail"
                                        Type="email"
                                        Value="@GetPrimaryEmail()"
                                        ValueChanged="UpdatePrimaryEmail"
                                        Placeholder="Enter primary email address"
                                        IconLeft="fa-light fa-envelope" />
                                    </div>

                                    <!-- Primary Phone -->
                                    <div class="form-group">
                                        <label for="primaryPhone">Primary Phone Number</label>
                                        <RVTextbox Id="primaryPhone"
                                        Type="tel"
                                        Value="@GetPrimaryPhone()"
                                        ValueChanged="UpdatePrimaryPhone"
                                        Placeholder="Enter primary phone number"
                                        IconLeft="fa-light fa-phone" />
                                    </div>

                                    <!-- Additional Email Addresses Section -->
                                    <div class="additional-contacts">
                                        <div class="section-subtitle">
                                            <h5><i class="fa-light fa-envelope"></i> Additional Email Addresses</h5>
                                            <RVButton ButtonType="outline" Size="xs" IconLeft="fa-light fa-plus" Text="Add Email"
                                            OnClick="AddEmail" CssClass="add-btn" />
                                        </div>

                                        @if (CompanyModel.EmailAddresses?.Where(e => !e.IsPrimary).Any() == true)
                                        {
                                            <div class="email-list">
                                                @foreach (var email in CompanyModel.EmailAddresses.Where(e => !e.IsPrimary))
                                                {
                                                    <div class="email-item">
                                                        <div class="email-content">
                                                            <RVTextbox Value="@email.EmailAddress"
                                                            ValueChanged="value => UpdateEmailAddress(email, value)"
                                                            Placeholder="Enter email address"
                                                            IconLeft="fa-light fa-envelope"
                                                            Size="sm" />
                                                            <RVTextbox Value="@email.Description"
                                                            ValueChanged="value => UpdateEmailDescription(email, value)"
                                                            Placeholder="Description (e.g. Sales, Support)"
                                                            IconLeft="fa-light fa-tag"
                                                            Size="sm" />
                                                        </div>
                                                        <RVButton ButtonType="outline-danger" Size="xs" IconLeft="fa-light fa-trash"
                                                        OnClick="() => RemoveEmail(email)" CssClass="remove-btn" />
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="empty-list">
                                                <i class="fa-light fa-inbox"></i>
                                                <p>No additional email addresses</p>
                                            </div>
                                        }
                                    </div>

                                    <!-- Additional Phone Numbers Section -->
                                    <div class="additional-contacts">
                                        <div class="section-subtitle">
                                            <h5><i class="fa-light fa-phone"></i> Additional Phone Numbers</h5>
                                            <RVButton ButtonType="outline" Size="xs" IconLeft="fa-light fa-plus" Text="Add Phone"
                                            OnClick="AddPhone" CssClass="add-btn" />
                                        </div>

                                        @if (CompanyModel.ContactNumbers?.Where(c => !c.IsPrimary).Any() == true)
                                        {
                                            <div class="phone-list">
                                                @foreach (var phone in CompanyModel.ContactNumbers.Where(c => !c.IsPrimary))
                                                {
                                                    <div class="phone-item">
                                                        <div class="phone-content">
                                                            <RVTextbox Value="@phone.Number"
                                                            ValueChanged="value => UpdatePhoneNumber(phone, value)"
                                                            Placeholder="Enter phone number"
                                                            IconLeft="fa-light fa-phone"
                                                            Size="sm" />
                                                            <RVSelect Value="@(phone.ContactNumberTypeId.ToString())"
                                                            ValueChanged="value => UpdatePhoneTypeId(phone, value)"
                                                            Placeholder="Select type"
                                                            IconLeft="fa-light fa-phone-office"
                                                            Size="sm">
                                                                @if (contactNumberTypes != null)
                                                                {
                                                                    @foreach (var type in contactNumberTypes)
                                                                    {
                                                                        <option value="@type.Id">@type.Name</option>
                                                                    }
                                                                }
                                                            </RVSelect>
                                                            <RVTextbox Value="@phone.Description"
                                                            ValueChanged="value => UpdatePhoneDescription(phone, value)"
                                                            Placeholder="Description"
                                                            IconLeft="fa-light fa-tag"
                                                            Size="sm" />
                                                        </div>
                                                        <RVButton ButtonType="outline-danger" Size="xs" IconLeft="fa-light fa-trash"
                                                        OnClick="() => RemovePhone(phone)" CssClass="remove-btn" />
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="empty-list">
                                                <i class="fa-light fa-phone-slash"></i>
                                                <p>No additional phone numbers</p>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </RVTabPanel>

                            <RVTabPanel TabId="address" IsActive='activeTab == "address"'>
                                <div class="form-section">
                                    <div class="section-title">
                                        <h4><i class="fa-light fa-map-marker-alt"></i> Address Information</h4>
                                        <p>Enter the company's address details</p>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-12">
                                            <label for="street">Street</label>
                                            <RVTextbox Id="street"
                                            Value="@CompanyModel.Address.Street"
                                            ValueChanged="value => CompanyModel.Address.Street = value"
                                            Placeholder="Enter street address"
                                            IconLeft="fa-light fa-road" />
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label for="unitNumber">Unit Number</label>
                                            <RVTextbox Id="unitNumber"
                                            Value="@CompanyModel.Address.UnitNumber"
                                            ValueChanged="value => CompanyModel.Address.UnitNumber = value"
                                            Placeholder="Unit number"
                                            IconLeft="fa-light fa-door-closed" />
                                        </div>

                                        <div class="form-group col-md-8">
                                            <label for="complexName">Complex Name</label>
                                            <RVTextbox Id="complexName"
                                            Value="@CompanyModel.Address.ComplexName"
                                            ValueChanged="value => CompanyModel.Address.ComplexName = value"
                                            Placeholder="Complex name"
                                            IconLeft="fa-light fa-building" />
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-12">
                                            <label for="buildingName">Building Name</label>
                                            <RVTextbox Id="buildingName"
                                            Value="@CompanyModel.Address.BuildingName"
                                            ValueChanged="value => CompanyModel.Address.BuildingName = value"
                                            Placeholder="Building name"
                                            IconLeft="fa-light fa-building" />
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="suburb">Suburb</label>
                                            <RVTextbox Id="suburb"
                                            Value="@CompanyModel.Address.Suburb"
                                            ValueChanged="value => CompanyModel.Address.Suburb = value"
                                            Placeholder="Enter suburb"
                                            IconLeft="fa-light fa-map" />
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="city">City</label>
                                            <RVTextbox Id="city"
                                            Value="@CompanyModel.Address.City"
                                            ValueChanged="value => CompanyModel.Address.City = value"
                                            Placeholder="Enter city"
                                            IconLeft="fa-light fa-city" />
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="province">Province</label>
                                            <RVTextbox Id="province"
                                            Value="@CompanyModel.Address.Province"
                                            ValueChanged="value => CompanyModel.Address.Province = value"
                                            Placeholder="Enter province"
                                            IconLeft="fa-light fa-map-marked" />
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="postalCode">Postal Code</label>
                                            <RVTextbox Id="postalCode"
                                            Value="@CompanyModel.Address.PostalCode"
                                            ValueChanged="value => CompanyModel.Address.PostalCode = value"
                                            Placeholder="Enter postal code"
                                            IconLeft="fa-light fa-mailbox" />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="country">Country</label>
                                        <RVTextbox Id="country"
                                        Value="@CompanyModel.Address.Country"
                                        ValueChanged="value => CompanyModel.Address.Country = value"
                                        Placeholder="Enter country"
                                        IconLeft="fa-light fa-globe" />
                                    </div>
                                </div>
                            </RVTabPanel>

                            <!-- Banking Details Tab -->
                            <RVTabPanel TabId="banking" IsActive='activeTab == "banking"'>
                                <div class="form-section">
                                    <div class="section-title">
                                        <h4><i class="fa-light fa-university"></i> Banking Details</h4>
                                        <p>Enter the company's banking information for invoicing and payments</p>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="bankNameId">Bank Name</label>
                                            <RVSelect Id="bankNameId"
                                            Value="@(CompanyModel.BankAccount.BankNameId?.ToString() ?? "")"
                                            ValueChanged="value => UpdateBankNameId(value)"
                                            Placeholder="Select bank"
                                            IconLeft="fa-light fa-university">
                                                <option value="">-- Select Bank --</option>
                                                @if (bankNameTypes != null)
                                                {
                                                    @foreach (var bank in bankNameTypes.OrderBy(b => b.Name))
                                                    {
                                                        <option value="@bank.Id">@bank.Name</option>
                                                    }
                                                }
                                            </RVSelect>
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="accountType">Account Type</label>
                                            <RVTextbox Id="accountType"
                                            Value="@CompanyModel.BankAccount.AccountType"
                                            ValueChanged="value => CompanyModel.BankAccount.AccountType = value"
                                            Placeholder="E.g. Current, Savings, Business"
                                            IconLeft="fa-light fa-credit-card" />
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="accountNumber">Account Number</label>
                                            <RVTextbox Id="accountNumber"
                                            Value="@CompanyModel.BankAccount.AccountNumber"
                                            ValueChanged="value => CompanyModel.BankAccount.AccountNumber = value"
                                            Placeholder="Enter account number"
                                            IconLeft="fa-light fa-hashtag" />
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="branchCode">Branch Code</label>
                                            <RVTextbox Id="branchCode"
                                            Value="@CompanyModel.BankAccount.BranchCode"
                                            ValueChanged="value => CompanyModel.BankAccount.BranchCode = value"
                                            Placeholder="Enter branch code"
                                            IconLeft="fa-light fa-code" />
                                        </div>
                                    </div>
                                </div>
                            </RVTabPanel>

                            <RVTabPanel TabId="logo" IsActive='activeTab == "logo"'>
                                <div class="form-section">
                                    <div class="section-title">
                                        <h4><i class="fa-light fa-image"></i> Company Logo</h4>
                                        <p>Upload your company logo</p>
                                    </div>

                                    <div class="logo-upload-section">
                                        <div class="current-logo">
                                            <h5>Current Logo</h5>
                                            @if (CompanyModel.MainLogoId.HasValue && CompanyModel.MainLogo != null)
                                            {
                                                <div class="logo-preview">
                                                    <img src="@CompanyModel.MainLogo.Url" alt="Company Logo" class="logo-image" />
                                                </div>
                                                <div class="logo-actions mt-2">
                                                    <RVButton ButtonType="outline-danger" Size="sm" IconLeft="fa-light fa-trash"
                                                    Text="Remove Logo" OnClick="RemoveLogo" />
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="empty-logo">
                                                    <i class="fa-light fa-image fa-3x"></i>
                                                    <p>No logo uploaded yet</p>
                                                </div>
                                            }
                                        </div>

                                        <div class="upload-area">
                                            <h5>Upload New Logo</h5>
                                            <InputFile OnChange="OnLogoInputChange" class="upload-input" accept="image/*" />
                                            <div class="upload-placeholder @(isUploading ? "d-none" : "")">
                                                <i class="fa-light fa-cloud-upload fa-2x"></i>
                                                <p>Drag and drop your logo here, or click to browse</p>
                                                <span class="file-hint">Recommended size: 512x512px, JPG or PNG format</span>
                                            </div>
                                            @if (isUploading)
                                            {
                                                <div class="upload-progress">
                                                    <div class="loading-spinner sm"></div>
                                                    <span>Uploading logo... @uploadProgress%</span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(logoPreview))
                                            {
                                                <div class="logo-preview-new">
                                                    <img src="@logoPreview" alt="New Logo Preview" class="preview-image" />
                                                    <div class="preview-actions">
                                                        <RVButton ButtonType="outline-danger" Size="sm" IconLeft="fa-light fa-times"
                                                        Text="Remove" OnClick="CancelLogoUpload" />
                                                        <RVButton ButtonType="primary" Size="sm" IconLeft="fa-light fa-check"
                                                        Text="Use This Logo" OnClick="ApplyLogo" />
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </RVTabPanel>
                        </RVTab>

                        <div class="company-edit-footer">
                            <RVButton ButtonType="outline" IconLeft="fa-light fa-times" Text="Cancel" OnClick="OnCancel" />
                            <RVButton ButtonType="primary" IconLeft="fa-light fa-save" Text="Save Changes" Type="submit" />
                        </div>
                    </EditForm>
                }
            </div>
        }
    </ChildContent>
</RVModal>

@code {
    [Parameter] public Company CompanyModel { get; set; } = new Company();
    [Parameter] public IEnumerable<CompanyStatusType>? CompanyStatusTypes { get; set; }
    [Parameter] public IEnumerable<SubscriptionPlan>? SubscriptionPlans { get; set; }
    [Parameter] public List<BankNameType>? bankNameTypes { get; set; }
    [Parameter] public List<ContactNumberType>? contactNumberTypes { get; set; }
    [Parameter] public bool IsEdit { get; set; } = false;
    [Parameter] public bool IsView { get; set; } = false;
    [Parameter] public bool CanEdit { get; set; } = true;
    [Parameter] public EventCallback<Company> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<Company> OnAddBranch { get; set; }
    [Parameter] public EventCallback<Branch> OnViewBranch { get; set; }
    [Parameter] public EventCallback<Branch> OnEditBranch { get; set; }

    private bool isLoading = false;
    private string activeTab = "basic";
    private string activeViewTab = "basic";
    private bool IsEditMode => (IsEdit || isInEditMode) && !IsView;
    private bool isInEditMode = false;
    private bool IsViewMode => IsView || !IsEditMode;

    // Logo handling
    private string logoPreview = string.Empty;
    private IBrowserFile? logoFile;
    private bool isUploading = false;
    private int uploadProgress = 0;
    private long maxFileSize = 1024 * 1024 * 5; // 5MB

    // Form tabs
    private List<RVTab.RVTabItem> formTabs = new List<RVTab.RVTabItem>
    {
        new RVTab.RVTabItem { Id = "basic", Title = "Basic Information", Icon = "fa-light fa-building", IsActive = true },
        new RVTab.RVTabItem { Id = "contact", Title = "Contact Details", Icon = "fa-light fa-address-card" },
        new RVTab.RVTabItem { Id = "address", Title = "Address", Icon = "fa-light fa-map-marker-alt" },
        new RVTab.RVTabItem { Id = "banking", Title = "Banking Details", Icon = "fa-light fa-university" },
        new RVTab.RVTabItem { Id = "logo", Title = "Company Logo", Icon = "fa-light fa-image" }
    };

    protected override async Task OnInitializedAsync()
    {
        // Load reference data if not provided
        if (contactNumberTypes == null || bankNameTypes == null)
        {
            await LoadReferenceData();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (CompanyModel.Id != 0)
            {
                await LoadCompanyData();
            }
            else
            {
                InitializeNewCompany();
            }

            // For new companies, start in edit mode
            if (CompanyModel.Id == 0)
            {
                isInEditMode = true;
            }
            else if (IsView)
            {
                isInEditMode = false;
            }

            await InvokeAsync(() => this.StateHasChanged());
        }
    }

    private async Task LoadReferenceData()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            
            if (contactNumberTypes == null)
            {
                contactNumberTypes = await context.ContactNumberTypes
                    .Where(t => t.IsActive)
                    .OrderBy(t => t.DisplayOrder)
                    .ToListAsync();
            }
            
            if (bankNameTypes == null)
            {
                bankNameTypes = await context.BankNameTypes
                    .Where(b => b.IsActive)
                    .OrderBy(b => b.DisplayOrder)
                    .ToListAsync();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading reference data: {ex.Message}", "Error");
        }
    }

    private void InitializeNewCompany()
    {
        CompanyModel = new Company
            {
                IsActive = true,
                Address = new Address { Country = "South Africa" },
                BankAccount = new BankAccount(),
                EmailAddresses = new List<Email>(),
                ContactNumbers = new List<ContactNumber>(),
                Branches = new List<Branch>(),
                CreatedOn = DateTime.Now
            };
    }

    private async Task LoadCompanyData()
    {
        isLoading = true;

        try
        {
            var response = await UserService.GetCompanyWithDetails(CompanyModel.Id);
            if (response.ResponseInfo.Success)
            {
                CompanyModel = (Company)response.Response;

                // Initialize collections if null
                if (CompanyModel.EmailAddresses == null)
                    CompanyModel.EmailAddresses = new List<Email>();
                if (CompanyModel.ContactNumbers == null)
                    CompanyModel.ContactNumbers = new List<ContactNumber>();
                if (CompanyModel.Branches == null)
                    CompanyModel.Branches = new List<Branch>();

                // Initialize bank account if null
                if (CompanyModel.BankAccount == null)
                {
                    CompanyModel.BankAccount = new BankAccount();
                }

                // Load the logo if there's one
                if (CompanyModel.MainLogoId.HasValue)
                {
                    using var context = await DbContextFactory.CreateDbContextAsync();
                    CompanyModel.MainLogo = await context.CdnFileMetadata
                        .FirstOrDefaultAsync(f => f.Id == CompanyModel.MainLogoId.Value);
                }

                // Load subscription plan if there's one
                if (CompanyModel.SubscriptionPlanId.HasValue && SubscriptionPlans != null)
                {
                    CompanyModel.SubscriptionPlan = SubscriptionPlans.FirstOrDefault(p => p.Id == CompanyModel.SubscriptionPlanId.Value);
                }

                // Load status if there's one
                if (CompanyModel.StatusId.HasValue)
                {
                    using var context = await DbContextFactory.CreateDbContextAsync();
                    CompanyModel.Status = await context.CompanyStatusTypes
                        .FirstOrDefaultAsync(s => s.Id == CompanyModel.StatusId.Value);
                }
            }
            else
            {
                ToastService.ShowError(response.ResponseInfo.Message, "Error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading company: {ex.Message}", "Error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetDialogTitle()
    {
        if (IsViewMode)
        {
            return "Company Details";
        }
        else if (CompanyModel.Id == 0)
        {
            return "Create Company";
        }
        else
        {
            return "Edit Company";
        }
    }

    private string GetDialogIcon()
    {
        if (IsViewMode)
        {
            return "fa-light fa-building";
        }
        else if (CompanyModel.Id == 0)
        {
            return "fa-light fa-building-plus";
        }
        else
        {
            return "fa-light fa-building-pen";
        }
    }

    private void SwitchToEditMode()
    {
        isInEditMode = true;
        IsView = false;
        StateHasChanged();
    }

    private void HandleTabChange(string tabId)
    {
        activeTab = tabId;
    }

    private void SetActiveViewTab(string tabId)
    {
        activeViewTab = tabId;
    }

    private async Task HandleConfirmAction()
    {
        if (IsView)
        {
            await OnCancel.InvokeAsync();
        }
        else if (IsEditMode)
        {
            await Save();
        }
        else
        {
            SwitchToEditMode();
        }
    }

    private async Task Save()
    {
        try
        {
            isLoading = true;

            if (CompanyModel.Id == 0)
            {
                // Create new company
                CompanyModel.CreatedBy = "CurrentUser"; // Will be replaced with actual current user ID by the service
                CompanyModel.CreatedOn = DateTime.Now;
            }
            else
            {
                // Update existing company
                CompanyModel.UpdatedBy = "CurrentUser"; // Will be replaced with actual current user ID by the service
                CompanyModel.UpdatedDate = DateTime.Now;
            }

            // Ensure all emails & phone numbers have RelatedEntityType and CompanyId set
            if (CompanyModel.EmailAddresses != null)
            {
                foreach (var email in CompanyModel.EmailAddresses)
                {
                    email.RelatedEntityType = "Company";
                    if (CompanyModel.Id > 0)
                    {
                        email.SetRelatedEntity("Company", CompanyModel.Id);
                    }
                }
            }

            if (CompanyModel.ContactNumbers != null)
            {
                foreach (var phone in CompanyModel.ContactNumbers)
                {
                    phone.RelatedEntityType = "Company";
                    if (CompanyModel.Id > 0)
                    {
                        phone.SetRelatedEntity("Company", CompanyModel.Id);
                    }
                }
            }

            await OnSave.InvokeAsync(CompanyModel);

            if (isInEditMode)
            {
                // If we're in "switch to edit mode" state, go back to view mode after save
                isInEditMode = false;
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving company: {ex.Message}", "Error");
        }
        finally
        {
            isLoading = false;
        }
    }

    // Status and Subscription Plan handlers
    private void UpdateStatus(string value)
    {
        if (string.IsNullOrEmpty(value))
        {
            CompanyModel.StatusId = null;
            CompanyModel.Status = null;
            return;
        }

        if (int.TryParse(value, out var statusId))
        {
            CompanyModel.StatusId = statusId;
            // Update the status object if needed
            if (CompanyStatusTypes != null)
            {
                CompanyModel.Status = CompanyStatusTypes.FirstOrDefault(s => s.Id == statusId);
            }
        }
    }

    private void UpdateSubscriptionPlan(string value)
    {
        if (string.IsNullOrEmpty(value))
        {
            CompanyModel.SubscriptionPlanId = null;
            CompanyModel.SubscriptionPlan = null;
            return;
        }

        if (int.TryParse(value, out var planId))
        {
            CompanyModel.SubscriptionPlanId = planId;
            // Update the subscription plan object
            if (SubscriptionPlans != null)
            {
                var plan = SubscriptionPlans.FirstOrDefault(p => p.Id == planId);
                CompanyModel.SubscriptionPlan = plan;
                
                // Auto-populate limits from the plan if available
                if (plan != null)
                {
                    if (plan.MaxUsers.HasValue && (!CompanyModel.MaxUsers.HasValue || CompanyModel.MaxUsers.Value == 0))
                    {
                        CompanyModel.MaxUsers = plan.MaxUsers;
                    }
                    
                    if (plan.MaxProperties.HasValue && (!CompanyModel.MaxProperties.HasValue || CompanyModel.MaxProperties.Value == 0))
                    {
                        CompanyModel.MaxProperties = plan.MaxProperties;
                    }
                    
                    if (plan.MaxBranches.HasValue && (!CompanyModel.MaxBranches.HasValue || CompanyModel.MaxBranches.Value == 0))
                    {
                        CompanyModel.MaxBranches = plan.MaxBranches;
                    }
                    
                    // Set subscription dates if not already set
                    if (!CompanyModel.SubscriptionStartDate.HasValue)
                    {
                        CompanyModel.SubscriptionStartDate = DateTime.Today;
                    }
                    
                    if (!CompanyModel.SubscriptionEndDate.HasValue && plan.BillingCycleDays > 0)
                    {
                        CompanyModel.SubscriptionEndDate = CompanyModel.SubscriptionStartDate.Value.AddDays(plan.BillingCycleDays);
                    }
                    
                    // Set trial period based on plan
                    CompanyModel.IsTrialPeriod = plan.HasTrialPeriod;
                }
            }
        }
    }

    private void UpdateBankNameId(string value)
    {
        if (string.IsNullOrEmpty(value))
        {
            CompanyModel.BankAccount.BankNameId = null;
            return;
        }

        if (int.TryParse(value, out var bankNameId))
        {
            CompanyModel.BankAccount.BankNameId = bankNameId;
            
            // Set default branch code if available
            if (bankNameTypes != null)
            {
                var bankName = bankNameTypes.FirstOrDefault(b => b.Id == bankNameId);
                if (bankName != null && !string.IsNullOrEmpty(bankName.DefaultBranchCode))
                {
                    CompanyModel.BankAccount.BranchCode = bankName.DefaultBranchCode;
                }
            }
        }
    }

    // Helper methods for email and phone management
    private string GetPrimaryEmail()
    {
        var primaryEmail = CompanyModel.EmailAddresses?.FirstOrDefault(e => e.IsPrimary);
        return primaryEmail?.EmailAddress ?? string.Empty;
    }

    private string GetPrimaryPhone()
    {
        var primaryPhone = CompanyModel.ContactNumbers?.FirstOrDefault(c => c.IsPrimary);
        return primaryPhone?.Number ?? string.Empty;
    }

    private void UpdatePrimaryEmail(string value)
    {
        if (CompanyModel.EmailAddresses == null)
        {
            CompanyModel.EmailAddresses = new List<Email>();
        }

        var primaryEmail = CompanyModel.EmailAddresses.FirstOrDefault(e => e.IsPrimary);

        if (primaryEmail != null)
        {
            primaryEmail.EmailAddress = value;
            primaryEmail.UpdatedDate = DateTime.Now;
        }
        else if (!string.IsNullOrEmpty(value))
        {
            var newEmail = new Email
                {
                    EmailAddress = value,
                    IsPrimary = true,
                    IsActive = true,
                    RelatedEntityType = "Company",
                    CreatedOn = DateTime.Now
                };

            if (CompanyModel.Id > 0)
            {
                newEmail.SetRelatedEntity("Company", CompanyModel.Id);
            }

            CompanyModel.EmailAddresses.Add(newEmail);
        }
    }

    private void UpdatePrimaryPhone(string value)
    {
        if (CompanyModel.ContactNumbers == null)
        {
            CompanyModel.ContactNumbers = new List<ContactNumber>();
        }

        var primaryPhone = CompanyModel.ContactNumbers.FirstOrDefault(c => c.IsPrimary);

        if (primaryPhone != null)
        {
            primaryPhone.Number = value;
            primaryPhone.UpdatedDate = DateTime.Now;
        }
        else if (!string.IsNullOrEmpty(value))
        {
            var newPhone = new ContactNumber
                {
                    Number = value,
                    ContactNumberTypeId = contactNumberTypes?.FirstOrDefault()?.Id ?? 1,
                    IsPrimary = true,
                    IsActive = true,
                    RelatedEntityType = "Company",
                    CreatedOn = DateTime.Now
                };

            if (CompanyModel.Id > 0)
            {
                newPhone.SetRelatedEntity("Company", CompanyModel.Id);
            }

            CompanyModel.ContactNumbers.Add(newPhone);
        }
    }

    private void AddEmail()
    {
        if (CompanyModel.EmailAddresses == null)
        {
            CompanyModel.EmailAddresses = new List<Email>();
        }

        CompanyModel.EmailAddresses.Add(new Email
            {
                IsPrimary = false,
                IsActive = true,
                RelatedEntityType = "Company",
                CreatedOn = DateTime.Now
            });
    }

    private void RemoveEmail(Email email)
    {
        if (CompanyModel.EmailAddresses != null)
        {
            CompanyModel.EmailAddresses.Remove(email);
        }
    }

    private void UpdateEmailAddress(Email email, string value)
    {
        email.EmailAddress = value;
    }

    private void UpdateEmailDescription(Email email, string value)
    {
        email.Description = value;
    }

    private void AddPhone()
    {
        if (CompanyModel.ContactNumbers == null)
        {
            CompanyModel.ContactNumbers = new List<ContactNumber>();
        }

        CompanyModel.ContactNumbers.Add(new ContactNumber
            {
                ContactNumberTypeId = contactNumberTypes?.FirstOrDefault()?.Id ?? 1,
                IsPrimary = false,
                IsActive = true,
                RelatedEntityType = "Company",
                CreatedOn = DateTime.Now
            });
    }

    private void RemovePhone(ContactNumber phone)
    {
        if (CompanyModel.ContactNumbers != null)
        {
            CompanyModel.ContactNumbers.Remove(phone);
        }
    }

    private void UpdatePhoneNumber(ContactNumber phone, string value)
    {
        phone.Number = value;
    }

    private void UpdatePhoneTypeId(ContactNumber phone, string value)
    {
        if (int.TryParse(value, out var typeId))
        {
            phone.ContactNumberTypeId = typeId;
        }
    }

    private void UpdatePhoneDescription(ContactNumber phone, string value)
    {
        phone.Description = value;
    }

    // Logo handling methods
    private async Task OnLogoInputChange(InputFileChangeEventArgs e)
    {
        try
        {
            logoFile = e.File;

            if (logoFile.Size > maxFileSize)
            {
                ToastService.ShowError("File size exceeds 5MB limit", "Error");
                return;
            }

            // Validate file type
            if (!logoFile.ContentType.StartsWith("image/"))
            {
                ToastService.ShowError("Please select an image file", "Error");
                return;
            }

            // Generate preview
            isUploading = true;
            uploadProgress = 0;

            // Simulate upload progress
            for (int i = 0; i <= 60; i += 10)
            {
                uploadProgress = i;
                await Task.Delay(50); // Simulated delay
                StateHasChanged();
            }

            var imageFormat = logoFile.ContentType.Split('/')[1];
            var resizedImageFile = await logoFile.RequestImageFileAsync(logoFile.ContentType, 512, 512);

            using var stream = resizedImageFile.OpenReadStream();
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            byte[] imageData = ms.ToArray();

            // Generate base64 preview
            logoPreview = $"data:{logoFile.ContentType};base64,{Convert.ToBase64String(imageData)}";

            isUploading = false;
            uploadProgress = 100;
        }
        catch (Exception ex)
        {
            isUploading = false;
            ToastService.ShowError($"Error processing logo: {ex.Message}", "Error");
        }
    }

    private void CancelLogoUpload()
    {
        logoPreview = string.Empty;
        logoFile = null;
    }

    private async Task RemoveLogo()
    {
        try
        {
            if (CompanyModel.MainLogoId.HasValue && CompanyModel.MainLogo != null)
            {
                // Remove from CDN using the URL
                await CdnService.DeleteFileAsync(CompanyModel.MainLogo.Url);

                // Update the model
                CompanyModel.MainLogoId = null;
                CompanyModel.MainLogo = null;

                ToastService.ShowSuccess("Logo removed successfully", "Success");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error removing logo: {ex.Message}", "Error");
        }
    }

    private async Task ApplyLogo()
    {
        if (logoFile == null) return;

        try
        {
            isUploading = true;
            uploadProgress = 0;

            // Create a unique filename
            var fileName = $"company-logo-{CompanyModel.Id}-{DateTime.Now:yyyyMMddHHmmss}{Path.GetExtension(logoFile.Name)}";

            // Update progress
            uploadProgress = 30;
            StateHasChanged();

            // Convert IBrowserFile to Stream
            using var stream = logoFile.OpenReadStream(maxFileSize);

            // Upload the file using CDN service
            var url = await CdnService.UploadFileAsync(
                stream,
                fileName,
                logoFile.ContentType,
                "logos", // category as string
                CompanyModel.Id > 0 ? CompanyModel.Id.ToString() : ""
            );

            uploadProgress = 60;
            StateHasChanged();

            if (!string.IsNullOrEmpty(url))
            {
                // Get the file metadata
                var metadata = await CdnService.GetFileMetadataAsync(url);

                if (metadata != null)
                {
                    CompanyModel.MainLogoId = metadata.Id;
                    CompanyModel.MainLogo = metadata;

                    uploadProgress = 100;
                    ToastService.ShowSuccess("Logo uploaded successfully", "Success");
                    logoPreview = string.Empty;
                    logoFile = null;
                }
                else
                {
                    ToastService.ShowError("Failed to retrieve uploaded file metadata", "Error");
                }
            }
            else
            {
                ToastService.ShowError("Failed to upload logo", "Error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error uploading logo: {ex.Message}", "Error");
        }
        finally
        {
            isUploading = false;
            uploadProgress = 0;
            StateHasChanged();
        }
    }
}
