@using Roovia.Components.Elements.Forms
@using Roovia.Interfaces
@using Roovia.Models.UserCompanyModels
@using Roovia.Services
@using Microsoft.EntityFrameworkCore
@using Roovia.Data
@inject IUser UserService
@inject ToastService ToastService
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory

<RVModal IsVisible="true"
         Title="User Permissions"
         Icon="fa-light fa-lock"
         OnClose="OnClose"
         OnCancel="HandleCancel"
         OnConfirm="HandleSave"
         ConfirmText="Save Permissions"
         CancelText="Cancel"
         Size="lg">
    <ChildContent>
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <h3 class="loading-text">Loading user details...</h3>
            </div>
        }
        else if (userName != null)
        {
            <div class="user-permissions-header">
                <div class="user-info">
                    <div class="user-avatar">
                        @if (userProfilePictureUrl != null)
                        {
                            <img src="@userProfilePictureUrl" alt="@userName" />
                        }
                        else
                        {
                            <i class="fa-light fa-user"></i>
                        }
                    </div>
                    <div class="user-details">
                        <h4>@userName</h4>
                        <div class="user-role">
                            @if (userRole.HasValue)
                            {
                                <span class="role-badge @PermissionFormat.GetRoleBadgeClass(userRole.Value)">
                                    <i class="@PermissionFormat.GetRoleIconSmall(userRole.Value)"></i>
                                    @PermissionFormat.GetRoleDisplayName(userRole.Value)
                                </span>
                            }
                        </div>
                    </div>
                </div>
                <div class="permissions-description">
                    <p>
                        Manage specific permissions for this user. Permission overrides let you grant or deny access to specific
                        features regardless of the user's role.
                    </p>
                </div>
            </div>

            <UserPermissionsPanel @ref="permissionsPanel" UserId="@UserId" OnSaved="HandlePermissionsSaved" />

            <div class="permissions-footer">
                <div class="alert alert-info">
                    <i class="fa-light fa-info-circle"></i>
                    <div class="alert-content">
                        <p>
                            <strong>Note:</strong> Changes to permissions will not be saved until you click "Save Permissions".
                            To discard changes, click "Cancel".
                        </p>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-danger">
                <i class="fa-light fa-exclamation-triangle"></i>
                <div class="alert-content">
                    <p>User not found or you do not have permission to manage this user's permissions.</p>
                </div>
            </div>
        }
    </ChildContent>
</RVModal>

@code {
    [Parameter] public string UserId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private bool isLoading = true;
    private string userName;
    private SystemRole? userRole;
    private string userProfilePictureUrl;
    private UserPermissionsPanel permissionsPanel;
    private bool hasPermissionChanges = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserDetails();
    }

    private async Task LoadUserDetails()
    {
        try
        {
            isLoading = true;

            // Get user details
            var response = await UserService.GetUserById(UserId);
            if (response.ResponseInfo.Success)
            {
                var user = (ApplicationUser)response.Response;
                userName = string.IsNullOrEmpty(user.FullName) ? user.UserName : user.FullName;
                userRole = user.Role;

                // Load profile picture if available
                if (user.ProfilePictureId.HasValue && user.ProfilePicture != null)
                {
                    userProfilePictureUrl = user.ProfilePicture.Url;
                }
                else
                {
                    // If user doesn't have a profile picture, try to load it from the database
                    using var context = await DbContextFactory.CreateDbContextAsync();
                    var userWithPicture = await context.Users
                        .Include(u => u.ProfilePicture)
                        .FirstOrDefaultAsync(u => u.Id == UserId);

                    if (userWithPicture?.ProfilePicture != null)
                    {
                        userProfilePictureUrl = userWithPicture.ProfilePicture.Url;
                    }
                }
            }
            else
            {
                ToastService.ShowError(response.ResponseInfo.Message, "Error");
                if (OnClose.HasDelegate)
                    await OnClose.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load user details: {ex.Message}", "Error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSave()
    {
        if (permissionsPanel != null && permissionsPanel.HasPendingChanges())
        {
            // Save the permissions
            bool success = await permissionsPanel.SavePendingChanges();
            if (success)
            {
                ToastService.ShowSuccess($"Permissions updated for {userName}", "Success");

                // Notify parent component
                if (OnSaved.HasDelegate)
                    await OnSaved.InvokeAsync();

                // Close the modal
                if (OnClose.HasDelegate)
                    await OnClose.InvokeAsync();
            }
        }
        else
        {
            // No changes to save
            ToastService.ShowInfo("No permission changes to save", "Information");

            // Still close the modal
            if (OnClose.HasDelegate)
                await OnClose.InvokeAsync();
        }
    }

    private async Task HandleCancel()
    {
        // Check if there are unsaved changes
        if (permissionsPanel != null && permissionsPanel.HasPendingChanges())
        {
            // Discard changes
            permissionsPanel.DiscardPendingChanges();
            ToastService.ShowInfo("Permission changes discarded", "Information");
        }

        // Close the modal
        if (OnClose.HasDelegate)
            await OnClose.InvokeAsync();
    }

    private void HandlePermissionsSaved()
    {
        // This is called when the permissions panel saves changes directly
        hasPermissionChanges = true;
    }
}
