@using Roovia.Models.UserCompanyModels
@using Roovia.Models.UserCompanyMappingModels
@using Roovia.Interfaces
<div class="user-filters-panel">
    <div class="filter-section">
        <div class="search-section">
            <div class="search-input-wrapper">
                <i class="fa-light fa-search search-icon"></i>
                <input type="text" class="custom-search-input" placeholder="Search @SearchTypePlaceholder..."
                       @bind="searchValue" @bind:event="oninput" @onkeyup="HandleKeyPress" />
                @if (!string.IsNullOrEmpty(searchValue))
                {
                    <button class="clear-search-btn" @onclick="ClearSearch" title="Clear search">
                        <i class="fa-light fa-times"></i>
                    </button>
                }
            </div>
            <RVChips Chips="@SearchTypeChips"
                     IsInputChip="false"
                     OnChipSelected="HandleSearchTypeSelection"
                     CssClass="search-type-chips" />
        </div>

        <div class="filter-selectors">
            <div class="filter-group">
                <RVDropdown @ref="companyDropdown" TriggerText="@GetCompanyFilterText()" ButtonType="outline" Position="bottom-start"
                            CssClass="filter-dropdown company-dropdown" FullWidth="true">
                    <div class="dropdown-header">
                        <span>Filter by Company</span>
                    </div>
                    <button type="button" class="roovia-dropdown-item @(SelectedCompanyId == null ? "active" : "")"
                            @onclick="async () => await SelectCompany(null)">
                        <i class="fa-light fa-building"></i>
                        <span>All Companies</span>
                        @if (SelectedCompanyId == null)
                        {
                            <i class="fa-light fa-check"></i>
                        }
                    </button>
                    <div class="dropdown-divider"></div>
                    @if (Companies != null)
                    {
                        @foreach (var company in Companies.OrderBy(c => c.Name))
                        {
                            <button type="button" class="roovia-dropdown-item @(SelectedCompanyId == company.Id ? "active" : "")"
                                    @onclick="async () => await SelectCompany(company.Id)">
                                <i class="fa-light fa-building"></i>
                                <span>@company.Name</span>
                                @if (SelectedCompanyId == company.Id)
                                {
                                    <i class="fa-light fa-check"></i>
                                }
                            </button>
                        }
                    }
                </RVDropdown>

                <RVDropdown @ref="roleDropdown" TriggerText="@GetRoleFilterText()" ButtonType="outline" Position="bottom-start"
                            CssClass="filter-dropdown role-dropdown" FullWidth="true">
                    <div class="dropdown-header">
                        <span>Filter by Role</span>
                    </div>
                    <button type="button" class="roovia-dropdown-item @(SelectedRoleFilter == "all" ? "active" : "")"
                            @onclick='async () => await SelectRole("all")'>
                        <i class="fa-light fa-users"></i>
                        <span>All Roles</span>
                        @if (SelectedRoleFilter == "all")
                        {
                            <i class="fa-light fa-check"></i>
                        }
                    </button>
                    <div class="dropdown-divider"></div>
                    @foreach (var role in Enum.GetValues(typeof(SystemRole)))
                    {
                        var roleValue = role.ToString();
                        <button type="button" class="roovia-dropdown-item @(SelectedRoleFilter == roleValue ? "active" : "")"
                                @onclick="async () => await SelectRole(roleValue)">
                            <i class="@GetRoleIcon((SystemRole)role)"></i>
                            <span>@GetRoleDisplayName((SystemRole)role)</span>
                            @if (SelectedRoleFilter == roleValue)
                            {
                                <i class="fa-light fa-check"></i>
                            }
                        </button>
                    }
                </RVDropdown>

                <RVDropdown @ref="statusDropdown" TriggerText="@GetStatusFilterText()" ButtonType="outline" Position="bottom-start"
                            CssClass="filter-dropdown status-dropdown" FullWidth="true">
                    <div class="dropdown-header">
                        <span>Filter by Status</span>
                    </div>
                    <button type="button" class="roovia-dropdown-item @(SelectedStatusFilter == "all" ? "active" : "")"
                            @onclick='async () => await SelectStatus("all")'>
                        <i class="fa-light fa-users"></i>
                        <span>All Statuses</span>
                        @if (SelectedStatusFilter == "all")
                        {
                            <i class="fa-light fa-check"></i>
                        }
                    </button>
                    <div class="dropdown-divider"></div>
                    @if (StatusTypes != null && StatusTypes.Any())
                    {
                        @foreach (var status in StatusTypes.OrderBy(s => s.DisplayOrder))
                        {
                            var statusValue = status.Id.ToString();
                            <button type="button" class="roovia-dropdown-item @(SelectedStatusFilter == statusValue ? "active" : "")"
                                    @onclick="async () => await SelectStatus(statusValue)">
                                <i class="@GetStatusIcon(status.Name)"></i>
                                <span>@status.Name</span>
                                @if (SelectedStatusFilter == statusValue)
                                {
                                    <i class="fa-light fa-check"></i>
                                }
                            </button>
                        }
                    }
                    else
                    {
                        @* Fallback to simple active/inactive *@
                        <button type="button" class="roovia-dropdown-item @(SelectedStatusFilter == "active" ? "active" : "")"
                                @onclick='async () => await SelectStatus("active")'>
                            <i class="fa-light fa-user-check"></i>
                            <span>Active</span>
                            @if (SelectedStatusFilter == "active")
                            {
                                <i class="fa-light fa-check"></i>
                            }
                        </button>
                        <button type="button" class="roovia-dropdown-item @(SelectedStatusFilter == "inactive" ? "active" : "")"
                                @onclick='async () => await SelectStatus("inactive")'>
                            <i class="fa-light fa-user-slash"></i>
                            <span>Inactive</span>
                            @if (SelectedStatusFilter == "inactive")
                            {
                                <i class="fa-light fa-check"></i>
                            }
                        </button>
                    }
                </RVDropdown>
            </div>

            <div class="filter-actions">
                <RVButton ButtonType="secondary" IconLeft="fa-light fa-filter-slash" Text="Clear" OnClick="HandleClearFilters"
                          Disabled="@(!HasActiveFilters)" CssClass="clear-filters-btn" />

                <RVButton ButtonType="outline" IconLeft="fa-light fa-sync" Text="Refresh" OnClick="HandleRefresh" CssClass="refresh-btn" />
            </div>
        </div>

        @if (HasActiveFilters)
        {
            <div class="active-filters-indicator">
                <i class="fa-light fa-filter"></i>
                <span>Filters applied</span>
            </div>
        }
    </div>
</div>
@code {
    [Parameter] public List<Company>? Companies { get; set; }
    [Parameter] public IEnumerable<dynamic>? StatusTypes { get; set; }
    [Parameter] public List<SubscriptionPlan>? SubscriptionPlans { get; set; }
    [Parameter] public int? SelectedCompanyId { get; set; }
    [Parameter] public EventCallback<int?> OnCompanySelected { get; set; }

    [Parameter] public string SelectedRoleFilter { get; set; } = "all";
    [Parameter] public EventCallback<string> OnRoleFilterChanged { get; set; }

    [Parameter] public string SelectedStatusFilter { get; set; } = "all";
    [Parameter] public EventCallback<string> OnStatusFilterChanged { get; set; }

    [Parameter] public string SearchTerm { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> OnSearchChanged { get; set; }

    [Parameter] public string SearchType { get; set; } = "users";
    [Parameter] public EventCallback<string> OnSearchTypeChanged { get; set; }

    [Parameter] public EventCallback OnClearFilters { get; set; }
    [Parameter] public EventCallback OnRefresh { get; set; }

    private string searchValue = string.Empty;
    private List<RVChips.ChipItem> SearchTypeChips { get; set; } = new List<RVChips.ChipItem>();

    // References to the dropdown components
    private RVDropdown companyDropdown;
    private RVDropdown roleDropdown;
    private RVDropdown statusDropdown;

    private string SearchTypePlaceholder => SearchType switch
    {
        "companies" => "companies",
        "branches" => "branches",
        _ => "users"
    };

    protected override void OnInitialized()
    {
        InitializeSearchTypeChips();
    }

    protected override void OnParametersSet()
    {
        searchValue = SearchTerm;
        UpdateSearchTypeChips();
    }

    private void InitializeSearchTypeChips()
    {
        SearchTypeChips = new List<RVChips.ChipItem>
    {
    new RVChips.ChipItem
    {
    Label = "Users",
    Icon = "fa-light fa-users",
    Type = "primary",
    IsActive = SearchType == "users",
    IsDeletable = false
    },
    new RVChips.ChipItem
    {
    Label = "Companies",
    Icon = "fa-light fa-building",
    Type = "primary",
    IsActive = SearchType == "companies",
    IsDeletable = false
    },
    new RVChips.ChipItem
    {
    Label = "Branches",
    Icon = "fa-light fa-code-branch",
    Type = "primary",
    IsActive = SearchType == "branches",
    IsDeletable = false
    }
    };
    }

    private void UpdateSearchTypeChips()
    {
        foreach (var chip in SearchTypeChips)
        {
            if (chip.Label.ToLower() == SearchType)
                chip.IsActive = true;
            else
                chip.IsActive = false;
        }
    }

    private async Task HandleSearchTypeSelection(string chipId)
    {
        var selectedChip = SearchTypeChips.FirstOrDefault(c => c.Id == chipId);
        if (selectedChip != null)
        {
            // Update all chips - only one can be active at a time
            foreach (var chip in SearchTypeChips)
            {
                chip.IsActive = chip.Id == chipId;
            }

            // Convert chip label to lowercase for the search type
            string newSearchType = selectedChip.Label.ToLower();

            // Only invoke if the search type actually changed
            if (SearchType != newSearchType)
            {
                SearchType = newSearchType;
                await OnSearchTypeChanged.InvokeAsync(SearchType);

                // Clear the search when changing type
                if (!string.IsNullOrEmpty(searchValue))
                {
                    searchValue = string.Empty;
                    await OnSearchChanged.InvokeAsync(searchValue);
                }
            }
        }
    }

    private bool HasActiveFilters =>
    !string.IsNullOrEmpty(SearchTerm) ||
    SelectedCompanyId.HasValue ||
    SelectedRoleFilter != "all" ||
    SelectedStatusFilter != "all";

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await OnSearchChanged.InvokeAsync(searchValue);
        }
    }

    private async Task SelectCompany(int? companyId)
    {
        if (SelectedCompanyId != companyId)
        {
            await OnCompanySelected.InvokeAsync(companyId);
        }

        // Close the dropdown after selection
        if (companyDropdown != null)
        {
            await companyDropdown.Close();
        }
    }

    private async Task SelectRole(string role)
    {
        if (SelectedRoleFilter != role)
        {
            await OnRoleFilterChanged.InvokeAsync(role);
        }

        // Close the dropdown after selection
        if (roleDropdown != null)
        {
            await roleDropdown.Close();
        }
    }

    private async Task SelectStatus(string status)
    {
        if (SelectedStatusFilter != status)
        {
            await OnStatusFilterChanged.InvokeAsync(status);
        }

        // Close the dropdown after selection
        if (statusDropdown != null)
        {
            await statusDropdown.Close();
        }
    }

    private async Task ClearSearch()
    {
        searchValue = string.Empty;
        await OnSearchChanged.InvokeAsync(searchValue);
    }

    private async Task HandleClearFilters()
    {
        await OnClearFilters.InvokeAsync();
    }

    private async Task HandleRefresh()
    {
        await OnRefresh.InvokeAsync();
    }

    private string GetCompanyFilterText()
    {
        if (SelectedCompanyId.HasValue && Companies != null)
        {
            var company = Companies.FirstOrDefault(c => c.Id == SelectedCompanyId);
            return company != null ? $"Company: {company.Name}" : "Company: All";
        }

        return "Company: All";
    }

    private string GetRoleFilterText()
    {
        if (SelectedRoleFilter != "all")
        {
            if (Enum.TryParse<SystemRole>(SelectedRoleFilter, out var roleEnum))
            {
                return $"Role: {GetRoleDisplayName(roleEnum)}";
            }
        }

        return "Role: All";
    }

    private string GetStatusFilterText()
    {
        if (SelectedStatusFilter == "all")
        {
            return "Status: All";
        }

        // Check if we have status types
        if (StatusTypes != null && StatusTypes.Any())
        {
            if (int.TryParse(SelectedStatusFilter, out var statusId))
            {
                var status = StatusTypes.FirstOrDefault(s => s.Id == statusId);
                if (status != null)
                {
                    return $"Status: {status.Name}";
                }
            }
        }

        // Fallback to simple active/inactive
        return SelectedStatusFilter switch
        {
            "active" => "Status: Active",
            "inactive" => "Status: Inactive",
            _ => "Status: All"
        };
    }

    private string GetStatusIcon(string statusName)
    {
        if (string.IsNullOrEmpty(statusName))
            return "fa-light fa-circle";

        return statusName.ToLower() switch
        {
            "active" => "fa-light fa-user-check",
            "inactive" => "fa-light fa-user-slash",
            "suspended" => "fa-light fa-user-lock",
            "locked" => "fa-light fa-user-lock",
            "trial" => "fa-light fa-user-clock",
            "temporary closed" => "fa-light fa-door-closed",
            _ => "fa-light fa-circle"
        };
    }

    private string GetRoleDisplayName(SystemRole role)
    {
        return role switch
        {
            SystemRole.CEOExecutive => "CEO/Executive",
            SystemRole.SystemAdministrator => "System Admin",
            SystemRole.CompanyAdministrator => "Company Admin",
            SystemRole.CompanyFinancialDirector => "Financial Director",
            SystemRole.RegionalManager => "Regional Manager",
            SystemRole.BranchManager => "Branch Manager",
            SystemRole.SeniorPropertyManager => "Sr. Property Manager",
            SystemRole.PropertyManager => "Property Manager",
            SystemRole.AssistantPropertyManager => "Asst. Property Manager",
            SystemRole.FinancialManager => "Financial Manager",
            SystemRole.SeniorAccountant => "Sr. Accountant",
            SystemRole.Accountant => "Accountant",
            SystemRole.AccountsClerk => "Accounts Clerk",
            SystemRole.TenantRelationsManager => "Tenant Relations",
            SystemRole.TenantOfficer => "Tenant Officer",
            SystemRole.LeasingAgent => "Leasing Agent",
            SystemRole.MaintenanceManager => "Maintenance Manager",
            SystemRole.MaintenanceCoordinator => "Maintenance Coord.",
            SystemRole.SeniorInspector => "Sr. Inspector",
            SystemRole.PropertyInspector => "Inspector",
            SystemRole.CustomerSupportManager => "Support Manager",
            SystemRole.CustomerSupportAgent => "Support Agent",
            SystemRole.ComplianceOfficer => "Compliance",
            SystemRole.LegalOfficer => "Legal Officer",
            SystemRole.DataAnalyst => "Data Analyst",
            SystemRole.ReportsViewer => "Reports Viewer",
            SystemRole.Auditor => "Auditor",
            SystemRole.PropertyOwnerPortal => "Property Owner",
            SystemRole.TenantPortal => "Tenant Portal",
            SystemRole.VendorPortal => "Vendor Portal",
            _ => "Unknown"
        };
    }

    private string GetRoleIcon(SystemRole role)
    {
        return role switch
        {
            SystemRole.CEOExecutive => "fa-light fa-crown",
            SystemRole.SystemAdministrator => "fa-light fa-user-crown",
            SystemRole.CompanyAdministrator => "fa-light fa-user-tie",
            SystemRole.CompanyFinancialDirector => "fa-light fa-user-chart",
            SystemRole.RegionalManager => "fa-light fa-user-tag",
            SystemRole.BranchManager => "fa-light fa-user-hard-hat",
            SystemRole.SeniorPropertyManager => "fa-light fa-user-shield",
            SystemRole.PropertyManager => "fa-light fa-user-chart",
            SystemRole.AssistantPropertyManager => "fa-light fa-user-plus",
            SystemRole.FinancialManager => "fa-light fa-user-dollar",
            SystemRole.SeniorAccountant => "fa-light fa-user-chart",
            SystemRole.Accountant => "fa-light fa-user-chart",
            SystemRole.AccountsClerk => "fa-light fa-user-pen",
            SystemRole.TenantRelationsManager => "fa-light fa-user-friends",
            SystemRole.TenantOfficer => "fa-light fa-user-headset",
            SystemRole.LeasingAgent => "fa-light fa-user-tag",
            SystemRole.MaintenanceManager => "fa-light fa-user-wrench",
            SystemRole.MaintenanceCoordinator => "fa-light fa-user-cog",
            SystemRole.SeniorInspector => "fa-light fa-user-search",
            SystemRole.PropertyInspector => "fa-light fa-user-search",
            SystemRole.CustomerSupportManager => "fa-light fa-user-headset",
            SystemRole.CustomerSupportAgent => "fa-light fa-user-question",
            SystemRole.ComplianceOfficer => "fa-light fa-user-shield",
            SystemRole.LegalOfficer => "fa-light fa-user-balance-scale",
            SystemRole.DataAnalyst => "fa-light fa-user-chart",
            SystemRole.ReportsViewer => "fa-light fa-user-chart",
            SystemRole.Auditor => "fa-light fa-user-check",
            SystemRole.PropertyOwnerPortal => "fa-light fa-user-key",
            SystemRole.TenantPortal => "fa-light fa-user-house",
            SystemRole.VendorPortal => "fa-light fa-user-tools",
            _ => "fa-light fa-user"
        };
    }
    }
