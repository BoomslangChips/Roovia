@page "/users"
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Roovia.Components
@using Roovia.Data
@using Roovia.Interfaces
@using Roovia.Models.BusinessHelperModels
@using Roovia.Models.UserCompanyMappingModels
@using Roovia.Models.UserCompanyModels
@using Roovia.Security
@using Roovia.Services
@using Roovia.Services.General
@rendermode InteractiveServer
@inject IUser UserService
@inject IPermissionService PermissionService
@inject ICdnService CdnService
@inject NavigationManager NavigationManager
@inject ToastService ToastService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
<link rel="stylesheet" href="@Assets["css/additional.css"]" />

<div class="users-page">
    <div class="admin-header-section">
        <div class="admin-header-content">
            <div class="header-text-content">
                <div class="header-icon">
                    <i class="fa-light fa-users"></i>
                </div>
                <div class="header-title-group">
                    <h1 class="header-title">User Management</h1>
                    <p class="header-subtitle">Manage users, companies, branches, roles and permissions</p>
                </div>
            </div>
            <div class="header-action-panel">
                <PermissionAuthorizeView Permission="settings.users">
                    <button class="custom-btn custom-btn-primary custom-btn-with-icon action-btn me-2" @onclick="() => ShowUserEditModal()">
                        <i class="fa-light fa-user-plus"></i>
                        <span>Create User</span>
                    </button>
                </PermissionAuthorizeView>

                <PermissionAuthorizeView Permission="settings.users"
                                         Role="@SystemRole.SystemAdministrator.ToString()">
                    <button class="custom-btn custom-btn-primary custom-btn-with-icon action-btn me-2" @onclick="() => ShowCompanyEditModal()">
                        <i class="fa-light fa-building"></i>
                        <span>Create Company</span>
                    </button>
                </PermissionAuthorizeView>

                <PermissionAuthorizeView Permission="settings.users"
                                         Role="@SystemRole.CompanyAdministrator.ToString()">
                    <button class="custom-btn custom-btn-primary custom-btn-with-icon action-btn" @onclick="() => ShowBranchEditModal()">
                        <i class="fa-light fa-code-branch"></i>
                        <span>Create Branch</span>
                    </button>
                </PermissionAuthorizeView>
            </div>
        </div>
    </div>

    <div class="admin-main-container">
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <h3 class="loading-text">Loading data...</h3>
            </div>
        }
        else
        {
            <div class="management-card">
                <div class="card-header-actions">
                    <UserFilterPanel Companies="@availableCompanies"
                                     SubscriptionPlans="@subscriptionPlans"
                                     OnCompanySelected="HandleCompanyChange"
                                     SelectedCompanyId="@selectedCompanyId"
                                     OnRoleFilterChanged="HandleRoleFilterChange"
                                     SelectedRoleFilter="@selectedRoleFilter"
                                     OnStatusFilterChanged="HandleStatusFilterChange"
                                     SelectedStatusFilter="@selectedStatusFilter"
                                     SearchTerm="@searchTerm"
                                     OnSearchChanged="HandleSearch"
                                     SearchType="@searchType"
                                     OnSearchTypeChanged="HandleSearchTypeChange"
                                     OnClearFilters="ClearFilters"
                                     OnRefresh="LoadUserHierarchy" />
                </div>
                <div class="card-content">
                    @if (currentUser?.Role == SystemRole.SystemAdministrator)
                    {
                        <div class="hierarchy-view">
                            @if (filteredCompanies.Any())
                            {
                                <div class="company-accordion">
                                    @foreach (var company in filteredCompanies)
                                    {
                                        var companyUsers = GetCompanyUsers(company.Id);
                                        var companyBranches = GetCompanyBranches(company.Id);

                                        <div class="accordion-item @(expandedCompanies.Contains(company.Id) ? "expanded" : "")">
                                            <div class="accordion-header" @onclick="() => ToggleCompany(company.Id)">
                                                <div class="accordion-title">
                                                    <div class="accordion-icon">
                                                        <i class="@(expandedCompanies.Contains(company.Id) ? "fa-light fa-chevron-down" : "fa-light fa-chevron-right")"></i>
                                                    </div>
                                                    <div class="company-info">
                                                        <div class="company-logo">
                                                            @if (company.MainLogoId.HasValue && company.MainLogo != null)
                                                            {
                                                                <img src="@company.MainLogo.Url" alt="@company.Name" />
                                                            }
                                                            else
                                                            {
                                                                <i class="fa-light fa-building"></i>
                                                            }
                                                        </div>
                                                        <div class="company-details">
                                                            <h3>@company.Name</h3>
                                                            <div class="company-meta">
                                                                <span><i class="fa-light fa-code-branch"></i> @companyBranches.Count() branches</span>
                                                                <span><i class="fa-light fa-users"></i> @companyUsers.Count() users</span>
                                                                @if (company.Status != null)
                                                                {
                                                                    <span class="status-badge @(company.IsActive ? "active" : "inactive")">
                                                                        @company.Status.Name
                                                                    </span>
                                                                }
                                                                @if (company.SubscriptionPlanId.HasValue && subscriptionPlans.Any())
                                                                {
                                                                    var plan = subscriptionPlans.FirstOrDefault(p => p.Id == company.SubscriptionPlanId);
                                                                    if (plan != null)
                                                                    {
                                                                        <span class="subscription-badge">@plan.Name</span>
                                                                    }
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="accordion-actions" @onclick:stopPropagation="true">
                                                    <button class="custom-btn custom-btn-outline custom-btn-sm custom-btn-with-icon action-btn"
                                                            @onclick="() => ShowCompanyEditModal(company.Id, true)">
                                                        <i class="fa-light fa-eye"></i>
                                                        <span>View</span>
                                                    </button>
                                                    <PermissionAuthorizeView Permission="settings.users"
                                                                             Role="@SystemRole.SystemAdministrator.ToString()">
                                                        <button class="custom-btn custom-btn-outline custom-btn-sm custom-btn-with-icon action-btn"
                                                                @onclick="() => ShowCompanyEditModal(company.Id)">
                                                            <i class="fa-light fa-edit"></i>
                                                            <span>Edit</span>
                                                        </button>
                                                        <button class="custom-btn custom-btn-outline custom-btn-sm custom-btn-with-icon action-btn"
                                                                @onclick="() => ShowCreateBranchModal(company.Id)">
                                                            <i class="fa-light fa-code-branch"></i>
                                                            <span>Add Branch</span>
                                                        </button>
                                                    </PermissionAuthorizeView>
                                                </div>
                                            </div>

                                            @if (expandedCompanies.Contains(company.Id))
                                            {
                                                <div class="accordion-content">
                                                    @if (companyBranches.Any())
                                                    {
                                                        <div class="branch-accordion">
                                                            @foreach (var branch in companyBranches)
                                                            {
                                                                var branchUsers = GetBranchUsers(branch.Id);

                                                                <div class="accordion-item @(expandedBranches.Contains(branch.Id) ? "expanded" : "")">
                                                                    <div class="accordion-header" @onclick="() => ToggleBranch(branch.Id)">
                                                                        <div class="accordion-title">
                                                                            <div class="accordion-icon">
                                                                                <i class="@(expandedBranches.Contains(branch.Id) ? "fa-light fa-chevron-down" : "fa-light fa-chevron-right")"></i>
                                                                            </div>
                                                                            <div class="branch-info">
                                                                                <div class="branch-logo">
                                                                                    @if (branch.MainLogoId.HasValue && branch.MainLogo != null)
                                                                                    {
                                                                                        <img src="@branch.MainLogo.Url" alt="@branch.Name" />
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        <i class="fa-light fa-code-branch"></i>
                                                                                    }
                                                                                </div>
                                                                                <div class="branch-details">
                                                                                    <h4>@branch.Name</h4>
                                                                                    <div class="branch-meta">
                                                                                        <span><i class="fa-light fa-users"></i> @branchUsers.Count() users</span>
                                                                                        @if (branch.Status != null)
                                                                                        {
                                                                                            <span class="status-badge @(branch.IsActive ? "active" : "inactive")">
                                                                                                @branch.Status.Name
                                                                                            </span>
                                                                                        }
                                                                                        @if (branch.IsHeadOffice)
                                                                                        {
                                                                                            <span class="badge bg-primary">Head Office</span>
                                                                                        }
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="accordion-actions" @onclick:stopPropagation="true">
                                                                            <button class="custom-btn custom-btn-outline custom-btn-sm custom-btn-with-icon action-btn"
                                                                                    @onclick="() => ShowBranchEditModal(branch.Id, true)">
                                                                                <i class="fa-light fa-eye"></i>
                                                                                <span>View</span>
                                                                            </button>
                                                                            <PermissionAuthorizeView Permission="settings.users">
                                                                                <button class="custom-btn custom-btn-outline custom-btn-sm custom-btn-with-icon action-btn"
                                                                                        @onclick="() => ShowBranchEditModal(branch.Id)">
                                                                                    <i class="fa-light fa-edit"></i>
                                                                                    <span>Edit</span>
                                                                                </button>
                                                                                <button class="custom-btn custom-btn-outline custom-btn-sm custom-btn-with-icon action-btn"
                                                                                        @onclick="() => ShowAddUserToBranchModal(branch.Id)">
                                                                                    <i class="fa-light fa-user-plus"></i>
                                                                                    <span>Add User</span>
                                                                                </button>
                                                                            </PermissionAuthorizeView>
                                                                        </div>
                                                                    </div>

                                                                    @if (expandedBranches.Contains(branch.Id) && branchUsers.Any())
                                                                    {
                                                                        <div class="accordion-content">
                                                                            <h5><i class="fa-light fa-users"></i> Branch Users</h5>
                                                                            @foreach (var user in branchUsers)
                                                                            {
                                                                                <UserCard User="user"
                                                                                          CustomRoles="@GetUserCustomRoles(user.Id)"
                                                                                          OnView="(id) => ShowUserDetailsModal(id)"
                                                                                          OnEdit="HandleUserEdit"
                                                                                          OnRoles="HandleUserRoles"
                                                                                          OnPermissions="HandleUserPermissions"
                                                                                          OnResetPassword="HandleUserResetPassword"
                                                                                          OnToggleStatus="HandleUserStatusToggle"
                                                                                          DisableActions="!CanEditUser(user)" />
                                                                            }
                                                                        </div>
                                                                    }
                                                                    else if (expandedBranches.Contains(branch.Id) && !branchUsers.Any())
                                                                    {
                                                                        <div class="accordion-content">
                                                                            <div class="empty-state">
                                                                                <div class="empty-icon">
                                                                                    <i class="fa-light fa-user-xmark"></i>
                                                                                </div>
                                                                                <h3 class="empty-title">No users in branch</h3>
                                                                                <p class="empty-description">No users are currently assigned to this branch.</p>
                                                                                <button class="custom-btn custom-btn-primary custom-btn-with-icon"
                                                                                        @onclick="() => ShowAddUserToBranchModal(branch.Id)">
                                                                                    <span>Add User</span>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="empty-state">
                                                            <div class="empty-icon">
                                                                <i class="fa-light fa-code-branch"></i>
                                                            </div>
                                                            <h3 class="empty-title">No branches found</h3>
                                                            <p class="empty-description">This company has no branches yet.</p>
                                                            <button class="custom-btn custom-btn-primary custom-btn-with-icon"
                                                                    @onclick="() => ShowCreateBranchModal(company.Id)">
                                                                <span>Create Branch</span>
                                                            </button>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fa-light fa-building-magnifying-glass"></i>
                                    </div>
                                    <h3 class="empty-title">No companies found</h3>
                                    <p class="empty-description">No companies match your current filters.</p>
                                    <button class="custom-btn custom-btn-primary custom-btn-with-icon"
                                            @onclick="ClearFilters">
                                        <span>Clear Filters</span>
                                    </button>
                                </div>
                            }
                        </div>
                    }
                    else if (currentUser?.Role == SystemRole.CompanyAdministrator && currentUser?.CompanyId.HasValue == true)
                    {
                        <div class="company-view">
                            @if (currentUserCompany != null)
                            {
                                <div class="company-overview">
                                    <div class="company-header">
                                        <div class="company-logo-large">
                                            @if (currentUserCompany.MainLogoId.HasValue && currentUserCompany.MainLogo != null)
                                            {
                                                <img src="@currentUserCompany.MainLogo.Url" alt="@currentUserCompany.Name" />
                                            }
                                            else
                                            {
                                                <i class="fa-light fa-building"></i>
                                            }
                                        </div>
                                        <div class="company-header-info">
                                            <h2>@currentUserCompany.Name</h2>
                                            <div class="company-stats">
                                                <div class="stat-item">
                                                    <span class="stat-value">@GetCompanyBranches(currentUserCompany.Id).Count()</span>
                                                    <span class="stat-label">Branches</span>
                                                </div>
                                                <div class="stat-item">
                                                    <span class="stat-value">@GetCompanyUsers(currentUserCompany.Id).Count()</span>
                                                    <span class="stat-label">Total Users</span>
                                                </div>
                                                @if (currentUserCompany.Status != null)
                                                {
                                                    <div class="stat-item">
                                                        <span class="status-badge @(currentUserCompany.IsActive ? "active" : "inactive")">
                                                            @currentUserCompany.Status.Name
                                                        </span>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="tabs-container">
                                    <div class="tabs-header">
                                        <button class="tab-button @(activeSubTab == "users" ? "active" : "")" @onclick='() => activeSubTab = "users"'>
                                            <i class="fa-light fa-users"></i> Company Users
                                        </button>
                                        <button class="tab-button @(activeSubTab == "branches" ? "active" : "")" @onclick='() => activeSubTab = "branches"'>
                                            <i class="fa-light fa-code-branch"></i> Branches
                                        </button>
                                        <PermissionAuthorizeView Permission="settings.permissions">
                                            <button class="tab-button @(activeSubTab == "roles" ? "active" : "")" @onclick='() => activeSubTab = "roles"'>
                                                <i class="fa-light fa-user-shield"></i> Roles & Permissions
                                            </button>
                                        </PermissionAuthorizeView>
                                    </div>

                                    <div class="tabs-content">
                                        @if (activeSubTab == "users")
                                        {
                                            <div class="tab-panel">
                                                @if (GetCompanyUsers(currentUserCompany.Id).Any())
                                                {
                                                    @foreach (var user in GetCompanyUsers(currentUserCompany.Id))
                                                    {
                                                        <UserCard User="user"
                                                                  CustomRoles="@GetUserCustomRoles(user.Id)"
                                                                  OnView="(id) => ShowUserDetailsModal(id)"
                                                                  OnEdit="HandleUserEdit"
                                                                  OnRoles="HandleUserRoles"
                                                                  OnPermissions="HandleUserPermissions"
                                                                  OnResetPassword="HandleUserResetPassword"
                                                                  OnToggleStatus="HandleUserStatusToggle"
                                                                  DisableActions="!CanEditUser(user)" />
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="empty-state">
                                                        <div class="empty-icon">
                                                            <i class="fa-light fa-user-plus"></i>
                                                        </div>
                                                        <h3 class="empty-title">No users in company</h3>
                                                        <p class="empty-description">No users are currently assigned to this company.</p>
                                                        <button class="custom-btn custom-btn-primary custom-btn-with-icon"
                                                                @onclick="() => ShowUserEditModal()">
                                                            <span>Add User</span>
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else if (activeSubTab == "branches")
                                        {
                                            <div class="tab-panel">
                                                @if (GetCompanyBranches(currentUserCompany.Id).Any())
                                                {
                                                    <div class="branch-grid">
                                                        @foreach (var branch in GetCompanyBranches(currentUserCompany.Id))
                                                        {
                                                            var branchUsers = GetBranchUsers(branch.Id);
                                                            <div class="branch-card">
                                                                <div class="branch-card-header">
                                                                    <div class="branch-card-icon">
                                                                        @if (branch.MainLogoId.HasValue && branch.MainLogo != null)
                                                                        {
                                                                            <img src="@branch.MainLogo.Url" alt="@branch.Name" />
                                                                        }
                                                                        else
                                                                        {
                                                                            <i class="fa-light fa-code-branch"></i>
                                                                        }
                                                                    </div>
                                                                    <div>
                                                                        <h3>@branch.Name</h3>
                                                                        <div class="branch-card-meta">
                                                                            <span><i class="fa-light fa-users"></i> @branchUsers.Count() users</span>
                                                                            @if (branch.Status != null)
                                                                            {
                                                                                <span class="status-badge @(branch.IsActive ? "active" : "inactive")">
                                                                                    @branch.Status.Name
                                                                                </span>
                                                                            }
                                                                            @if (branch.IsHeadOffice)
                                                                            {
                                                                                <span class="badge bg-primary">Head Office</span>
                                                                            }
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="branch-card-actions">
                                                                    <button class="custom-btn custom-btn-outline custom-btn-sm custom-btn-with-icon"
                                                                            @onclick="() => ViewBranchUsers(branch.Id)">
                                                                        <i class="fa-light fa-eye"></i>
                                                                        <span>View Users</span>
                                                                    </button>
                                                                    <PermissionAuthorizeView Permission="settings.users">
                                                                        <button class="custom-btn custom-btn-outline custom-btn-sm custom-btn-with-icon"
                                                                                @onclick="() => ShowBranchEditModal(branch.Id)">
                                                                            <i class="fa-light fa-edit"></i>
                                                                            <span>Edit</span>
                                                                        </button>
                                                                        <button class="custom-btn custom-btn-outline custom-btn-sm custom-btn-with-icon"
                                                                                @onclick="() => ShowAddUserToBranchModal(branch.Id)">
                                                                            <i class="fa-light fa-user-plus"></i>
                                                                            <span>Add User</span>
                                                                        </button>
                                                                    </PermissionAuthorizeView>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-state">
                                                        <div class="empty-icon">
                                                            <i class="fa-light fa-code-branch"></i>
                                                        </div>
                                                        <h3 class="empty-title">No branches found</h3>
                                                        <p class="empty-description">No branches are currently set up for this company.</p>
                                                        <button class="custom-btn custom-btn-primary custom-btn-with-icon"
                                                                @onclick="() => ShowCreateBranchModal(currentUserCompany.Id)">
                                                            <span>Add Branch</span>
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else if (activeSubTab == "roles")
                                        {
                                            <div class="tab-panel">
                                                <RolesPermissionsPanel CompanyId="@currentUserCompany.Id" />
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (currentUser?.Role == SystemRole.BranchManager && currentUser?.BranchId.HasValue == true)
                    {
                        <div class="branch-view">
                            @if (currentUserBranch != null)
                            {
                                <div class="branch-overview">
                                    <div class="branch-header">
                                        <div class="branch-logo-large">
                                            @if (currentUserBranch.MainLogoId.HasValue && currentUserBranch.MainLogo != null)
                                            {
                                                <img src="@currentUserBranch.MainLogo.Url" alt="@currentUserBranch.Name" />
                                            }
                                            else
                                            {
                                                <i class="fa-light fa-code-branch"></i>
                                            }
                                        </div>
                                        <div class="branch-header-info">
                                            <h2>@currentUserBranch.Name</h2>
                                            <div class="branch-stats">
                                                <div class="stat-item">
                                                    <span class="stat-value">@GetBranchUsers(currentUserBranch.Id).Count()</span>
                                                    <span class="stat-label">Users</span>
                                                </div>
                                                <div class="stat-item">
                                                    <span class="stat-value">
                                                        @GetBranchUsers(currentUserBranch.Id).Count(u => u.IsActive)
                                                    </span>
                                                    <span class="stat-label">Active</span>
                                                </div>
                                                @if (currentUserBranch.IsHeadOffice)
                                                {
                                                    <div class="stat-item">
                                                        <span class="badge bg-primary">Head Office</span>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="branch-users-section">
                                    <h3><i class="fa-light fa-users"></i> Branch Users</h3>
                                    @if (GetBranchUsers(currentUserBranch.Id).Any())
                                    {
                                        @foreach (var user in GetBranchUsers(currentUserBranch.Id))
                                        {
                                            <UserCard User="user"
                                                      CustomRoles="@GetUserCustomRoles(user.Id)"
                                                      OnView="(id) => ShowUserDetailsModal(id)"
                                                      OnEdit="HandleUserEdit"
                                                      OnRoles="HandleUserRoles"
                                                      OnPermissions="HandleUserPermissions"
                                                      OnResetPassword="HandleUserResetPassword"
                                                      OnToggleStatus="HandleUserStatusToggle"
                                                      DisableActions="!CanEditUser(user)" />
                                        }
                                    }
                                    else
                                    {
                                        <div class="empty-state">
                                            <div class="empty-icon">
                                                <i class="fa-light fa-user-plus"></i>
                                            </div>
                                            <h3 class="empty-title">No users in branch</h3>
                                            <p class="empty-description">No users are currently assigned to this branch.</p>
                                            <button class="custom-btn custom-btn-primary custom-btn-with-icon"
                                                    @onclick="() => ShowUserEditModal()">
                                                <span>Add User</span>
                                            </button>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fa-light fa-lock"></i>
                            </div>
                            <h3 class="empty-title">No access</h3>
                            <p class="empty-description">You don't have permission to view user information.</p>
                            <button class="custom-btn custom-btn-primary custom-btn-with-icon"
                                    @onclick='() => NavigationManager.NavigateTo("/")'>
                                <span>Return to Dashboard</span>
                            </button>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    @* User Status Confirmation Modal *@
    @if (showStatusConfirmation)
    {
        <div class="custom-modal-backdrop"></div>
        <div class="custom-modal custom-modal-sm status-modal">
            <div class="custom-modal-header">
                <h2 class="custom-modal-title">
                    <i class="@(userToToggle?.IsActive == true ? "fa-light fa-user-slash" : "fa-light fa-user-check")"></i>
                    <span>@(userToToggle?.IsActive == true ? "Deactivate User" : "Activate User")</span>
                </h2>
                <button class="custom-modal-close" @onclick="() => showStatusConfirmation = false">
                    <i class="fa-light fa-times"></i>
                </button>
            </div>
            <div class="custom-modal-body">
                <div class="status-modal-content">
                    <div class="custom-alert @(userToToggle?.IsActive == true ? "custom-alert-danger" : "custom-alert-success")">
                        <i class="@(userToToggle?.IsActive == true ? "fa-light fa-exclamation-triangle" : "fa-light fa-check-circle")"></i>
                        <div class="alert-content">
                            @if (userToToggle?.IsActive == true)
                            {
                                <p>Are you sure you want to deactivate <strong>@GetUserDisplayName(userToToggle)</strong>?</p>
                                <p>Deactivated users will not be able to log in to the system.</p>
                            }
                            else
                            {
                                <p>Are you sure you want to activate <strong>@GetUserDisplayName(userToToggle)</strong>?</p>
                                <p>Activated users will be able to log in to the system.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button class="custom-btn custom-btn-outline" @onclick="() => showStatusConfirmation = false">Cancel</button>
                <button class="custom-btn @(userToToggle?.IsActive == true ? "custom-btn-danger" : "custom-btn-success")" @onclick="ToggleUserStatus">
                    @(userToToggle?.IsActive == true ? "Deactivate" : "Activate")
                </button>
            </div>
        </div>
    }

    @* User Edit Modal *@
    @if (showUserEditModal)
    {
        <UserEditModal UserId="@selectedUserId"
                       Companies="allCompanies"
                       UserStatusTypes="@userStatusTypes"
                       SelectedBranchId="@selectedBranchForUser"
                       OnClose="() => showUserEditModal = false"
                       OnSaved="HandleUserSaved" />
    }

    @* User Details Modal *@
    @if (showUserDetailsModal)
    {
        <UserDetailsModal UserId="@selectedUserId"
                          OnClose="() => showUserDetailsModal = false"
                          OnEdit="() => { showUserDetailsModal = false; ShowUserEditModal(selectedUserId); }" />
    }

    @* User Roles Modal *@
    @if (showUserRolesModal)
    {
        <UserRolesModal UserId="@selectedUserId"
                        CompanyId="@GetUserCompanyId(selectedUserId)"
                        OnClose="() => showUserRolesModal = false"
                        OnSaved="HandleRolesSaved" />
    }

    @* User Permissions Modal *@
    @if (showUserPermissionsModal)
    {
        <UserPermissionsModal UserId="@selectedUserId"
                              OnClose="() => showUserPermissionsModal = false"
                              OnSaved="HandlePermissionsSaved" />
    }

    @* Company Edit Modal *@
    @if (showCompanyEditModal)
    {
        <CompanyDialog CompanyModel="@editingCompany"
                       CompanyStatusTypes="@companyStatusTypes"
                       SubscriptionPlans="@subscriptionPlans"
                       IsEdit="@(selectedCompanyId != 0)"
                       IsView="@viewModeOnly"
                       CanEdit="true"
                       OnSave="HandleCompanySaved"
                       OnCancel="() => showCompanyEditModal = false" />
    }

    @* Branch Edit Modal *@
    @if (showBranchEditModal)
    {
        <BranchDialog BranchModel="@editingBranch"
                      branchStatusTypes="@branchStatusTypes"
                      Companies="@availableCompanies"
                      IsEdit="@(selectedBranchId != 0)"
                      IsView="@viewModeOnly"
                      CompanyId="@editingBranchCompanyId"
                      CanEdit="true"
                      CanEditCompany="currentUser?.Role == SystemRole.SystemAdministrator"
                      OnSave="HandleBranchSaved"
                      OnCancel="() => showBranchEditModal = false" />
    }

    @* Reset Password Modal *@
    @if (showResetPasswordModal && userToResetPassword != null)
    {
        <ResetPasswordModal User="userToResetPassword"
                            OnClose="() => showResetPasswordModal = false"
                            OnPasswordReset="HandlePasswordReset" />
    }
</div>



@code {
    // User and Role Management
    private ApplicationUser? currentUser;
    private Company? currentUserCompany;
    private Branch? currentUserBranch;
    private Dictionary<string, List<UserRoleAssignment>> userCustomRoles = new();

    // Data Collections
    private List<ApplicationUser> users = new();
    private List<Company> allCompanies = new();
    private List<Company> availableCompanies = new();
    private List<Branch> allBranches = new();
    private List<CompanyStatusType> companyStatusTypes = new();
    private List<BranchStatusType> branchStatusTypes = new();
    private List<UserStatusType> userStatusTypes = new();
    private List<SubscriptionPlan> subscriptionPlans = new();
    private bool isLoading = true;

    // Modal States
    private bool showUserEditModal = false;
    private bool showUserDetailsModal = false;
    private bool showUserRolesModal = false;
    private bool showUserPermissionsModal = false;
    private bool showStatusConfirmation = false;
    private bool showCompanyEditModal = false;
    private bool showBranchEditModal = false;
    private bool showResetPasswordModal = false;
    private bool viewModeOnly = false;
    private string selectedUserId = string.Empty;
    private int selectedCompanyId = 0;
    private int selectedBranchId = 0;
    private int selectedBranchForUser = 0;
    private int editingBranchCompanyId = 0;
    private ApplicationUser? userToToggle;
    private ApplicationUser? userToResetPassword;
    private Company editingCompany = new();
    private Branch editingBranch = new();
    private string activeSubTab = "users";

    // Filtering
    private string searchTerm = string.Empty;
    private int? selectedCompanyIdFilter = null;
    private string selectedRoleFilter = "all";
    private string selectedStatusFilter = "all";
    private string searchType = "users";

    // UI State
    private HashSet<int> expandedCompanies = new();
    private HashSet<int> expandedBranches = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadCurrentUser();
            await LoadMappingData();
            await LoadUserHierarchy();

            await InvokeAsync(() => this.StateHasChanged());
        }
    }

    private async Task LoadCurrentUser()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (!string.IsNullOrEmpty(userId))
            {
                var response = await UserService.GetUserById(userId);
                if (response.ResponseInfo.Success)
                {
                    currentUser = (ApplicationUser)response.Response;

                    if (currentUser?.CompanyId.HasValue == true)
                    {
                        var companyResponse = await UserService.GetCompanyById(currentUser.CompanyId.Value);
                        if (companyResponse.ResponseInfo.Success)
                        {
                            currentUserCompany = (Company)companyResponse.Response;
                        }
                    }

                    if (currentUser?.BranchId.HasValue == true)
                    {
                        var branchResponse = await UserService.GetBranchById(currentUser.BranchId.Value);
                        if (branchResponse.ResponseInfo.Success)
                        {
                            currentUserBranch = (Branch)branchResponse.Response;
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load current user: {ex.Message}", "Error");
        }
    }

    private async Task LoadMappingData()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            // Load status types
            companyStatusTypes = await context.CompanyStatusTypes.Where(s => s.IsActive).ToListAsync();
            branchStatusTypes = await context.BranchStatusTypes.Where(s => s.IsActive).ToListAsync();
            userStatusTypes = await context.UserStatusTypes.Where(s => s.IsActive).ToListAsync();

            // Load subscription plans
            subscriptionPlans = await context.SubscriptionPlans.Where(p => p.IsActive).ToListAsync();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load mapping data: {ex.Message}", "Error");
        }
    }

    private async Task LoadUserHierarchy()
    {
        isLoading = true;

        try
        {
            // Load users based on permissions
            await LoadUsers();

            // Load companies based on permissions
            await LoadCompanies();

            // Load branches based on permissions
            await LoadBranches();

            // Load custom roles for all visible users
            await LoadUserCustomRoles();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load data: {ex.Message}", "Error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCompanies()
    {
        try
        {
            var response = await UserService.GetAllCompanies();
            if (response.ResponseInfo.Success)
            {
                allCompanies = (List<Company>)response.Response;

                // Load related data for companies
                using var context = await DbContextFactory.CreateDbContextAsync();
                var companyIds = allCompanies.Select(c => c.Id).ToList();

                // Load logos and status
                var companiesWithRelations = await context.Companies
                    .Include(c => c.MainLogo)
                    .Include(c => c.Status)
                    .Where(c => companyIds.Contains(c.Id))
                    .ToListAsync();

                // Update the companies with related data
                foreach (var company in allCompanies)
                {
                    var relatedData = companiesWithRelations.FirstOrDefault(c => c.Id == company.Id);
                    if (relatedData != null)
                    {
                        company.MainLogo = relatedData.MainLogo;
                        company.Status = relatedData.Status;
                    }
                }

                // Filter available companies based on user role
                FilterAvailableCompanies();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading companies: {ex.Message}", "Error");
        }
    }

    private void FilterAvailableCompanies()
    {
        if (currentUser == null)
            return;

        if (currentUser.Role == SystemRole.SystemAdministrator)
        {
            // System admin can see all companies
            availableCompanies = allCompanies;
        }
        else if (currentUser.Role == SystemRole.CompanyAdministrator && currentUser.CompanyId.HasValue)
        {
            // Company admin can only see their company
            availableCompanies = allCompanies
                .Where(c => c.Id == currentUser.CompanyId.Value)
                .ToList();
        }
        else if (currentUser.Role == SystemRole.BranchManager && currentUser.CompanyId.HasValue)
        {
            // Branch manager can only see their company
            availableCompanies = allCompanies
                .Where(c => c.Id == currentUser.CompanyId.Value)
                .ToList();
        }
        else
        {
            // Other roles cannot see any companies
            availableCompanies = new List<Company>();
        }
    }

    private async Task LoadBranches()
    {
        allBranches.Clear();

        try
        {
            if (currentUser?.Role == SystemRole.SystemAdministrator)
            {
                // System admin can see all branches from all companies
                foreach (var company in allCompanies)
                {
                    var branchesResponse = await UserService.GetBranchesByCompany(company.Id);
                    if (branchesResponse.ResponseInfo.Success)
                    {
                        var companyBranches = (List<Branch>)branchesResponse.Response;
                        foreach (var branch in companyBranches)
                        {
                            branch.Company = company;
                        }
                        allBranches.AddRange(companyBranches);
                    }
                }
            }
            else if (currentUser?.Role == SystemRole.CompanyAdministrator && currentUser.CompanyId.HasValue)
            {
                // Company admin can only see branches from their company
                var branchesResponse = await UserService.GetBranchesByCompany(currentUser.CompanyId.Value);
                if (branchesResponse.ResponseInfo.Success)
                {
                    var companyBranches = (List<Branch>)branchesResponse.Response;
                    var company = allCompanies.FirstOrDefault(c => c.Id == currentUser.CompanyId.Value);
                    foreach (var branch in companyBranches)
                    {
                        branch.Company = company;
                    }
                    allBranches.AddRange(companyBranches);
                }
            }
            else if (currentUser?.Role == SystemRole.BranchManager && currentUser.BranchId.HasValue)
            {
                // Branch manager can only see their branch
                var branch = await UserService.GetBranchById(currentUser.BranchId.Value);
                if (branch.ResponseInfo.Success)
                {
                    var branchItem = (Branch)branch.Response;
                    var company = allCompanies.FirstOrDefault(c => c.Id == currentUser?.CompanyId);
                    branchItem.Company = company;
                    allBranches.Add(branchItem);
                }
            }

            // Load related data for branches
            if (allBranches.Any())
            {
                using var context = await DbContextFactory.CreateDbContextAsync();
                var branchIds = allBranches.Select(b => b.Id).ToList();

                // Load logos and status
                var branchesWithRelations = await context.Branches
                    .Include(b => b.MainLogo)
                    .Include(b => b.Status)
                    .Where(b => branchIds.Contains(b.Id))
                    .ToListAsync();

                // Update the branches with related data
                foreach (var branch in allBranches)
                {
                    var relatedData = branchesWithRelations.FirstOrDefault(b => b.Id == branch.Id);
                    if (relatedData != null)
                    {
                        branch.MainLogo = relatedData.MainLogo;
                        branch.Status = relatedData.Status;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading branches: {ex.Message}", "Error");
        }
    }

    private async Task LoadUsers()
    {
        try
        {
            isLoading = true;

            // Get all users but filter based on current user's role
            var response = await UserService.GetAllUsers();
            if (response.ResponseInfo.Success)
            {
                var allUsers = (List<ApplicationUser>)response.Response;

                // Filter users based on current user's permissions
                if (currentUser?.Role == SystemRole.SystemAdministrator)
                {
                    // System admin can see all users
                    users = allUsers;
                }
                else if (currentUser?.Role == SystemRole.CompanyAdministrator && currentUser.CompanyId.HasValue)
                {
                    // Company admin can only see users in their company
                    users = allUsers
                        .Where(u => u.CompanyId.HasValue && u.CompanyId.Value == currentUser.CompanyId.Value)
                        .ToList();
                }
                else if (currentUser?.Role == SystemRole.BranchManager && currentUser.BranchId.HasValue)
                {
                    // Branch manager can only see users in their branch
                    users = allUsers
                        .Where(u => u.BranchId.HasValue && u.BranchId.Value == currentUser.BranchId.Value)
                        .ToList();
                }
                else
                {
                    users = new List<ApplicationUser>();
                }

                // Load profile pictures for all users
                if (users.Any())
                {
                    using var context = await DbContextFactory.CreateDbContextAsync();
                    var userIds = users.Select(u => u.Id).ToList();

                    var usersWithPictures = await context.Users
                        .Include(u => u.ProfilePicture)
                        .Include(u => u.Status)
                        .Where(u => userIds.Contains(u.Id))
                        .ToListAsync();

                    // Update users with profile pictures
                    foreach (var user in users)
                    {
                        var withPicture = usersWithPictures.FirstOrDefault(u => u.Id == user.Id);
                        if (withPicture != null)
                        {
                            user.ProfilePicture = withPicture.ProfilePicture;
                            user.Status = withPicture.Status;
                        }
                    }
                }
            }
            else
            {
                ToastService.ShowError(response.ResponseInfo.Message, "Error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load users: {ex.Message}", "Error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadUserCustomRoles()
    {
        if (!users.Any()) return;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var userIds = users.Select(u => u.Id).ToList();

            var userRoles = await context.UserRoleAssignments
                .Include(ur => ur.Role)
                .Where(ur => userIds.Contains(ur.UserId) && ur.IsActive)
                .ToListAsync();

            userCustomRoles = userRoles.GroupBy(ur => ur.UserId)
                .ToDictionary(g => g.Key, g => g.ToList());
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load user roles: {ex.Message}", "Error");
        }
    }

    private List<UserRoleAssignment> GetUserCustomRoles(string userId)
    {
        return userCustomRoles.GetValueOrDefault(userId, new List<UserRoleAssignment>());
    }

    private int? GetUserCompanyId(string userId)
    {
        var user = users.FirstOrDefault(u => u.Id == userId);
        return user?.CompanyId;
    }

    private bool CanEditUser(ApplicationUser user)
    {
        if (currentUser == null || user == null)
            return false;

        // Can't edit your own account
        if (user.Id == currentUser.Id)
            return false;

        // Check role hierarchy and permissions
        if (currentUser.Role == SystemRole.SystemAdministrator)
        {
            // System Admin can edit anyone
            return true;
        }
        else if (currentUser.Role == SystemRole.CompanyAdministrator)
        {
            // Company Admin can't edit System Admins
            if (user.Role == SystemRole.SystemAdministrator)
                return false;

            // Company Admin can only edit users in their company
            return user.CompanyId.HasValue && user.CompanyId.Value == currentUser.CompanyId;
        }
        else if (currentUser.Role == SystemRole.BranchManager)
        {
            // Branch Manager can't edit System Admins or Company Admins
            if (user.Role == SystemRole.SystemAdministrator ||
                user.Role == SystemRole.CompanyAdministrator)
                return false;

            // Branch Manager can only edit users in their branch
            return user.BranchId.HasValue && user.BranchId.Value == currentUser.BranchId;
        }

        // Other roles can't edit users
        return false;
    }

    private async Task<bool> HasPermission(string permission)
    {
        return await PermissionService.UserHasPermission(currentUser.Id, permission);
    }

    private IEnumerable<Company> filteredCompanies
    {
        get
        {
            if (currentUser?.Role != SystemRole.SystemAdministrator) return new List<Company>();

            var companies = availableCompanies.AsEnumerable();

            // Company filter
            if (selectedCompanyIdFilter.HasValue)
            {
                companies = companies.Where(c => c.Id == selectedCompanyIdFilter);
            }

            // Search filter based on search type
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                if (searchType == "companies")
                {
                    // Search directly in companies
                    companies = companies.Where(c =>
                        c.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) == true ||
                        c.RegistrationNumber?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) == true);
                }
                else if (searchType == "branches")
                {
                    // Search in branches, then get their parent companies
                    var matchingBranchCompanyIds = allBranches
                        .Where(b => b.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) == true ||
                                   b.Code?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) == true)
                        .Select(b => b.CompanyId)
                        .Distinct()
                        .ToList();

                    companies = companies.Where(c => matchingBranchCompanyIds.Contains(c.Id));
                }
                else // users (default)
                {
                    // Search in users, then get their company IDs
                    var companyIds = users
                        .Where(u =>
                            (u.FirstName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                            (u.LastName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                            (u.UserName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                            (u.Email?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                            (u.EmployeeNumber?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
                        .Select(u => u.CompanyId)
                        .Where(id => id.HasValue)
                        .Select(id => id!.Value)
                        .Distinct()
                        .ToList();

                    companies = companies.Where(c => companyIds.Contains(c.Id));
                }
            }

            // Status filter - hide companies with no matching users
            if (selectedStatusFilter != "all")
            {
                bool isActive = selectedStatusFilter == "active";

                // Get company IDs that have users with the specified status
                var companyIdsWithMatchingUsers = users
                    .Where(u => u.IsActive == isActive)
                    .Select(u => u.CompanyId)
                    .Where(id => id.HasValue)
                    .Select(id => id!.Value)
                    .Distinct()
                    .ToList();

                companies = companies.Where(c => companyIdsWithMatchingUsers.Contains(c.Id));
            }

            return companies;
        }
    }

    private IEnumerable<ApplicationUser> GetCompanyUsers(int companyId)
    {
        var companyUsers = users.Where(u => u.CompanyId == companyId);
        return ApplyUserFilters(companyUsers);
    }

    private IEnumerable<ApplicationUser> GetBranchUsers(int branchId)
    {
        var branchUsers = users.Where(u => u.BranchId == branchId);
        return ApplyUserFilters(branchUsers);
    }

    private IEnumerable<Branch> GetCompanyBranches(int companyId)
    {
        // Filter branches based on user permissions
        IEnumerable<Branch> branches;

        if (currentUser?.Role == SystemRole.SystemAdministrator)
        {
            // System admin can see all branches
            branches = allBranches.Where(b => b.CompanyId == companyId);
        }
        else if (currentUser?.Role == SystemRole.CompanyAdministrator && currentUser.CompanyId == companyId)
        {
            // Company admin can see all branches in their company
            branches = allBranches.Where(b => b.CompanyId == companyId);
        }
        else if (currentUser?.Role == SystemRole.BranchManager &&
                 currentUser.CompanyId == companyId &&
                 currentUser.BranchId.HasValue)
        {
            // Branch manager can only see their branch
            branches = allBranches.Where(b => b.Id == currentUser.BranchId.Value);
        }
        else
        {
            // Other roles can't see branches
            branches = new List<Branch>();
        }

        // Search filter - only apply when search type is "branches"
        if (!string.IsNullOrWhiteSpace(searchTerm) && searchType == "branches")
        {
            branches = branches.Where(b =>
                b.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) == true ||
                b.Code?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) == true);
        }

        return branches;
    }

    private IEnumerable<ApplicationUser> ApplyUserFilters(IEnumerable<ApplicationUser> userList)
    {
        // Search filter - only apply when search type is "users"
        if (!string.IsNullOrWhiteSpace(searchTerm) && searchType == "users")
        {
            userList = userList.Where(u =>
                (u.FirstName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.LastName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.UserName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.Email?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.EmployeeNumber?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.JobTitle?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        // Role filter
        if (selectedRoleFilter != "all")
        {
            if (Enum.TryParse<SystemRole>(selectedRoleFilter, out var roleEnum))
            {
                userList = userList.Where(u => u.Role == roleEnum);
            }
        }

        // Status filter
        if (selectedStatusFilter != "all")
        {
            bool isActive = selectedStatusFilter == "active";
            userList = userList.Where(u => u.IsActive == isActive);
        }

        return userList;
    }

    private void ToggleCompany(int companyId)
    {
        if (expandedCompanies.Contains(companyId))
            expandedCompanies.Remove(companyId);
        else
            expandedCompanies.Add(companyId);
    }

    private void ToggleBranch(int branchId)
    {
        if (expandedBranches.Contains(branchId))
            expandedBranches.Remove(branchId);
        else
            expandedBranches.Add(branchId);
    }

    private void HandleCompanyChange(int? companyId)
    {
        selectedCompanyIdFilter = companyId;
    }

    private void HandleRoleFilterChange(string roleFilter)
    {
        selectedRoleFilter = roleFilter;
    }

    private void HandleStatusFilterChange(string statusFilter)
    {
        selectedStatusFilter = statusFilter;
    }

    private void HandleSearch(string search)
    {
        searchTerm = search;
    }

    private void HandleSearchTypeChange(string type)
    {
        searchType = type;
        StateHasChanged();
    }

    private void ClearFilters()
    {
        searchTerm = string.Empty;
        selectedCompanyIdFilter = null;
        selectedRoleFilter = "all";
        selectedStatusFilter = "all";
        searchType = "users";
    }

    // User Management Methods
    private async void ShowUserEditModal(string? userId = null)
    {
        // If editing an existing user, check permissions
        if (!string.IsNullOrEmpty(userId))
        {
            var userToEdit = users.FirstOrDefault(u => u.Id == userId);
            if (userToEdit != null && !CanEditUser(userToEdit))
            {
                ToastService.ShowError("You don't have permission to edit this user", "Permission Denied");
                return;
            }
        }
        else
        {
            // For new users, ensure the current user has create user permission
            if (await HasPermission("settings.users") == false)
            {
                ToastService.ShowError("You don't have permission to create users", "Permission Denied");
                return;
            }

            // Auto-select branch for branch managers
            if (currentUser?.Role == SystemRole.BranchManager && currentUser.BranchId.HasValue)
            {
                selectedBranchForUser = currentUser.BranchId.Value;
            }
        }

        selectedUserId = userId ?? string.Empty;
        showUserEditModal = true;
        await InvokeAsync(() => this.StateHasChanged());
    }

    private async void ShowAddUserToBranchModal(int branchId)
    {
        // Check if the user has permission to add users to this branch
        var branch = allBranches.FirstOrDefault(b => b.Id == branchId);
        if (branch == null)
        {
            ToastService.ShowError("Branch not found", "Error");
            return;
        }

        if (await HasPermission("settings.users") == false)
        {
            ToastService.ShowError("You don't have permission to create users", "Permission Denied");
            return;
        }

        if (currentUser?.Role == SystemRole.CompanyAdministrator && currentUser.CompanyId != branch.CompanyId)
        {
            ToastService.ShowError("You can only add users to branches in your company", "Permission Denied");
            return;
        }

        if (currentUser?.Role == SystemRole.BranchManager && currentUser.BranchId != branchId)
        {
            ToastService.ShowError("You can only add users to your branch", "Permission Denied");
            return;
        }

        selectedBranchForUser = branchId;
        selectedUserId = string.Empty; // Create a new user
        showUserEditModal = true;
        await InvokeAsync(() => this.StateHasChanged());
    }

    private async void ShowUserDetailsModal(string userId)
    {
        // Everyone with access to the users page can view details
        selectedUserId = userId;
        showUserDetailsModal = true;
        await InvokeAsync(() => this.StateHasChanged());
    }

    private async void ShowUserRolesModal(string userId)
    {
        var userToEdit = users.FirstOrDefault(u => u.Id == userId);
        if (userToEdit != null && !CanEditUser(userToEdit))
        {
            ToastService.ShowError("You don't have permission to edit roles for this user", "Permission Denied");
            return;
        }

        selectedUserId = userId;
        showUserRolesModal = true;
        await InvokeAsync(() => this.StateHasChanged());
    }

    private async void ShowUserPermissionsModal(string userId)
    {
        var userToEdit = users.FirstOrDefault(u => u.Id == userId);
        if (userToEdit != null && !CanEditUser(userToEdit))
        {
            ToastService.ShowError("You don't have permission to edit permissions for this user", "Permission Denied");
            return;
        }

        if (await HasPermission("settings.permissions") == false)
        {
            ToastService.ShowError("You don't have permission to manage user permissions", "Permission Denied");
            return;
        }

        selectedUserId = userId;
        showUserPermissionsModal = true;
        await InvokeAsync(() => this.StateHasChanged());
    }

    private async void ShowResetPasswordModal(string userId)
    {
        if (string.IsNullOrEmpty(userId)) return;

        var user = users.FirstOrDefault(u => u.Id == userId);
        if (user == null || !CanEditUser(user))
        {
            ToastService.ShowError("You don't have permission to reset this user's password", "Permission Denied");
            return;
        }

        userToResetPassword = user;
        showResetPasswordModal = true;
        await InvokeAsync(() => this.StateHasChanged());
    }

    private async void ConfirmToggleUserStatus(ApplicationUser user)
    {
        if (!CanEditUser(user))
        {
            ToastService.ShowError("You don't have permission to change the status of this user", "Permission Denied");
            return;
        }

        userToToggle = user;
        showStatusConfirmation = true;
        await InvokeAsync(() => this.StateHasChanged());
    }

    private async Task ToggleUserStatus()
    {
        if (userToToggle == null) return;

        try
        {
            // Double-check permissions before processing
            if (!CanEditUser(userToToggle))
            {
                ToastService.ShowError("You don't have permission to change the status of this user", "Permission Denied");
                showStatusConfirmation = false;
                userToToggle = null;
                return;
            }

            userToToggle.IsActive = !userToToggle.IsActive;
            userToToggle.UpdatedBy = currentUser?.Id;
            userToToggle.UpdatedDate = DateTime.Now;

            var response = await UserService.UpdateUser(userToToggle.Id, userToToggle);

            if (response.ResponseInfo.Success)
            {
                string message = userToToggle.IsActive
                    ? $"User '{GetUserDisplayName(userToToggle)}' has been activated"
                    : $"User '{GetUserDisplayName(userToToggle)}' has been deactivated";

                ToastService.ShowSuccess(message, "Success");
                await LoadUsers();
            }
            else
            {
                ToastService.ShowError(response.ResponseInfo.Message, "Error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to update user status: {ex.Message}", "Error");
        }

        showStatusConfirmation = false;
        userToToggle = null;
    }

    private async Task HandleUserSaved()
    {
        showUserEditModal = false;
        selectedBranchForUser = 0; // Reset selected branch after saving
        await LoadUserHierarchy();
    }

    private async Task HandleRolesSaved()
    {
        showUserRolesModal = false;
        await LoadUserHierarchy();
    }

    private async Task HandlePermissionsSaved()
    {
        showUserPermissionsModal = false;
        await LoadUserHierarchy();
    }

    private void HandlePasswordReset()
    {
        showResetPasswordModal = false;
        userToResetPassword = null;
    }

    // Event handlers for UserCard
    private async void HandleUserEdit(string userId)
    {
        var user = users.FirstOrDefault(u => u.Id == userId);
        if (user != null && CanEditUser(user))
        {
            ShowUserEditModal(userId);
            await InvokeAsync(() => this.StateHasChanged());
        }
    }

    private async void HandleUserRoles(string userId)
    {
        var user = users.FirstOrDefault(u => u.Id == userId);
        if (user != null && CanEditUser(user))
        {
            ShowUserRolesModal(userId);
            await InvokeAsync(() => this.StateHasChanged());
        }
    }

    private async void HandleUserPermissions(string userId)
    {
        var user = users.FirstOrDefault(u => u.Id == userId);
        if (user != null && CanEditUser(user))
        {
            ShowUserPermissionsModal(userId);
            await InvokeAsync(() => this.StateHasChanged());
        }
    }

    private async void HandleUserResetPassword(string userId)
    {
        var user = users.FirstOrDefault(u => u.Id == userId);
        if (user != null && CanEditUser(user))
        {
            ShowResetPasswordModal(userId);
            await InvokeAsync(() => this.StateHasChanged());
        }
    }

    private async void HandleUserStatusToggle(ApplicationUser user)
    {
        if (CanEditUser(user))
        {
            ConfirmToggleUserStatus(user);
            await InvokeAsync(() => this.StateHasChanged());
        }
    }

    // Company Management Methods
    private async void ShowCompanyEditModal(int companyId = 0, bool viewOnly = false)
    {
        // Only System Admin can create/edit companies
        if (currentUser?.Role != SystemRole.SystemAdministrator)
        {
            ToastService.ShowError("Only System Administrators can manage companies", "Permission Denied");
            return;
        }

        selectedCompanyId = companyId;
        viewModeOnly = viewOnly;

        if (companyId != 0)
        {
            var company = allCompanies.FirstOrDefault(c => c.Id == companyId);
            if (company != null)
            {
                editingCompany = company;
                showCompanyEditModal = true;
                await InvokeAsync(() => this.StateHasChanged());
            }
            else
            {
                ToastService.ShowError("Company not found", "Error");
            }
        }
        else
        {
            editingCompany = new Company
                {
                    IsActive = true,
                    Address = new Address { Country = "South Africa" },
                    CreatedOn = DateTime.Now,
                    StatusId = companyStatusTypes.FirstOrDefault(s => s.Name == "Active")?.Id,
                    SubscriptionPlanId = subscriptionPlans.FirstOrDefault(p => p.Name == "Starter")?.Id
                };
            showCompanyEditModal = true;
            await InvokeAsync(() => this.StateHasChanged());
        }
    }

    private async Task HandleCompanySaved(Company company)
    {
        // Double-check permissions
        if (currentUser?.Role != SystemRole.SystemAdministrator)
        {
            ToastService.ShowError("Only System Administrators can manage companies", "Permission Denied");
            return;
        }

        try
        {
            if (company.Id == 0)
            {
                // Create new company
                var response = await UserService.CreateCompany(company);
                if (response.ResponseInfo.Success)
                {
                    ToastService.ShowSuccess($"Company '{company.Name}' created successfully", "Success");
                    await LoadUserHierarchy();
                }
                else
                {
                    ToastService.ShowError(response.ResponseInfo.Message, "Error");
                }
            }
            else
            {
                // Update existing company
                var response = await UserService.UpdateCompany(company.Id, company);
                if (response.ResponseInfo.Success)
                {
                    ToastService.ShowSuccess($"Company '{company.Name}' updated successfully", "Success");
                    await LoadUserHierarchy();
                }
                else
                {
                    ToastService.ShowError(response.ResponseInfo.Message, "Error");
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to save company: {ex.Message}", "Error");
        }

        showCompanyEditModal = false;
    }

    // Branch Management Methods
    private async void ShowBranchEditModal(int branchId = 0, bool viewOnly = false)
    {
        // Check permissions based on role
        if (await HasPermission("settings.users") == false)
        {
            ToastService.ShowError("You don't have permission to manage branches", "Permission Denied");
            return;
        }

        selectedBranchId = branchId;
        viewModeOnly = viewOnly;

        if (branchId != 0)
        {
            var branch = allBranches.FirstOrDefault(b => b.Id == branchId);
            if (branch != null)
            {
                // Check if this branch belongs to the company admin's company
                if (currentUser?.Role == SystemRole.CompanyAdministrator && branch.CompanyId != currentUser.CompanyId)
                {
                    ToastService.ShowError("You can only edit branches in your company", "Permission Denied");
                    return;
                }

                editingBranch = branch;
                editingBranchCompanyId = branch.CompanyId;
                showBranchEditModal = true;
                await InvokeAsync(() => this.StateHasChanged());
            }
            else
            {
                ToastService.ShowError("Branch not found", "Error");
            }
        }
        else
        {
            editingBranch = new Branch
                {
                    CompanyId = currentUser?.Role == SystemRole.CompanyAdministrator && currentUser.CompanyId.HasValue
                            ? currentUser.CompanyId.Value
                            : 0,
                    IsActive = true,
                    Address = new Address { Country = "South Africa" },
                    CreatedOn = DateTime.Now,
                    StatusId = branchStatusTypes.FirstOrDefault(s => s.Name == "Active")?.Id
                };

            editingBranchCompanyId = editingBranch.CompanyId;
            showBranchEditModal = true;
            await InvokeAsync(() => this.StateHasChanged());
        }
    }

    private async void ShowCreateBranchModal(int companyId)
    {
        // Verify the company ID is valid for the current user's permissions
        if (currentUser?.Role == SystemRole.CompanyAdministrator &&
             currentUser.CompanyId.HasValue &&
             currentUser.CompanyId.Value != companyId)
        {
            ToastService.ShowError("You can only create branches in your company", "Permission Denied");
            return;
        }

        selectedBranchId = 0;
        viewModeOnly = false;
        editingBranch = new Branch
            {
                CompanyId = companyId,
                IsActive = true,
                Address = new Address { Country = "South Africa" },
                CreatedOn = DateTime.Now,
                StatusId = branchStatusTypes.FirstOrDefault(s => s.Name == "Active")?.Id
            };
        editingBranchCompanyId = companyId;
        showBranchEditModal = true;
        await InvokeAsync(() => this.StateHasChanged());
    }

    private async Task HandleBranchSaved(Branch branch)
    {
        // Double-check permissions
        if (await HasPermission("settings.users") == false)
        {
            ToastService.ShowError("You don't have permission to manage branches", "Permission Denied");
            return;
        }

        if (currentUser?.Role != SystemRole.SystemAdministrator &&
            currentUser?.Role == SystemRole.CompanyAdministrator &&
            currentUser.CompanyId != branch.CompanyId)
        {
            ToastService.ShowError("You don't have permission to manage this branch", "Permission Denied");
            return;
        }

        try
        {
            if (branch.Id == 0)
            {
                // Create new branch
                var response = await UserService.CreateBranch(branch);
                if (response.ResponseInfo.Success)
                {
                    ToastService.ShowSuccess($"Branch '{branch.Name}' created successfully", "Success");
                    await LoadUserHierarchy();
                }
                else
                {
                    ToastService.ShowError(response.ResponseInfo.Message, "Error");
                }
            }
            else
            {
                // Update existing branch
                var response = await UserService.UpdateBranch(branch.Id, branch);
                if (response.ResponseInfo.Success)
                {
                    ToastService.ShowSuccess($"Branch '{branch.Name}' updated successfully", "Success");
                    await LoadUserHierarchy();
                }
                else
                {
                    ToastService.ShowError(response.ResponseInfo.Message, "Error");
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to save branch: {ex.Message}", "Error");
        }

        showBranchEditModal = false;
        await InvokeAsync(() => this.StateHasChanged());
    }

    private void ViewBranchUsers(int branchId)
    {
        activeSubTab = "users";
        if (!expandedBranches.Contains(branchId))
        {
            expandedBranches.Add(branchId);
        }
    }

    private string GetUserDisplayName(ApplicationUser user)
    {
        if (!string.IsNullOrEmpty(user.FullName))
        {
            return user.FullName;
        }

        return user.UserName ?? "Unknown User";
    }
}