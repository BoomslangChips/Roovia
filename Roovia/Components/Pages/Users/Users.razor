@* @page "/users"
@using Roovia.Interfaces
@using Roovia.Security
@using Roovia.Services
@using Roovia.Components
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@attribute [Authorize(Policy = "AdminAccess")]
@rendermode InteractiveServer
@inject IUser UserService
@inject IPermissionService PermissionService
@inject NavigationManager NavigationManager
@inject ToastService ToastService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<div class="users-page">
    <div class="admin-header-section">
        <div class="admin-header-content">
            <div class="header-text-content">
                <div class="header-icon">
                    <i class="fa-light fa-users"></i>
                </div>
                <div class="header-title-group">
                    <h1 class="header-title">Administration</h1>
                    <p class="header-subtitle">Manage users, companies, and branches</p>
                </div>
            </div>

            <div class="header-action-panel">
                <RVButton ButtonType="primary" IconLeft="fa-light fa-user-plus" Text="Create User"
                          OnClick="() => ShowUserEditModal()" CssClass="action-btn me-2" />

                @if (currentUser?.Role == SystemRole.GlobalAdmin)
                {
                    <RVButton ButtonType="primary" IconLeft="fa-light fa-building" Text="Create Company"
                              OnClick="() => ShowCompanyEditModal()" CssClass="action-btn me-2" />
                }

                @if (currentUser?.Role == SystemRole.GlobalAdmin ||
                (currentUser?.Role == SystemRole.CompanyAdmin && currentUser.CompanyId.HasValue))
                {
                    <RVButton ButtonType="primary" IconLeft="fa-light fa-code-branch" Text="Create Branch"
                              OnClick="() => ShowBranchEditModal()" CssClass="action-btn" />
                }
            </div>
        </div>
    </div>

    <div class="admin-main-container">
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <h3 class="loading-text">Loading data...</h3>
            </div>
        }
        else
        {
            <CardView CssClass="management-card">
                <HeaderActions>
                    <UserFilterPanel Companies="@availableCompanies"
                                     OnCompanySelected="HandleCompanyChange"
                                     SelectedCompanyId="@selectedCompanyId"
                                     OnRoleFilterChanged="HandleRoleFilterChange"
                                     SelectedRoleFilter="@selectedRoleFilter"
                                     OnStatusFilterChanged="HandleStatusFilterChange"
                                     SelectedStatusFilter="@selectedStatusFilter"
                                     SearchTerm="@searchTerm"
                                     OnSearchChanged="HandleSearch"
                                     SearchType="@searchType"
                                     OnSearchTypeChanged="HandleSearchTypeChange"
                                     OnClearFilters="ClearFilters"
                                     OnRefresh="LoadUserHierarchy" />
                </HeaderActions>
                <ChildContent>
                    @if (currentUser?.Role == SystemRole.GlobalAdmin)
                    {
                        <div class="hierarchy-view">
                            @if (filteredCompanies.Any())
                            {
                                <div class="company-accordion">
                                    @foreach (var company in filteredCompanies)
                                    {
                                        var companyUsers = GetCompanyUsers(company.Id);
                                        var companyBranches = GetCompanyBranches(company.Id);

                                        <div class="accordion-item @(expandedCompanies.Contains(company.Id) ? "expanded" : "")">
                                            <div class="accordion-header" @onclick="() => ToggleCompany(company.Id)">
                                                <div class="accordion-title">
                                                    <div class="accordion-icon">
                                                        <i class="@(expandedCompanies.Contains(company.Id) ? "fa-light fa-chevron-down" : "fa-light fa-chevron-right")"></i>
                                                    </div>
                                                    <div class="company-info">
                                                        <div class="company-logo">
                                                            <i class="fa-light fa-building"></i>
                                                        </div>
                                                        <div class="company-details">
                                                            <h3>@company.Name</h3>
                                                            <div class="company-meta">
                                                                <span><i class="fa-light fa-code-branch"></i> @companyBranches.Count() branches</span>
                                                                <span><i class="fa-light fa-users"></i> @companyUsers.Count() users</span>
                                                                <span class="status-badge @(company.IsActive ? "active" : "inactive")">
                                                                    @(company.IsActive ? "Active" : "Inactive")
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="accordion-actions" @onclick:stopPropagation="true">
                                                    <RVButton ButtonType="outline" Size="xs" IconLeft="fa-light fa-eye" Text="View"
                                                              OnClick="() => ShowCompanyEditModal(company.Id, true)" CssClass="action-btn" />
                                                    <RVButton ButtonType="outline" Size="xs" IconLeft="fa-light fa-edit" Text="Edit"
                                                              OnClick="() => ShowCompanyEditModal(company.Id)" CssClass="action-btn" />
                                                    <RVButton ButtonType="outline" Size="xs" IconLeft="fa-light fa-code-branch-add" Text="Add Branch"
                                                              OnClick="() => ShowCreateBranchModal(company.Id)" CssClass="action-btn" />
                                                </div>
                                            </div>

                                            @if (expandedCompanies.Contains(company.Id))
                                            {
                                                <div class="accordion-content">

                                                    @if (companyBranches.Any())
                                                    {
                                                        <div class="branch-accordion">
                                                            @foreach (var branch in companyBranches)
                                                            {
                                                                var branchUsers = GetBranchUsers(branch.Id);

                                                                <div class="accordion-item @(expandedBranches.Contains(branch.Id) ? "expanded" : "")">
                                                                    <div class="accordion-header" @onclick="() => ToggleBranch(branch.Id)">
                                                                        <div class="accordion-title">
                                                                            <div class="accordion-icon">
                                                                                <i class="@(expandedBranches.Contains(branch.Id) ? "fa-light fa-chevron-down" : "fa-light fa-chevron-right")"></i>
                                                                            </div>
                                                                            <div class="branch-info">
                                                                                <div class="branch-logo">
                                                                                    <i class="fa-light fa-code-branch"></i>
                                                                                </div>
                                                                                <div class="branch-details">
                                                                                    <h4>@branch.Name</h4>
                                                                                    <div class="branch-meta">
                                                                                        <span><i class="fa-light fa-users"></i> @branchUsers.Count() users</span>
                                                                                        <span class="status-badge @(branch.IsActive ? "active" : "inactive")">
                                                                                            @(branch.IsActive ? "Active" : "Inactive")
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="accordion-actions" @onclick:stopPropagation="true">
                                                                            <RVButton ButtonType="outline" Size="xs" IconLeft="fa-light fa-eye" Text="View"
                                                                                      OnClick="() => ShowBranchEditModal(branch.Id, true)" CssClass="action-btn" />
                                                                            <RVButton ButtonType="outline" Size="xs" IconLeft="fa-light fa-edit" Text="Edit"
                                                                                      OnClick="() => ShowBranchEditModal(branch.Id)" CssClass="action-btn" />
                                                                            <RVButton ButtonType="outline" Size="xs" IconLeft="fa-light fa-user-plus" Text="Add User"
                                                                                      OnClick="() => ShowAddUserToBranchModal(branch.Id)" CssClass="action-btn" />
                                                                        </div>
                                                                    </div>

                                                                    @if (expandedBranches.Contains(branch.Id) && branchUsers.Any())
                                                                    {
                                                                        <div class="accordion-content">
                                                                            <h5><i class="fa-light fa-users"></i> Branch Users</h5>
                                                                            @foreach (var user in branchUsers)
                                                                            {
                                                                                <UserCard User="user"
                                                                                          OnView="(id) => ShowUserDetailsModal(id)"
                                                                                          OnEdit="HandleUserEdit"
                                                                                          OnRoles="HandleUserRoles"
                                                                                          OnResetPassword="HandleUserResetPassword"
                                                                                          OnToggleStatus="HandleUserStatusToggle"
                                                                                          DisableActions="!CanEditUser(user)" />
                                                                            }
                                                                        </div>
                                                                    }
                                                                    else if (expandedBranches.Contains(branch.Id) && !branchUsers.Any())
                                                                    {
                                                                        <div class="accordion-content">
                                                                            <EmptyState Title="No users in branch"
                                                                                        Description="No users are currently assigned to this branch."
                                                                                        Icon="fa-light fa-user-plus"
                                                                                        ActionText="Add User"
                                                                                        OnAction="() => ShowAddUserToBranchModal(branch.Id)" />
                                                                        </div>
                                                                    }
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <EmptyState Title="No branches found"
                                                                    Description="This company has no branches yet."
                                                                    Icon="fa-light fa-code-branch-slash"
                                                                    ActionText="Create Branch"
                                                                    OnAction="() => ShowCreateBranchModal(company.Id)" />
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <EmptyState Title="No companies found"
                                            Description="No companies match your current filters."
                                            Icon="fa-light fa-building-magnifying-glass"
                                            ActionText="Clear Filters"
                                            OnAction="ClearFilters" />
                            }
                        </div>
                    }
                    else if (currentUser?.Role == SystemRole.CompanyAdmin && currentUser?.CompanyId.HasValue == true)
                    {
                        <div class="company-view">
                            @if (currentUserCompany != null)
                            {
                                <div class="company-overview">
                                    <div class="company-header">
                                        <div class="company-logo-large">
                                            <i class="fa-light fa-building"></i>
                                        </div>
                                        <div class="company-header-info">
                                            <h2>@currentUserCompany.Name</h2>
                                            <div class="company-stats">
                                                <div class="stat-item">
                                                    <span class="stat-value">@GetCompanyBranches(currentUserCompany.Id).Count()</span>
                                                    <span class="stat-label">Branches</span>
                                                </div>
                                                <div class="stat-item">
                                                    <span class="stat-value">@GetCompanyUsers(currentUserCompany.Id).Count()</span>
                                                    <span class="stat-label">Total Users</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="tabs-container">
                                    <div class="tabs-header">
                                        <button class="tab-button @(activeSubTab == "users" ? "active" : "")" @onclick='() => activeSubTab = "users"'>
                                            <i class="fa-light fa-users"></i> Company Users
                                        </button>
                                        <button class="tab-button @(activeSubTab == "branches" ? "active" : "")" @onclick='() => activeSubTab = "branches"'>
                                            <i class="fa-light fa-code-branch"></i> Branches
                                        </button>
                                    </div>

                                    <div class="tabs-content">
                                        @if (activeSubTab == "users")
                                        {
                                            <div class="tab-panel">
                                                @if (GetCompanyUsers(currentUserCompany.Id).Any())
                                                {
                                                    @foreach (var user in GetCompanyUsers(currentUserCompany.Id))
                                                    {
                                                        <UserCard User="user"
                                                                  OnView="(id) => ShowUserDetailsModal(id)"
                                                                  OnEdit="HandleUserEdit"
                                                                  OnRoles="HandleUserRoles"
                                                                  OnResetPassword="HandleUserResetPassword"
                                                                  OnToggleStatus="HandleUserStatusToggle"
                                                                  DisableActions="!CanEditUser(user)" />
                                                    }
                                                }
                                                else
                                                {
                                                    <EmptyState Title="No users in company"
                                                                Description="No users are currently assigned to this company."
                                                                Icon="fa-light fa-user-plus"
                                                                ActionText="Add User"
                                                                OnAction="() => ShowUserEditModal()" />
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="tab-panel">
                                                @if (GetCompanyBranches(currentUserCompany.Id).Any())
                                                {
                                                    <div class="branch-grid">
                                                        @foreach (var branch in GetCompanyBranches(currentUserCompany.Id))
                                                        {
                                                            var branchUsers = GetBranchUsers(branch.Id);
                                                            <div class="branch-card">
                                                                <div class="branch-card-header">
                                                                    <div class="branch-card-icon">
                                                                        <i class="fa-light fa-code-branch"></i>
                                                                    </div>
                                                                    <div>
                                                                        <h3>@branch.Name</h3>
                                                                        <div class="branch-card-meta">
                                                                            <span><i class="fa-light fa-users"></i> @branchUsers.Count() users</span>
                                                                            <span class="status-badge @(branch.IsActive ? "active" : "inactive")">
                                                                                @(branch.IsActive ? "Active" : "Inactive")
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="branch-card-actions">
                                                                    <RVButton ButtonType="outline" Size="sm" IconLeft="fa-light fa-eye" Text="View Users"
                                                                              OnClick="() => ViewBranchUsers(branch.Id)" />
                                                                    <RVButton ButtonType="outline" Size="sm" IconLeft="fa-light fa-edit" Text="Edit"
                                                                              OnClick="() => ShowBranchEditModal(branch.Id)" />
                                                                    <RVButton ButtonType="outline" Size="sm" IconLeft="fa-light fa-user-plus" Text="Add User"
                                                                              OnClick="() => ShowAddUserToBranchModal(branch.Id)" />
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <EmptyState Title="No branches found"
                                                                Description="No branches are currently set up for this company."
                                                                Icon="fa-light fa-code-branch-slash"
                                                                ActionText="Add Branch"
                                                                OnAction="() => ShowCreateBranchModal(currentUserCompany.Id)" />
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (currentUser?.Role == SystemRole.BranchManager && currentUser?.BranchId.HasValue == true)
                    {
                        <div class="branch-view">
                            @if (currentUserBranch != null)
                            {
                                <div class="branch-overview">
                                    <div class="branch-header">
                                        <div class="branch-logo-large">
                                            <i class="fa-light fa-code-branch"></i>
                                        </div>
                                        <div class="branch-header-info">
                                            <h2>@currentUserBranch.Name</h2>
                                            <div class="branch-stats">
                                                <div class="stat-item">
                                                    <span class="stat-value">@GetBranchUsers(currentUserBranch.Id).Count()</span>
                                                    <span class="stat-label">Users</span>
                                                </div>
                                                <div class="stat-item">
                                                    <span class="stat-value">
                                                        @GetBranchUsers(currentUserBranch.Id).Count(u => u.IsActive)
                                                    </span>
                                                    <span class="stat-label">Active</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="branch-users-section">
                                    <h3><i class="fa-light fa-users"></i> Branch Users</h3>
                                    @if (GetBranchUsers(currentUserBranch.Id).Any())
                                    {
                                        @foreach (var user in GetBranchUsers(currentUserBranch.Id))
                                        {
                                            <UserCard User="user"
                                                      OnView="(id) => ShowUserDetailsModal(id)"
                                                      OnEdit="HandleUserEdit"
                                                      OnRoles="HandleUserRoles"
                                                      OnResetPassword="HandleUserResetPassword"
                                                      OnToggleStatus="HandleUserStatusToggle"
                                                      DisableActions="!CanEditUser(user)" />
                                        }
                                    }
                                    else
                                    {
                                        <EmptyState Title="No users in branch"
                                                    Description="No users are currently assigned to this branch."
                                                    Icon="fa-light fa-user-plus"
                                                    ActionText="Add User"
                                                    OnAction="() => ShowUserEditModal()" />
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <EmptyState Title="No access"
                                    Description="You don't have permission to view user information."
                                    Icon="fa-light fa-lock"
                                    ActionText="Return to Dashboard"
                                    OnAction='() => NavigationManager.NavigateTo("/")' />
                    }
                </ChildContent>
            </CardView>
        }
    </div>

    @if (showStatusConfirmation)
    {
        <RVModal IsVisible="true"
                 Title="@(userToToggle?.IsActive == true ? "Deactivate User" : "Activate User")"
                 Icon="@(userToToggle?.IsActive == true ? "fa-light fa-user-slash" : "fa-light fa-user-check")"
                 OnClose="() => showStatusConfirmation = false"
                 OnCancel="() => showStatusConfirmation = false"
                 OnConfirm="ToggleUserStatus"
                 ConfirmText="@(userToToggle?.IsActive == true ? "Deactivate" : "Activate")"
                 CancelText="Cancel"
                 Size="sm"
                 CssClass="status-modal">
            <ChildContent>
                <div class="status-modal-content">
                    <div class="alert @(userToToggle?.IsActive == true ? "alert-danger" : "alert-success")">
                        <i class="@(userToToggle?.IsActive == true ? "fa-light fa-exclamation-triangle" : "fa-light fa-check-circle")"></i>
                        <div class="alert-content">
                            @if (userToToggle?.IsActive == true)
                            {
                                <p>Are you sure you want to deactivate <strong>@GetUserDisplayName(userToToggle)</strong>?</p>
                                <p>Deactivated users will not be able to log in to the system.</p>
                            }
                            else
                            {
                                <p>Are you sure you want to activate <strong>@GetUserDisplayName(userToToggle)</strong>?</p>
                                <p>Activated users will be able to log in to the system.</p>
                            }
                        </div>
                    </div>
                </div>
            </ChildContent>
        </RVModal>
    }

    @if (showUserEditModal)
    {
        <UserEditModal UserId="@selectedUserId"
                       Companies="allCompanies"
                       SelectedBranchId="@selectedBranchForUser"
                       OnClose="() => showUserEditModal = false"
                       OnSaved="HandleUserSaved" />
    }

    @if (showUserDetailsModal)
    {
        <UserDetailsModal UserId="@selectedUserId"
                          OnClose="() => showUserDetailsModal = false"
                          OnEdit="() => { showUserDetailsModal = false; ShowUserEditModal(selectedUserId); }" />
    }

    @if (showUserRolesModal)
    {
        <UserRolesModal UserId="@selectedUserId"
                        OnClose="() => showUserRolesModal = false"
                        OnSaved="HandleRolesSaved" />
    }

    @if (showCompanyEditModal)
    {
        <CompanyDialog CompanyModel="@editingCompany"
                       IsEdit="@(selectedCompanyId != 0)"
                       IsView="@viewModeOnly"
                       CanEdit="true"
                       OnSave="HandleCompanySaved"
                       OnCancel="() => showCompanyEditModal = false" />
    }

    @if (showBranchEditModal)
    {
        <BranchDialog BranchModel="@editingBranch"
                      IsEdit="@(selectedBranchId != 0)"
                      IsView="@viewModeOnly"
                      CompanyId="@editingBranchCompanyId"
                      CanEdit="true"
                      CanEditCompany="currentUser?.Role == SystemRole.GlobalAdmin"
                      OnSave="HandleBranchSaved"
                      OnCancel="() => showBranchEditModal = false" />
    }

    @if (showResetPasswordModal && userToResetPassword != null)
    {
        <ResetPasswordModal User="userToResetPassword"
                            OnClose="() => showResetPasswordModal = false"
                            OnPasswordReset="HandlePasswordReset" />
    }
</div>

@code {
    // User and Role Management
    private ApplicationUser? currentUser;
    private Company? currentUserCompany;
    private Branch? currentUserBranch;

    // Data Collections
    private List<ApplicationUser> users = new List<ApplicationUser>();
    private List<Company> allCompanies = new List<Company>();
    private List<Company> availableCompanies = new List<Company>();
    private List<Branch> allBranches = new List<Branch>();
    private List<Branch> filteredBranches = new List<Branch>();
    private bool isLoading = true;

    // Modal States
    private bool showUserEditModal = false;
    private bool showUserDetailsModal = false;
    private bool showUserRolesModal = false;
    private bool showStatusConfirmation = false;
    private bool showCompanyEditModal = false;
    private bool showBranchEditModal = false;
    private bool showResetPasswordModal = false;
    private bool viewModeOnly = false;
    private string selectedUserId = string.Empty;
    private int selectedCompanyId = 0;
    private int selectedBranchId = 0;
    private int selectedBranchForUser = 0; // Used when adding a user to a specific branch
    private int editingBranchCompanyId = 0;
    private ApplicationUser? userToToggle;
    private ApplicationUser? userToResetPassword;
    private Company editingCompany = new Company();
    private Branch editingBranch = new Branch();
    private string activeSubTab = "users";

    // Filtering
    private string searchTerm = string.Empty;
    private int? selectedCompanyIdFilter = null;
    private int? selectedBranchIdFilter = null;
    private string selectedRoleFilter = "all";
    private string selectedStatusFilter = "all";
    private string searchType = "users";

    // UI State
    private HashSet<int> expandedCompanies = new HashSet<int>();
    private HashSet<int> expandedBranches = new HashSet<int>();

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        await LoadUserHierarchy();
    }

    private async Task LoadCurrentUser()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (!string.IsNullOrEmpty(userId))
            {
                var response = await UserService.GetUserById(userId);
                if (response.ResponseInfo.Success)
                {
                    currentUser = (ApplicationUser)response.Response;

                    if (currentUser?.CompanyId.HasValue == true)
                    {
                        var companyResponse = await UserService.GetCompanyById(currentUser.CompanyId.Value);
                        if (companyResponse.ResponseInfo.Success)
                        {
                            currentUserCompany = (Company)companyResponse.Response;
                        }
                    }

                    if (currentUser?.BranchId.HasValue == true)
                    {
                        var branchResponse = await UserService.GetBranchById(currentUser.BranchId.Value);
                        if (branchResponse.ResponseInfo.Success)
                        {
                            currentUserBranch = (Branch)branchResponse.Response;
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load current user: {ex.Message}", "Error");
        }
    }

    private async Task LoadUserHierarchy()
    {
        isLoading = true;

        try
        {
            // Load users based on permissions
            await LoadUsers();

            // Load companies based on permissions
            await LoadCompanies();

            // Load branches based on permissions
            await LoadBranches();

            filteredBranches = allBranches;
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load data: {ex.Message}", "Error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCompanies()
    {
        try
        {
            var response = await UserService.GetAllCompanies();
            if (response.ResponseInfo.Success)
            {
                allCompanies = (List<Company>)response.Response;

                // Filter available companies based on user role
                FilterAvailableCompanies();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading companies: {ex.Message}", "Error");
        }
    }

    private void FilterAvailableCompanies()
    {
        if (currentUser == null)
            return;

        if (currentUser.Role == SystemRole.GlobalAdmin)
        {
            // Global admin can see all companies
            availableCompanies = allCompanies;
        }
        else if (currentUser.Role == SystemRole.CompanyAdmin && currentUser.CompanyId.HasValue)
        {
            // Company admin can only see their company
            availableCompanies = allCompanies
                .Where(c => c.Id == currentUser.CompanyId.Value)
                .ToList();
        }
        else if (currentUser.Role == SystemRole.BranchManager && currentUser.CompanyId.HasValue)
        {
            // Branch manager can only see their company
            availableCompanies = allCompanies
                .Where(c => c.Id == currentUser.CompanyId.Value)
                .ToList();
        }
        else
        {
            // Other roles cannot see any companies
            availableCompanies = new List<Company>();
        }
    }

    private async Task LoadBranches()
    {
        allBranches.Clear();

        try
        {
            if (currentUser?.Role == SystemRole.GlobalAdmin)
            {
                // Global admin can see all branches from all companies
                foreach (var company in allCompanies)
                {
                    var branchesResponse = await UserService.GetBranchesByCompany(company.Id);
                    if (branchesResponse.ResponseInfo.Success)
                    {
                        var companyBranches = (List<Branch>)branchesResponse.Response;
                        foreach (var branch in companyBranches)
                        {
                            branch.Company = company;
                        }
                        allBranches.AddRange(companyBranches);
                    }
                }
            }
            else if (currentUser?.Role == SystemRole.CompanyAdmin && currentUser.CompanyId.HasValue)
            {
                // Company admin can only see branches from their company
                var branchesResponse = await UserService.GetBranchesByCompany(currentUser.CompanyId.Value);
                if (branchesResponse.ResponseInfo.Success)
                {
                    var companyBranches = (List<Branch>)branchesResponse.Response;
                    var company = allCompanies.FirstOrDefault(c => c.Id == currentUser.CompanyId.Value);
                    foreach (var branch in companyBranches)
                    {
                        branch.Company = company;
                    }
                    allBranches.AddRange(companyBranches);
                }
            }
            else if (currentUser?.Role == SystemRole.BranchManager && currentUser.BranchId.HasValue)
            {
                // Branch manager can only see their branch
                var branch = await UserService.GetBranchById(currentUser.BranchId.Value);
                if (branch.ResponseInfo.Success)
                {
                    var branchItem = (Branch)branch.Response;
                    var company = allCompanies.FirstOrDefault(c => c.Id == currentUser?.CompanyId);
                    branchItem.Company = company;
                    allBranches.Add(branchItem);
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading branches: {ex.Message}", "Error");
        }
    }

    private async Task LoadUsers()
    {
        try
        {
            isLoading = true;

            // Get all users but filter based on current user's role
            var response = await UserService.GetAllUsers();
            if (response.ResponseInfo.Success)
            {
                var allUsers = (List<ApplicationUser>)response.Response;

                // Filter users based on current user's permissions
                if (currentUser?.Role == SystemRole.GlobalAdmin)
                {
                    // Global admin can see all users
                    users = allUsers;
                }
                else if (currentUser?.Role == SystemRole.CompanyAdmin && currentUser.CompanyId.HasValue)
                {
                    // Company admin can only see users in their company
                    users = allUsers
                        .Where(u => u.CompanyId.HasValue && u.CompanyId.Value == currentUser.CompanyId.Value)
                        .ToList();
                }
                else if (currentUser?.Role == SystemRole.BranchManager && currentUser.BranchId.HasValue)
                {
                    // Branch manager can only see users in their branch
                    users = allUsers
                        .Where(u => u.BranchId.HasValue && u.BranchId.Value == currentUser.BranchId.Value)
                        .ToList();
                }
                else
                {
                    users = new List<ApplicationUser>();
                }
            }
            else
            {
                ToastService.ShowError(response.ResponseInfo.Message, "Error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load users: {ex.Message}", "Error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private bool CanEditUser(ApplicationUser user)
    {
        if (currentUser == null || user == null)
            return false;

        // Can't edit your own role
        if (user.Id == currentUser.Id)
            return false;

        // Check role hierarchy
        if (currentUser.Role == SystemRole.GlobalAdmin)
        {
            // System Admin can edit anyone
            return true;
        }
        else if (currentUser.Role == SystemRole.CompanyAdmin)
        {
            // Company Admin can't edit System Admins
            if (user.Role == SystemRole.GlobalAdmin)
                return false;

            // Company Admin can only edit users in their company
            return user.CompanyId.HasValue && user.CompanyId.Value == currentUser.CompanyId;
        }
        else if (currentUser.Role == SystemRole.BranchManager)
        {
            // Branch Manager can't edit System Admins or Company Admins
            if (user.Role == SystemRole.GlobalAdmin || user.Role == SystemRole.CompanyAdmin)
                return false;

            // Branch Manager can only edit users in their branch
            return user.BranchId.HasValue && user.BranchId.Value == currentUser.BranchId;
        }

        // Other roles can't edit users
        return false;
    }

    private IEnumerable<Company> filteredCompanies
    {
        get
        {
            if (currentUser?.Role != SystemRole.GlobalAdmin) return new List<Company>();

            var companies = availableCompanies.AsEnumerable();

            // Company filter
            if (selectedCompanyIdFilter.HasValue)
            {
                companies = companies.Where(c => c.Id == selectedCompanyIdFilter);
            }

            // Search filter based on search type
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                if (searchType == "companies")
                {
                    // Search directly in companies
                    companies = companies.Where(c =>
                        c.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) == true);
                }
                else if (searchType == "branches")
                {
                    // Search in branches, then get their parent companies
                    var matchingBranchCompanyIds = allBranches
                        .Where(b => b.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) == true)
                        .Select(b => b.CompanyId)
                        .Distinct()
                        .ToList();

                    companies = companies.Where(c => matchingBranchCompanyIds.Contains(c.Id));
                }
                else // users (default)
                {
                    // Search in users, then get their company IDs
                    var companyIds = users
                        .Where(u =>
                            (u.FirstName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                            (u.LastName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                            (u.UserName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                            (u.Email?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
                        .Select(u => u.CompanyId)
                        .Where(id => id.HasValue)
                        .Select(id => id!.Value)
                        .Distinct()
                        .ToList();

                    companies = companies.Where(c => companyIds.Contains(c.Id));
                }
            }

            // Status filter - hide companies with no matching users
            if (selectedStatusFilter != "all")
            {
                bool isActive = selectedStatusFilter == "active";

                // Get company IDs that have users with the specified status
                var companyIdsWithMatchingUsers = users
                    .Where(u => u.IsActive == isActive)
                    .Select(u => u.CompanyId)
                    .Where(id => id.HasValue)
                    .Select(id => id!.Value)
                    .Distinct()
                    .ToList();

                companies = companies.Where(c => companyIdsWithMatchingUsers.Contains(c.Id));
            }

            return companies;
        }
    }

    private IEnumerable<ApplicationUser> GetCompanyUsers(int companyId)
    {
        var companyUsers = users.Where(u => u.CompanyId == companyId);
        return ApplyUserFilters(companyUsers);
    }

    private IEnumerable<ApplicationUser> GetBranchUsers(int branchId)
    {
        var branchUsers = users.Where(u => u.BranchId == branchId);
        return ApplyUserFilters(branchUsers);
    }

    private IEnumerable<Branch> GetCompanyBranches(int companyId)
    {
        // Filter branches based on user permissions
        IEnumerable<Branch> branches;

        if (currentUser?.Role == SystemRole.GlobalAdmin)
        {
            // Global admin can see all branches
            branches = allBranches.Where(b => b.CompanyId == companyId);
        }
        else if (currentUser?.Role == SystemRole.CompanyAdmin && currentUser.CompanyId == companyId)
        {
            // Company admin can see all branches in their company
            branches = allBranches.Where(b => b.CompanyId == companyId);
        }
        else if (currentUser?.Role == SystemRole.BranchManager &&
                 currentUser.CompanyId == companyId &&
                 currentUser.BranchId.HasValue)
        {
            // Branch manager can only see their branch
            branches = allBranches.Where(b => b.Id == currentUser.BranchId.Value);
        }
        else
        {
            // Other roles can't see branches
            branches = new List<Branch>();
        }

        // Search filter - only apply when search type is "branches"
        if (!string.IsNullOrWhiteSpace(searchTerm) && searchType == "branches")
        {
            branches = branches.Where(b =>
                b.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) == true);
        }

        return branches;
    }

    private IEnumerable<ApplicationUser> ApplyUserFilters(IEnumerable<ApplicationUser> userList)
    {
        // Search filter - only apply when search type is "users"
        if (!string.IsNullOrWhiteSpace(searchTerm) && searchType == "users")
        {
            userList = userList.Where(u =>
                (u.FirstName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.LastName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.UserName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.Email?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        // Role filter
        if (selectedRoleFilter != "all")
        {
            if (Enum.TryParse<SystemRole>(selectedRoleFilter, out var roleEnum))
            {
                userList = userList.Where(u => u.Role == roleEnum);
            }
        }

        // Status filter
        if (selectedStatusFilter != "all")
        {
            bool isActive = selectedStatusFilter == "active";
            userList = userList.Where(u => u.IsActive == isActive);
        }

        return userList;
    }

    private void ToggleCompany(int companyId)
    {
        if (expandedCompanies.Contains(companyId))
            expandedCompanies.Remove(companyId);
        else
            expandedCompanies.Add(companyId);
    }

    private void ToggleBranch(int branchId)
    {
        if (expandedBranches.Contains(branchId))
            expandedBranches.Remove(branchId);
        else
            expandedBranches.Add(branchId);
    }

    private void HandleCompanyChange(int? companyId)
    {
        selectedCompanyIdFilter = companyId;
        selectedBranchIdFilter = null; // Reset branch filter when company changes
    }

    private void HandleRoleFilterChange(string roleFilter)
    {
        selectedRoleFilter = roleFilter;
    }

    private void HandleStatusFilterChange(string statusFilter)
    {
        selectedStatusFilter = statusFilter;
    }

    private void HandleSearch(string search)
    {
        searchTerm = search;
    }

    private void HandleSearchTypeChange(string type)
    {
        searchType = type;
        StateHasChanged();
    }

    private void ClearFilters()
    {
        searchTerm = string.Empty;
        selectedCompanyIdFilter = null;
        selectedBranchIdFilter = null;
        selectedRoleFilter = "all";
        selectedStatusFilter = "all";
        searchType = "users";
        filteredBranches = allBranches;
    }

    // User Management Methods
    private void ShowUserEditModal(string? userId = null)
    {
        // If editing an existing user, check permissions
        if (!string.IsNullOrEmpty(userId))
        {
            var userToEdit = users.FirstOrDefault(u => u.Id == userId);
            if (userToEdit != null && !CanEditUser(userToEdit))
            {
                ToastService.ShowError("You don't have permission to edit this user", "Permission Denied");
                return;
            }
        }
        else
        {
            // For new users, ensure the current user has create user permission
            if (currentUser?.Role == SystemRole.BranchManager)
            {
                // Branch managers can only create users in their branch
                if (!currentUser.BranchId.HasValue)
                {
                    ToastService.ShowError("You must be assigned to a branch to create users", "Permission Denied");
                    return;
                }

                // Auto-select the branch manager's branch
                selectedBranchForUser = currentUser.BranchId.Value;
            }
            else if (currentUser?.Role != SystemRole.GlobalAdmin && currentUser?.Role != SystemRole.CompanyAdmin)
            {
                ToastService.ShowError("You don't have permission to create users", "Permission Denied");
                return;
            }
        }

        selectedUserId = userId ?? string.Empty;
        showUserEditModal = true;
    }

    private void ShowAddUserToBranchModal(int branchId)
    {
        // Check if the user has permission to add users to this branch
        var branch = allBranches.FirstOrDefault(b => b.Id == branchId);
        if (branch == null)
        {
            ToastService.ShowError("Branch not found", "Error");
            return;
        }

        if (currentUser?.Role == SystemRole.CompanyAdmin &&
            currentUser.CompanyId != branch.CompanyId)
        {
            ToastService.ShowError("You can only add users to branches in your company", "Permission Denied");
            return;
        }

        if (currentUser?.Role == SystemRole.BranchManager &&
            currentUser.BranchId != branchId)
        {
            ToastService.ShowError("You can only add users to your branch", "Permission Denied");
            return;
        }

        selectedBranchForUser = branchId;
        selectedUserId = string.Empty; // Create a new user
        showUserEditModal = true;
    }

    private void ShowUserDetailsModal(string userId)
    {
        // Everyone with access to the users page can view details
        selectedUserId = userId;
        showUserDetailsModal = true;
    }

    private void ShowUserRolesModal(string userId)
    {
        var userToEdit = users.FirstOrDefault(u => u.Id == userId);
        if (userToEdit != null && !CanEditUser(userToEdit))
        {
            ToastService.ShowError("You don't have permission to edit roles for this user", "Permission Denied");
            return;
        }

        selectedUserId = userId;
        showUserRolesModal = true;
    }

    private void ShowResetPasswordModal(string userId)
    {
        if (string.IsNullOrEmpty(userId)) return;

        var user = users.FirstOrDefault(u => u.Id == userId);
        if (user == null || !CanEditUser(user))
        {
            ToastService.ShowError("You don't have permission to reset this user's password", "Permission Denied");
            return;
        }

        userToResetPassword = user;
        showResetPasswordModal = true;
    }

    private void ConfirmToggleUserStatus(ApplicationUser user)
    {
        if (!CanEditUser(user))
        {
            ToastService.ShowError("You don't have permission to change the status of this user", "Permission Denied");
            return;
        }

        userToToggle = user;
        showStatusConfirmation = true;
    }

    private async Task ToggleUserStatus()
    {
        if (userToToggle == null) return;

        try
        {
            // Double-check permissions before processing
            if (!CanEditUser(userToToggle))
            {
                ToastService.ShowError("You don't have permission to change the status of this user", "Permission Denied");
                showStatusConfirmation = false;
                userToToggle = null;
                return;
            }

            userToToggle.IsActive = !userToToggle.IsActive;
            userToToggle.UpdatedBy = currentUser?.Id;
            userToToggle.UpdatedDate = DateTime.Now;

            var response = await UserService.UpdateUser(userToToggle.Id, userToToggle);

            if (response.ResponseInfo.Success)
            {
                string message = userToToggle.IsActive
                    ? $"User '{GetUserDisplayName(userToToggle)}' has been activated"
                    : $"User '{GetUserDisplayName(userToToggle)}' has been deactivated";

                ToastService.ShowSuccess(message, "Success");
                await LoadUsers();
            }
            else
            {
                ToastService.ShowError(response.ResponseInfo.Message, "Error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to update user status: {ex.Message}", "Error");
        }

        showStatusConfirmation = false;
        userToToggle = null;
    }

    private async Task HandleUserSaved()
    {
        showUserEditModal = false;
        selectedBranchForUser = 0; // Reset selected branch after saving
        await LoadUserHierarchy();
    }

    private async Task HandleRolesSaved()
    {
        showUserRolesModal = false;
        await LoadUserHierarchy();
    }

    private void HandlePasswordReset()
    {
        showResetPasswordModal = false;
        userToResetPassword = null;
    }

    // Event handlers for UserCard
    private void HandleUserEdit(string userId)
    {
        var user = users.FirstOrDefault(u => u.Id == userId);
        if (user != null && CanEditUser(user))
        {
            ShowUserEditModal(userId);
        }
    }

    private void HandleUserRoles(string userId)
    {
        var user = users.FirstOrDefault(u => u.Id == userId);
        if (user != null && CanEditUser(user))
        {
            ShowUserRolesModal(userId);
        }
    }

    private void HandleUserResetPassword(string userId)
    {
        var user = users.FirstOrDefault(u => u.Id == userId);
        if (user != null && CanEditUser(user))
        {
            ShowResetPasswordModal(userId);
        }
    }

    private void HandleUserStatusToggle(ApplicationUser user)
    {
        if (CanEditUser(user))
        {
            ConfirmToggleUserStatus(user);
        }
    }

    // Company Management Methods
    private void ShowCompanyEditModal(int companyId = 0, bool viewOnly = false)
    {
        // Only Global Admin can create/edit companies
        if (currentUser?.Role != SystemRole.GlobalAdmin)
        {
            ToastService.ShowError("Only System Administrators can manage companies", "Permission Denied");
            return;
        }

        selectedCompanyId = companyId;
        viewModeOnly = viewOnly;

        if (companyId != 0)
        {
            var company = allCompanies.FirstOrDefault(c => c.Id == companyId);
            if (company != null)
            {
                editingCompany = company;
                showCompanyEditModal = true;
            }
            else
            {
                ToastService.ShowError("Company not found", "Error");
            }
        }
        else
        {
            editingCompany = new Company
                {
                    IsActive = true,
                    Address = new Address { Country = "South Africa" },
                    EmailAddresses = new List<Email>(),
                    ContactNumbers = new List<ContactNumber>(),
                    CreatedOn = DateTime.Now
                };
            showCompanyEditModal = true;
        }
    }

    private async Task HandleCompanySaved(Company company)
    {
        // Double-check permissions
        if (currentUser?.Role != SystemRole.GlobalAdmin)
        {
            ToastService.ShowError("Only System Administrators can manage companies", "Permission Denied");
            return;
        }

        try
        {
            if (company.Id == 0)
            {
                // Create new company
                var response = await UserService.CreateCompany(company);
                if (response.ResponseInfo.Success)
                {
                    ToastService.ShowSuccess($"Company '{company.Name}' created successfully", "Success");
                    await LoadUserHierarchy();
                }
                else
                {
                    ToastService.ShowError(response.ResponseInfo.Message, "Error");
                }
            }
            else
            {
                // Update existing company
                var response = await UserService.UpdateCompany(company.Id, company);
                if (response.ResponseInfo.Success)
                {
                    ToastService.ShowSuccess($"Company '{company.Name}' updated successfully", "Success");
                    await LoadUserHierarchy();
                }
                else
                {
                    ToastService.ShowError(response.ResponseInfo.Message, "Error");
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to save company: {ex.Message}", "Error");
        }

        showCompanyEditModal = false;
    }

    // Branch Management Methods
    private void ShowBranchEditModal(int branchId = 0, bool viewOnly = false)
    {
        // Check permissions based on role
        if (currentUser?.Role != SystemRole.GlobalAdmin &&
            (currentUser?.Role != SystemRole.CompanyAdmin || !currentUser.CompanyId.HasValue))
        {
            ToastService.ShowError("You don't have permission to manage branches", "Permission Denied");
            return;
        }

        selectedBranchId = branchId;
        viewModeOnly = viewOnly;

        if (branchId != 0)
        {
            var branch = allBranches.FirstOrDefault(b => b.Id == branchId);
            if (branch != null)
            {
                // Check if this branch belongs to the company admin's company
                if (currentUser?.Role == SystemRole.CompanyAdmin &&
                    branch.CompanyId != currentUser.CompanyId)
                {
                    ToastService.ShowError("You can only edit branches in your company", "Permission Denied");
                    return;
                }

                editingBranch = branch;
                editingBranchCompanyId = branch.CompanyId;
                showBranchEditModal = true;
            }
            else
            {
                ToastService.ShowError("Branch not found", "Error");
            }
        }
        else
        {
            editingBranch = new Branch
                {
                    CompanyId = currentUser?.Role == SystemRole.CompanyAdmin && currentUser.CompanyId.HasValue
                        ? currentUser.CompanyId.Value
                        : 0,
                    IsActive = true,
                    Address = new Address { Country = "South Africa" },
                    EmailAddresses = new List<Email>(),
                    ContactNumbers = new List<ContactNumber>(),
                    Logos = new List<BranchLogo>(),
                    CreatedOn = DateTime.Now
                };

            editingBranchCompanyId = editingBranch.CompanyId;
            showBranchEditModal = true;
        }
    }

    private void ShowCreateBranchModal(int companyId)
    {
        // Verify the company ID is valid for the current user's permissions
        if (currentUser?.Role == SystemRole.CompanyAdmin &&
            currentUser.CompanyId.HasValue &&
            currentUser.CompanyId.Value != companyId)
        {
            ToastService.ShowError("You can only create branches in your company", "Permission Denied");
            return;
        }

        selectedBranchId = 0;
        viewModeOnly = false;
        editingBranch = new Branch
            {
                CompanyId = companyId,
                IsActive = true,
                Address = new Address { Country = "South Africa" },
                EmailAddresses = new List<Email>(),
                ContactNumbers = new List<ContactNumber>(),
                Logos = new List<BranchLogo>(),
                CreatedOn = DateTime.Now
            };
        editingBranchCompanyId = companyId;
        showBranchEditModal = true;
    }

    private async Task HandleBranchSaved(Branch branch)
    {
        // Double-check permissions
        if (currentUser?.Role != SystemRole.GlobalAdmin &&
            (currentUser?.Role != SystemRole.CompanyAdmin || currentUser.CompanyId != branch.CompanyId))
        {
            ToastService.ShowError("You don't have permission to manage this branch", "Permission Denied");
            return;
        }

        try
        {
            if (branch.Id == 0)
            {
                // Create new branch
                var response = await UserService.CreateBranch(branch);
                if (response.ResponseInfo.Success)
                {
                    ToastService.ShowSuccess($"Branch '{branch.Name}' created successfully", "Success");
                    await LoadUserHierarchy();
                }
                else
                {
                    ToastService.ShowError(response.ResponseInfo.Message, "Error");
                }
            }
            else
            {
                // Update existing branch
                var response = await UserService.UpdateBranch(branch.Id, branch);
                if (response.ResponseInfo.Success)
                {
                    ToastService.ShowSuccess($"Branch '{branch.Name}' updated successfully", "Success");
                    await LoadUserHierarchy();
                }
                else
                {
                    ToastService.ShowError(response.ResponseInfo.Message, "Error");
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to save branch: {ex.Message}", "Error");
        }

        showBranchEditModal = false;
    }

    private void ViewBranchUsers(int branchId)
    {
        selectedBranchIdFilter = branchId;
        activeSubTab = "users";
        ToggleBranch(branchId);
    }

    private string GetUserDisplayName(ApplicationUser user)
    {
        if (!string.IsNullOrEmpty(user.FullName))
        {
            return user.FullName;
        }

        return user.UserName ?? "Unknown User";
    }
} *@